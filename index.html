<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التقارير الإشرافية المدمج | النسخة الاحترافية (شاملة الإدارة المدرسية ومولد الرأي الذكي)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                        serif: ['Noto Naskh Arabic', 'serif'],
                    },
                    colors: {
                        primary: '#1e40af',   // blue-800
                        secondary: '#15803d', // green-700
                        accent: '#b45309',    // amber-700
                        danger: '#b91c1c',    // red-700
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .mic-btn.recording { animation: pulse-red 1.5s infinite; background-color: #fee2e2; color: #dc2626; border-color: #dc2626; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* Rating Buttons Style */
        .rating-btn.active { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .rating-btn.active.score-1 { background-color: #166534; color: white; border-color: #166534; }
        .rating-btn.active.score-2 { background-color: #1e40af; color: white; border-color: #1e40af; }
        .rating-btn.active.score-3 { background-color: #ca8a04; color: white; border-color: #ca8a04; }
        .rating-btn.active.score-4 { background-color: #9f1239; color: white; border-color: #9f1239; }
        .rating-btn.active.score-5 { background-color: #991b1b; color: white; border-color: #991b1b; }

        /* Print Styles */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; font-family: 'Times New Roman', serif; color: black; }
            .no-print, .main-container, .modal-overlay, #welcomeView, .controls, .nav-tabs, #backToWelcomeFromSupervisory, .edit-evidence-btn, .evidence-panel, #manageTypesModal, #addEditTypeModal, #schoolVisitsApp header button { display: none !important; }
            .print-view { display: block !important; position: static !important; width: 100% !important; }
            
            table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 12px; }
            th, td { border: 1px solid #000; padding: 4px 6px; text-align: center; }
            th { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; font-weight: bold; }
            .print-header-text { text-align: center; margin-bottom: 15px; }
            .print-logo-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
            .print-logo-header img { height: 60px; filter: grayscale(100%); }
            
            #schoolVisitsApp #reportPreviewContainer { display: block !important; visibility: visible !important; position: static; box-shadow: none; width: 100%; }
            #schoolVisitsApp #reportPreviewContainer * { visibility: visible; }
            #schoolVisitsApp #schoolFormView, #schoolVisitsApp #schoolDashboardView { display: none !important; }
            #schoolVisitsApp .no-print { display: none !important; }
        }

        /* Utility */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(229, 231, 235, 0.5); }
        .edit-evidence-btn { font-size: 0.75rem; color: #4b5563; background-color: #f3f4f6; border: 1px solid #e5e7eb; padding: 4px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        .edit-evidence-btn:hover { background-color: #e5e7eb; color: #1e40af; border-color: #cbd5e1; }
        
        /* Evidence Panel Styles */
        .evidence-panel {
            animation: slideDown 0.2s ease-out forwards;
            transform-origin: top center;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: scaleY(0.9); }
            to { opacity: 1; transform: scaleY(1); }
        }
        .evidence-checkbox:checked + label { color: #166534; font-weight: bold; }
        
        /* Custom Delete Button in List */
        .delete-evidence-btn {
            visibility: hidden;
        }
        .evidence-item:hover .delete-evidence-btn {
            visibility: visible;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased min-h-screen selection:bg-blue-100 selection:text-blue-900">

    <div id="toast-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[9999] transition-all duration-300 opacity-0 pointer-events-none">
        <div id="toast-message" class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 font-medium">
            <span id="toast-icon"></span>
            <span id="toast-text"></span>
        </div>
    </div>

    <!-- PAGE 1: Welcome View -->
    <div id="welcomeView" class="fade-in min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-blue-100 to-transparent -z-10"></div>
        <div class="absolute -top-20 -right-20 w-64 h-64 bg-blue-200 rounded-full blur-3xl opacity-30 -z-10"></div>
        <div class="absolute bottom-0 -left-20 w-80 h-80 bg-green-100 rounded-full blur-3xl opacity-30 -z-10"></div>

        <div class="text-center mb-12 max-w-2xl">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight leading-tight">نظام التقارير الإشرافية المدمج</h1>
            <p class="text-lg text-slate-600">منصة موحدة لإدارة الزيارات الإشرافية والمدرسية بكفاءة (نسخة محلية)</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl px-4">
            <div id="showSupervisoryAppBtn" class="group bg-white rounded-3xl p-8 shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-100 cursor-pointer relative overflow-hidden">
                <div class="absolute top-0 right-0 w-2 h-full bg-blue-600 transition-all duration-300 group-hover:w-full group-hover:opacity-5"></div>
                <div class="relative z-10 flex flex-col h-full">
                    <div class="w-14 h-14 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 mb-6 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-chalkboard-user text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-3 group-hover:text-blue-700 transition-colors">الزيارات الإشرافية</h2>
                    <p class="text-slate-500 leading-relaxed mb-6 flex-grow">تقييم أداء المعلمين في الرياضة المدرسية مع أدوات تحليلية ومولد أوصاف تفاعلي.</p>
                    <span class="inline-flex items-center text-blue-600 font-semibold group-hover:translate-x-[-5px] transition-transform">
                        دخول النظام <i class="fa-solid fa-arrow-left mr-2"></i>
                    </span>
                </div>
            </div>

            <div id="showSchoolAppBtn" class="group bg-white rounded-3xl p-8 shadow-sm hover:shadow-xl transition-all duration-300 border border-slate-100 cursor-pointer relative overflow-hidden">
                <div class="absolute top-0 right-0 w-2 h-full bg-green-600 transition-all duration-300 group-hover:w-full group-hover:opacity-5"></div>
                <div class="relative z-10 flex flex-col h-full">
                    <div class="w-14 h-14 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 mb-6 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-school text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-3 group-hover:text-green-700 transition-colors">الزيارات المدرسية</h2>
                    <p class="text-slate-500 leading-relaxed mb-6 flex-grow">توثيق الزيارات المدرسية وتحديد الأهداف والملاحظات (تخزين محلي).</p>
                    <span class="inline-flex items-center text-green-600 font-semibold group-hover:translate-x-[-5px] transition-transform">
                        دخول النظام <i class="fa-solid fa-arrow-left mr-2"></i>
                    </span>
                </div>
            </div>
        </div>
        
        <footer class="mt-16 text-center text-slate-400 text-sm font-medium">
            <p class="mb-2">جميع الحقوق محفوظة © وزارة التربية والتعليم</p>
            <p class="text-slate-500 font-bold">حقوق الإعداد والتصميم: اسعد الخصيبي – مشرف الرياضة المدرسية – محافظة مسقط</p>
        </footer>
    </div>

    <!-- PAGE 2: Supervisory App -->
    <div id="supervisoryVisitsApp" class="hidden min-h-screen bg-slate-50 pb-12">
        <!-- Content of Supervisory App -->
        <div class="main-container max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
            
            <header class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 mb-8 sticky top-4 z-40">
                <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                    <div class="flex bg-slate-100 p-1 rounded-xl w-full lg:w-auto overflow-x-auto">
                        <button class="nav-tab active flex-1 lg:flex-none py-2 px-6 rounded-lg text-sm font-bold transition-all duration-200" data-view="form-view">
                            <i class="fa-solid fa-file-pen ml-2"></i>نموذج التقييم
                        </button>
                        <button class="nav-tab flex-1 lg:flex-none py-2 px-6 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 transition-all duration-200" data-view="dashboard-view">
                            <i class="fa-solid fa-chart-pie ml-2"></i>التحليل البياني
                        </button>
                        <button class="nav-tab flex-1 lg:flex-none py-2 px-6 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-700 transition-all duration-200" data-view="saved-reports-view">
                            <i class="fa-solid fa-box-archive ml-2"></i>الأرشيف
                        </button>
                    </div>
                    <button id="backToWelcomeFromSupervisory" class="text-slate-500 hover:text-red-600 hover:bg-red-50 font-medium rounded-lg text-sm px-4 py-2 transition-colors flex items-center">
                        <i class="fa-solid fa-power-off ml-2"></i> خروج
                    </button>
                </div>
            </header>

            <div id="form-view" class="fade-in space-y-6">
                <!-- Evaluation Form Content -->
                <div class="bg-gradient-to-r from-blue-700 to-blue-900 rounded-2xl p-8 text-white shadow-lg text-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl -mr-16 -mt-16"></div>
                    <h1 class="text-2xl md:text-3xl font-bold mb-2 relative z-10">استمارة زيارة إشرافية إلكترونية</h1>
                    <p class="text-blue-100 relative z-10">نظام التقييم المطور لمادة الرياضة المدرسية</p>
                </div>

                <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <div class="lg:col-span-4 space-y-6">
                        <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                            <h2 class="text-lg font-bold text-slate-800 border-r-4 border-blue-500 pr-3 mb-6">بيانات الزيارة</h2>
                            <div class="space-y-4">
                                <div class="input-wrapper">
                                    <label class="block text-sm font-medium text-slate-600 mb-1">المدرسة</label>
                                    <input id="school" type="text" placeholder="اكتب اسم المدرسة" required class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition-colors">
                                </div>
                                <div class="input-wrapper">
                                    <label class="block text-sm font-medium text-slate-600 mb-1">المعلم</label>
                                    <input id="teacherName" type="text" placeholder="اكتب اسم المعلم رباعياً" required class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 transition-colors">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">رقم الملف</label>
                                        <input id="fileNumber" type="text" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">المادة</label>
                                        <input id="subject" type="text" value="الرياضة المدرسية" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-blue-500">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">التاريخ</label>
                                        <input id="visitDate" type="date" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">رقم الزيارة</label>
                                        <input id="visitNumber" type="text" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-blue-500">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">الصف</label>
                                        <input id="class" type="text" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">الحصة</label>
                                        <input id="lesson" type="text" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-blue-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">الموضوع</label>
                                    <input id="topic" type="text" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-blue-500">
                                </div>
                            </div>
                        </section>
                    </div>

                    <div class="lg:col-span-8 space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <details class="group">
                                <summary class="flex items-center cursor-pointer list-none text-blue-800 font-bold">
                                    <span class="transition group-open:rotate-180 ml-2"><i class="fa-solid fa-chevron-down"></i></span>
                                    دليل معايير التقييم
                                </summary>
                                <div class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-2 text-xs text-center">
                                    <span class="bg-green-100 text-green-800 py-1 px-2 rounded border border-green-200">1 - متميز</span>
                                    <span class="bg-blue-100 text-blue-800 py-1 px-2 rounded border border-blue-200">2 - جيد</span>
                                    <span class="bg-yellow-100 text-yellow-800 py-1 px-2 rounded border border-yellow-200">3 - ملائم</span>
                                    <span class="bg-red-50 text-red-800 py-1 px-2 rounded border border-red-200">4 - غير ملائم</span>
                                    <span class="bg-red-100 text-red-900 py-1 px-2 rounded border border-red-300">5 - تدخل سريع</span>
                                </div>
                            </details>
                        </div>

                        <form id="evaluationForm" class="space-y-6">
                            <!-- Items inserted by JS -->
                        </form>

                        <section id="reportSection" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-primary">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center">
                                <i class="fa-solid fa-file-contract ml-3 text-blue-600"></i> التقرير النهائي
                            </h2>
                            <div class="space-y-6">
                                <div class="report-box">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-bold text-slate-700">جوانب الإجادة</h3>
                                        <button type="button" class="copy-btn text-xs bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-700 px-3 py-1 rounded transition-colors" data-target="strengthsContent">
                                            <i class="fa-regular fa-copy"></i> نسخ
                                        </button>
                                    </div>
                                    <textarea id="strengthsContent" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3 text-sm min-h-[100px] focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div class="report-box">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-bold text-slate-700">الجوانب التي تحتاج إلى تطوير</h3>
                                        <button type="button" class="copy-btn text-xs bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-700 px-3 py-1 rounded transition-colors" data-target="developmentContent">
                                            <i class="fa-regular fa-copy"></i> نسخ
                                        </button>
                                    </div>
                                    <textarea id="developmentContent" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3 text-sm min-h-[100px] focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div class="report-box">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="font-bold text-slate-700">التوصيات</h3>
                                        <button type="button" class="copy-btn text-xs bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-700 px-3 py-1 rounded transition-colors" data-target="recommendationsContent">
                                            <i class="fa-regular fa-copy"></i> نسخ
                                        </button>
                                    </div>
                                    <textarea id="recommendationsContent" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3 text-sm min-h-[100px] focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                            </div>
                        </section>

                        <section class="bg-slate-100 rounded-xl p-6 border border-slate-200">
                            <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">توقيع الزائر</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="visitorName" type="text" placeholder="اسم الزائر" class="w-full bg-white border border-slate-300 rounded-lg p-2.5 text-sm">
                                <input id="visitorPosition" type="text" placeholder="الوظيفة" class="w-full bg-white border border-slate-300 rounded-lg p-2.5 text-sm">
                            </div>
                        </section>
                        
                        <p id="status-message" class="text-center font-medium opacity-0 transition-opacity duration-500 min-h-[20px]"></p>

                        <section class="sticky bottom-4 z-30 bg-white/90 backdrop-blur border border-slate-200 shadow-xl rounded-2xl p-4 flex flex-wrap justify-center gap-3">
                            <button type="button" id="generateReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-sm transition-transform hover:-translate-y-1">
                                <i class="fa-solid fa-wand-magic-sparkles ml-2"></i>توليد التقرير
                            </button>
                            <button type="button" id="savePermanentReportBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-sm transition-transform hover:-translate-y-1">
                                <i class="fa-solid fa-save ml-2"></i>حفظ بالأرشيف
                            </button>
                            <button id="printOfficialReportBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-sm transition-transform hover:-translate-y-1">
                                <i class="fa-solid fa-print ml-2"></i>طباعة
                            </button>
                            <button type="button" id="exportToWordBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-sm transition-transform hover:-translate-y-1">
                                <i class="fa-solid fa-file-word ml-2"></i>Word
                            </button>
                            <button type="button" id="showResetConfirmationBtn" class="bg-slate-200 hover:bg-red-100 text-slate-700 hover:text-red-600 font-bold py-2.5 px-6 rounded-lg shadow-sm transition-colors">
                                <i class="fa-solid fa-rotate-right ml-2"></i>إعادة تعيين
                            </button>
                        </section>
                    </div>
                </main>
            </div>

            <!-- Dashboard and Saved Reports Views (Hidden by default) -->
            <div id="dashboard-view" class="hidden fade-in space-y-6">
                <!-- Dashboard content... -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">لوحة المتابعة والتحليل</h2>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">اختر المعلم</label>
                            <select id="teacher-dashboard-select" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">نوع التحليل</label>
                            <select id="chartTypeSelect" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5">
                                <option value="radar">تحليل زيارة واحدة (راداري)</option>
                                <option value="line">تطور الأداء عبر الزيارات (خطي)</option>
                                <option value="bar">متوسط الأداء العام (شريطي)</option>
                            </select>
                        </div>
                        <div id="visitDateGroup" class="hidden">
                            <label class="block text-sm font-medium text-slate-600 mb-1">تاريخ الزيارة</label>
                            <select id="visitDateSelect" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5"></select>
                        </div>
                    </div>
                    <button id="updateDashboardViewBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-sm mb-6 transition-colors">
                        عرض التحليل البياني
                    </button>
                    <div id="chart-container" class="relative h-[500px] w-full border rounded-xl p-4 bg-slate-50">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div id="no-data-message" class="hidden text-center py-20 bg-slate-50 rounded-xl border border-dashed border-slate-300 mt-4">
                        <i class="fa-solid fa-chart-simple text-4xl text-slate-300 mb-3"></i>
                        <p class="text-slate-500">لا توجد بيانات محفوظة لهذا المعلم حتى الآن.</p>
                    </div>
                </div>
            </div>

            <div id="saved-reports-view" class="hidden fade-in space-y-6">
                 <!-- Saved reports content... -->
                 <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex-grow w-full md:w-auto">
                        <label class="block text-sm font-medium text-slate-600 mb-1">بحث في الأرشيف</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                                <i class="fa-solid fa-search"></i>
                            </div>
                            <input type="text" id="filter-reports-input" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block pr-10 p-2.5" placeholder="ابحث باسم المعلم أو المدرسة...">
                        </div>
                    </div>
                </div>
                <div id="saved-reports-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <div id="no-saved-reports-message" class="hidden text-center py-20 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                    <i class="fa-solid fa-folder-open text-4xl text-slate-300 mb-3"></i>
                    <p class="text-slate-500">الأرشيف فارغ حالياً.</p>
                </div>
            </div>
        </div>

        <!-- Print View for Supervisory -->
        <div class="print-view hidden" id="printView">
            <div class="print-container">
                 <div class="print-logo-header">
                    <img src="https://i.ibb.co/567f2Pb/oman-vision-2040-logo.png" alt="رؤية عمان" onerror="this.style.display='none'">
                    <img src="https://i.ibb.co/VMy4bJg/Oman-Ministry-of-Education-Logo-svg.png" alt="وزارة التربية" onerror="this.style.display='none'">
                    <img src="https://i.ibb.co/hK0yMGH/quality-logo.png" alt="الجودة" onerror="this.style.display='none'">
                </div>
                <div class="print-header-text">نموذج رقم (5) استمارة زيارة إشرافية لمعلم مادة - مجال</div>
                <h2 class="text-center font-bold text-xl mb-4 underline">استمارة زيارة إشرافية لمعلم مادة/مجال</h2>
                
                <table class="print-info-table mb-4">
                    <tbody>
                        <tr><td class="bg-gray-100 font-bold w-[15%]">اسم المعلم:</td><td class="value" id="print-teacherName"></td><td class="bg-gray-100 font-bold w-[15%]">المدرسة:</td><td class="value" id="print-school"></td></tr>
                        <tr><td class="bg-gray-100 font-bold">المادة/المجال:</td><td class="value" id="print-subject"></td><td class="bg-gray-100 font-bold">رقم الملف:</td><td class="value" id="print-fileNumber"></td></tr>
                        <tr><td class="bg-gray-100 font-bold">التاريخ:</td><td class="value" id="print-visitDate"></td><td class="bg-gray-100 font-bold">رقم الزيارة:</td><td class="value" id="print-visitNumber"></td></tr>
                        <tr><td class="bg-gray-100 font-bold">الحصة:</td><td class="value" id="print-lesson"></td><td class="bg-gray-100 font-bold">الصف:</td><td class="value" id="print-class"></td></tr>
                        <tr><td class="bg-gray-100 font-bold">الموضوع:</td><td colspan="3" class="value" id="print-topic"></td></tr>
                    </tbody>
                </table>
                
                <table class="print-main-table mb-4">
                    <thead>
                        <tr>
                            <th style="width: 20%;">المجال</th>
                            <th style="width: 15%;">المعيار</th>
                            <th style="width: 5%;">م</th>
                            <th>البند</th>
                            <th style="width: 10%;">التقدير</th>
                        </tr>
                    </thead>
                    <tbody id="print-main-tbody"></tbody>
                </table>
    
                <div class="report-section-print border-2 border-black p-2 mb-2 break-inside-avoid">
                    <h3 class="bg-gray-100 font-bold p-1 text-center border-b border-black mb-2">جوانب الإجادة في الأداء وأدلتها:</h3>
                    <div id="print-strengthsContent" class="text-right whitespace-pre-wrap min-h-[60px]"></div>
                </div>
                <div class="report-section-print border-2 border-black p-2 mb-2 break-inside-avoid">
                    <h3 class="bg-gray-100 font-bold p-1 text-center border-b border-black mb-2">الجوانب التي تحتاج إلى تطوير في الأداء وأدلتها:</h3>
                    <div id="print-developmentContent" class="text-right whitespace-pre-wrap min-h-[60px]"></div>
                </div>
                <div class="report-section-print border-2 border-black p-2 mb-2 break-inside-avoid">
                    <h3 class="bg-gray-100 font-bold p-1 text-center border-b border-black mb-2">التوصيات:</h3>
                    <div id="print-recommendationsContent" class="text-right whitespace-pre-wrap min-h-[60px]"></div>
                </div>
    
                <div class="signature-section mt-8 break-inside-avoid flex justify-between px-10">
                    <div>اسم الزائر: <span id="print-visitorName" class="font-bold underline"></span></div>
                    <div>الوظيفة: <span id="print-visitorPosition" class="font-bold underline"></span></div>
                </div>
                <div class="text-center text-xs mt-4 pt-2 border-t border-black">
                    ● معيار التقييم: 1- متميز، 2- جيد، 3- ملائم، 4- غير ملائم، 5- يحتاج إلى تدخل سريع
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 3: School Visits App -->
    <div id="schoolVisitsApp" class="hidden min-h-screen bg-slate-50">
        <!-- School Dashboard View -->
        <div id="schoolDashboardView" class="container mx-auto max-w-6xl p-6 fade-in">
             <header class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 flex items-center">
                        <span class="bg-green-100 text-green-600 p-2 rounded-lg ml-3"><i class="fa-solid fa-school"></i></span>
                        سجل التقارير المدرسية
                    </h1>
                    <p class="text-slate-500 mt-1 text-sm mr-12">الوضع المحلي (Offline)</p>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <button id="backToWelcomeFromSchool" class="text-slate-600 bg-slate-100 hover:bg-slate-200 font-medium rounded-lg text-sm px-4 py-2.5 transition-colors">
                        <i class="fa-solid fa-home ml-2"></i>الرئيسية
                    </button>
                    <button id="addNewReportBtn" class="text-white bg-green-600 hover:bg-green-700 font-bold rounded-lg text-sm px-6 py-2.5 transition-colors shadow-sm">
                        <i class="fa-solid fa-plus ml-2"></i> تقرير جديد
                    </button>
                </div>
            </header>
            <div id="reportsListContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 min-h-[300px] grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Reports will be injected here -->
            </div>
        </div>

        <!-- School Form View -->
        <div id="schoolFormView" class="container mx-auto max-w-5xl p-6 fade-in hidden">
            <header class="text-center mb-8">
                <h1 id="formTitle" class="text-3xl font-bold text-slate-800">إنشاء تقرير زيارة</h1>
                <p class="text-slate-500 mt-2">توثيق ومتابعة الزيارات الميدانية</p>
            </header>
            <form id="reportForm" class="space-y-6">
                 <input type="hidden" id="reportId" value="">
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 text-blue-600 rounded-lg p-2 ml-3"><i class="fa-solid fa-circle-info"></i></div>
                        <h3 class="text-lg font-bold text-slate-700">بيانات أساسية</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block mb-2 text-sm font-medium text-slate-700">المدرسة</label>
                            <input type="text" id="schoolName" name="schoolName" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="اكتب اسم المدرسة" required>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-slate-700">تاريخ الزيارة</label>
                            <input type="date" id="schoolVisitDate" name="visitDate" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                    </div>
                 </div>
                 
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="bg-amber-100 text-amber-600 rounded-lg p-2 ml-3"><i class="fa-solid fa-bullseye"></i></div>
                            <h3 class="text-lg font-bold text-slate-700">نوع وأهداف الزيارة</h3>
                        </div>
                        <button type="button" id="manageVisitTypesBtn" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-lg transition-colors">
                            <i class="fa-solid fa-cog"></i> إدارة الأنواع
                        </button>
                    </div>
                    <select id="visitTypeSelect" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 mb-4"></select>
                    <div class="flex justify-between items-center mb-2">
                         <span class="text-sm font-medium text-slate-500">الأهداف المحددة:</span>
                         <button type="button" id="copyObjectivesBtn" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 hover:text-blue-700 px-3 py-1 rounded transition-colors flex items-center gap-1">
                            <i class="fa-regular fa-copy"></i> نسخ الأهداف
                         </button>
                    </div>
                    <div id="objectivesContainer" class="space-y-2 max-h-60 overflow-y-auto p-2 border rounded-lg bg-slate-50"></div>
                </div>

                 <!-- New Section: Classroom Visits for Better Data Entry -->
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="bg-indigo-100 text-indigo-600 rounded-lg p-2 ml-3"><i class="fa-solid fa-chalkboard-user"></i></div>
                            <h3 class="text-lg font-bold text-slate-700">متابعة المواقف الصفية</h3>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
                        <input type="text" id="cvTeacher" placeholder="اسم المعلم" class="bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm">
                        <input type="text" id="cvGrade" placeholder="الصف" class="bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm">
                        <input type="text" id="cvPeriod" placeholder="الحصة" class="bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm">
                        <input type="text" id="cvSubject" placeholder="المهارة/الدرس" class="bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm">
                        <select id="cvRating" class="bg-slate-50 border border-slate-300 rounded-lg p-2.5 text-sm">
                            <option value="ممتاز">ممتاز</option>
                            <option value="جيد جداً">جيد جداً</option>
                            <option value="جيد">جيد</option>
                            <option value="متوسط">متوسط</option>
                            <option value="ضعيف">ضعيف</option>
                        </select>
                    </div>
                    <button type="button" id="addClassroomVisitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg mb-4 text-sm">
                        <i class="fa-solid fa-plus ml-1"></i> إضافة موقف صفي
                    </button>
                    <div id="classroomVisitsList" class="space-y-2"></div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                         <div class="flex items-center">
                            <div class="bg-purple-100 text-purple-600 rounded-lg p-2 ml-3"><i class="fa-solid fa-pen-to-square"></i></div>
                            <h3 class="text-lg font-bold text-slate-700">رأي الزائر</h3>
                        </div>
                        <div class="flex gap-2">
                             <button type="button" id="copyVisitorOpinionBtn" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 hover:text-blue-700 px-3 py-1.5 rounded-lg transition-colors shadow-sm font-bold flex items-center gap-1">
                                <i class="fa-regular fa-copy"></i> نسخ
                            </button>
                            <button type="button" id="generateVisitorOpinionBtn" class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-lg transition-colors shadow-sm font-bold flex items-center gap-1">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> توليد الرأي الذكي
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="visitorOpinion" rows="6" class="block p-3 w-full text-sm text-slate-900 bg-slate-50 rounded-lg border border-slate-300 focus:ring-blue-500 focus:border-blue-500" placeholder="اضغط على زر التوليد لإنشاء الرأي تلقائياً بناءً على الأهداف والمواقف الصفية..."></textarea>
                        <button type="button" class="mic-btn absolute bottom-3 left-3 text-slate-400 hover:text-blue-600 transition-colors p-1 rounded-full"><i class="fa-solid fa-microphone"></i></button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                         <div class="flex items-center">
                            <div class="bg-emerald-100 text-emerald-600 rounded-lg p-2 ml-3"><i class="fa-solid fa-check-double"></i></div>
                            <h3 class="text-lg font-bold text-slate-700">التوصيات والملاحظات العامة</h3>
                        </div>
                         <div class="w-1/2 md:w-1/3 flex gap-2">
                            <button type="button" id="copyRecommendationsBtn" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 hover:text-blue-700 px-3 py-1.5 rounded-lg transition-colors shadow-sm font-bold flex items-center gap-1">
                                <i class="fa-regular fa-copy"></i> نسخ
                            </button>
                            <select id="quickRecs" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-xs rounded-lg p-2">
                                <option value="">-- توصيات سريعة --</option>
                                <option value="ضرورة الالتزام بموعد الحصة.">الالتزام بالوقت</option>
                                <option value="تفعيل سجلات المتابعة بانتظام.">تفعيل السجلات</option>
                                <option value="التنويع في أساليب التدريس.">تنويع التدريس</option>
                                <option value="مراعاة الفروق الفردية بين الطلبة.">الفروق الفردية</option>
                                <option value="الاهتمام بنظافة وسلامة الأدوات.">الأمن والسلامة</option>
                            </select>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="recommendations" rows="4" class="block p-3 w-full text-sm text-slate-900 bg-slate-50 rounded-lg border border-slate-300 focus:ring-blue-500 focus:border-blue-500" placeholder="اكتب التوصيات والملاحظات العامة..."></textarea>
                        <button type="button" class="mic-btn absolute bottom-3 left-3 text-slate-400 hover:text-blue-600 transition-colors p-1 rounded-full"><i class="fa-solid fa-microphone"></i></button>
                    </div>
                </div>

                <div class="sticky bottom-4 z-30 bg-white/90 backdrop-blur p-4 rounded-xl border border-slate-200 shadow-lg flex justify-end gap-3">
                    <button type="button" id="backToDashboardBtn" class="px-6 py-2.5 text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium transition-colors">إلغاء</button>
                    <button type="button" id="previewReportBtn" class="px-6 py-2.5 text-white bg-blue-600 hover:bg-blue-700 rounded-lg font-bold shadow-sm transition-colors">معاينة</button>
                    <button type="submit" class="px-6 py-2.5 text-white bg-green-600 hover:bg-green-700 rounded-lg font-bold shadow-sm transition-colors">حفظ التقرير</button>
                </div>
            </form>
        </div>

        <!-- Report Preview Container -->
        <div id="reportPreviewContainer" class="container mx-auto max-w-4xl p-8 my-10 bg-white rounded-2xl shadow-xl hidden">
            <div id="reportContent" class="prose max-w-none font-sans"></div>
            <div class="flex justify-center pt-8 mt-8 border-t border-slate-100 no-print gap-3">
                <button id="backToFormBtn" class="px-6 py-2 text-slate-700 bg-white border border-slate-300 hover:bg-slate-50 rounded-lg font-medium transition-colors">رجوع للتعديل</button>
                <button onclick="window.print()" class="px-6 py-2 text-white bg-slate-800 hover:bg-slate-900 rounded-lg font-medium shadow-sm transition-colors">طباعة</button>
            </div>
        </div>

        <!-- Modals for School App -->
        <!-- Manage Types Modal -->
        <div id="manageTypesModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[60] flex items-center justify-center" role="dialog" aria-modal="true">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 mx-4 max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-xl font-bold text-slate-800">إدارة أنواع الزيارات</h3>
                    <button id="closeManageModalBtn" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div id="visitTypesList" class="space-y-2 overflow-y-auto mb-4 pr-2 flex-grow"></div>
                <button id="openAddTypeModalBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg shrink-0">
                    <i class="fa-solid fa-plus ml-2"></i> إضافة نوع جديد
                </button>
            </div>
        </div>

        <!-- Add/Edit Type Modal -->
        <div id="addEditTypeModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[70] flex items-center justify-center" role="dialog" aria-modal="true">
             <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 mx-4">
                <h3 id="addEditModalTitle" class="text-xl font-bold text-slate-800 mb-4">إضافة نوع زيارة</h3>
                <form id="addEditTypeForm" class="space-y-4">
                    <input type="hidden" id="editTypeKey" value="">
                    <div>
                        <label class="block mb-1 text-sm font-medium text-slate-700">اسم الزيارة</label>
                        <input type="text" id="typeName" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" required>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm font-medium text-slate-700">الأهداف (هدف في كل سطر)</label>
                        <textarea id="typeObjectives" rows="5" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-2.5" placeholder="اكتب الأهداف هنا..." required></textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" id="cancelEditBtn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg">إلغاء</button>
                        <button type="submit" id="saveTypeBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold">حفظ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modals for Supervisory (Kept here for context) -->
    <div id="supervisoryConfirmationModal" class="modal-overlay fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex justify-center items-center" role="dialog" aria-modal="true">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i>
                </div>
                <h3 id="supervisory-modal-title" class="text-lg leading-6 font-bold text-slate-900"></h3>
                <div class="mt-2">
                    <p id="supervisory-modal-message" class="text-sm text-slate-500"></p>
                </div>
                <div class="mt-5 flex justify-center gap-3">
                    <button id="supervisory-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex-1">تأكيد</button>
                    <button id="supervisory-modal-cancel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg flex-1">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- UTILS: TOAST NOTIFICATIONS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toastMsg = document.getElementById('toast-message');
            const icon = document.getElementById('toast-icon');
            const text = document.getElementById('toast-text');

            container.classList.remove('opacity-0', 'translate-y-4');
            
            if (type === 'success') {
                toastMsg.className = 'bg-emerald-600 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 font-medium';
                icon.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
            } else if (type === 'error') {
                toastMsg.className = 'bg-red-600 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 font-medium';
                icon.innerHTML = '<i class="fa-solid fa-circle-xmark"></i>';
            } else {
                toastMsg.className = 'bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3 font-medium';
                icon.innerHTML = '<i class="fa-solid fa-circle-info"></i>';
            }
            
            text.textContent = message;
            setTimeout(() => { container.classList.add('opacity-0', 'translate-y-4'); }, 3000);
        }

        // --- UTILS: COPY TEXT ---
        function copyText(text) {
            if (!text) { showToast('لا يوجد نص لنسخه', 'error'); return; }
            navigator.clipboard.writeText(text).then(() => showToast('تم نسخ النص')).catch(() => showToast('فشل النسخ', 'error'));
        }

        // --- VIEW MANAGEMENT ---
        const welcomeView = document.getElementById('welcomeView');
        const supervisoryApp = document.getElementById('supervisoryVisitsApp');
        const schoolApp = document.getElementById('schoolVisitsApp');

        function showView(view) {
            welcomeView.classList.add('hidden');
            supervisoryApp.classList.add('hidden');
            schoolApp.classList.add('hidden');
            view.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        document.getElementById('showSupervisoryAppBtn').addEventListener('click', () => showView(supervisoryApp));
        document.getElementById('showSchoolAppBtn').addEventListener('click', () => showView(schoolApp));
        document.getElementById('backToWelcomeFromSupervisory').addEventListener('click', () => showView(welcomeView));
        
        const backToWelcomeFromSchoolDashboard = schoolApp.querySelector('#backToWelcomeFromSchool');
        if(backToWelcomeFromSchoolDashboard) {
            backToWelcomeFromSchoolDashboard.addEventListener('click', () => showView(welcomeView));
        }

        // --- SUPERVISORY VISITS APP CODE (Standard) ---
        function initializeSupervisoryApp() {
            // (Supervisory code remains unchanged for brevity as requested, it works fine)
            // ... [Keep existing supervisory code]
            let performanceChartInstance;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = SpeechRecognition ? new SpeechRecognition() : null;
            if (recognition) {
                recognition.continuous = false;
                recognition.lang = 'ar-SA';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            }

            const evaluationItems = [ 
                { id: 1, domain: 'الإنجاز الدراسي', standard: 'التحصيل الدراسي', title: 'تحصيل الطلبة في الأعمال الصفية وغير الصفية', desc: '(اكتساب المهارات الحركية والمعارف المرتبطة بها)' }, 
                { id: 2, domain: 'الإنجاز الدراسي', standard: 'التقدم الدراسي', title: 'التقدم الدراسي للطلبة بما فيهم الطلبة ذوي الإعاقة/الاحتياجات التعليمية', desc: '(تطور الأداء المهاري والخططي)' }, 
                { id: 3, domain: 'الإنجاز الدراسي', standard: 'مهارات التعلم', title: 'تطبيق مهارات التعلم (الذاتي- التعاوني - الرقمي - التفكير العليا) وربطها بالواقع', desc: '(القيادة، التعاون، التفكير الخططي في مواقف اللعب)' }, 
                { id: 4, domain: 'النمو الشخصي', standard: 'القيم والسلوك', title: 'تمسك الطلبة بالهوية العمانية والقيم الإنسانية', desc: '(الروح الرياضية وأخلاقيات اللعب)' }, 
                { id: 5, domain: 'مناخ المدرسة وبيئة التعلم', standard: 'جودة بيئة التعلم', title: 'متابعة جوانب الأمن والسلامة والنظافة في بيئة التعلم', desc: '(سلامة الأدوات والمرافق الرياضية)' }, 
                { id: 6, domain: 'التدريس والتقويم', standard: 'تخطيط المنهاج الدراسي', title: 'تخطيط المنهاج الدراسي لتحقيق نواتج التعلم', desc: '(التخطيط لتنمية المهارات الحركية واللياقة البدنية)' }, 
                { id: 7, domain: 'التدريس والتقويم', standard: 'إدارة الصف', title: 'فاعلية الإدارة الصفية', desc: '(إدارة وتنظيم النشاط البدني)' }, 
                { id: 8, domain: 'التدريس والتقويم', standard: 'فاعلية التدريس', title: 'توظيف استراتيجيات التدريس الفعالة', desc: '(استراتيجيات التدريس المناسبة للنشاط البدني)' }, 
                { id: 9, domain: 'التدريس والتقويم', standard: 'فاعلية التدريس', title: 'تفعيل المصادر والموارد التعليمية', desc: '(الأدوات والأجهزة والمرافق الرياضية)' }, 
                { id: 10, domain: 'التدريس والتقويم', standard: 'التقويم ومساندة التقدم', title: 'توظيف أساليب تقويم متنوعة', desc: '(تقويم الأداء الحركي والمهاري للطلبة)' }, 
                { id: 11, domain: 'القيادة والإدارة والحوكمة', standard: 'توظيف التقويم', title: 'توظيف التقويم الذاتي والتطوير المهني في تحسين الأداء', desc: '(التأمل في الممارسات التدريسية وتطويرها)' }, 
                { id: 12, domain: 'القيادة والإدارة والحوكمة', standard: 'الأنظمة', title: 'تطبيق السياسات والأنظمة واللوائح المنظمة للعمل', desc: '(الالتزام بأخلاقيات المهنة واللوائح)' }, 
                { id: 13, domain: 'القيادة والإدارة والحوكمة', standard: 'مبادرات', title: 'تنفيذ مبادرات وأنشطة تربوية في المجتمع المدرسي', desc: '(تنظيم الفعاليات والمسابقات الرياضية)' } 
            ];

            const evidenceBasedContent = {
                '1': {
                    levels: {
                        1: "يكتسب جميع الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة فعالة",
                        2: "يكتسب معظم الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة فعالة",
                        3: "يكتسب أغلب الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة ملائمة أو مقبولة",
                        4: "يكتسب قليل من الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة محدودة",
                        5: "يكتسب عدد نادر من الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة محدودة جدا/ نادرة"
                    },
                    evidences: ["أداء المهارة وفق الخطوات الفنية الصحيحة", "تطبيق القانون المرتبط بالمهارة أثناء اللعب", "الإجابة على الأسئلة المعرفية المرتبطة بالدرس", "ربط المهارة بمواقف اللعب الحقيقية", "تفاعل الطلبة مع التغذية الراجعة وتصحيح الأداء"],
                    neg_evidences: ["ضعف في أداء المهارة الفنية وفق الخطوات الصحيحة", "عدم تطبيق القانون المرتبط بالمهارة أثناء اللعب", "عجز عن الإجابة على الأسئلة المعرفية المرتبطة بالدرس", "صعوبة في ربط المهارة بمواقف اللعب الحقيقية", "عدم تفاعل الطلبة مع التغذية الراجعة"]
                },
                '2': {
                    levels: {
                        1: "يتقدم جميع الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوي الإعاقة/ الاحتياجات التعليمية بصورة متميزة",
                        2: "يتقدم معظم الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوي الإعاقة/ الاحتياجات التعليمية بصورة فاعلة",
                        3: "يتقدم أغلب الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوي الإعاقة/ الاحتياجات التعليمية بصورة ملائمة",
                        4: "يتقدم قليل من الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوي الإعاقة/ الاحتياجات التعليمية بصورة محدودة",
                        5: "يتقدم عدد نادر من الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوي الإعاقة/ الاحتياجات التعليمية بصورة محدودة جدا"
                    },
                    evidences: ["تحسن الأداء المهاري في الجزء الختامي مقارنة بالتمهيدي", "مشاركة الطلبة ذوي الاحتياجات بفاعلية وفق قدراتهم", "تطور مستوى اللعب الجماعي أثناء التقسيمة", "تصحيح الأخطاء الشائعة أثناء الممارسة", "التدرج في صعوبة التمرينات بما يناسب قدرات الطلبة"],
                    neg_evidences: ["ثبات المستوى المهاري دون تطور ملحوظ", "عزوف بعض الطلبة عن المشاركة الفعالة", "تكرار الأخطاء الفنية دون تصحيح", "عدم التدرج المناسب في التمرينات", "ضعف مستوى اللعب الجماعي أثناء التقسيمة"]
                },
                '3': {
                    levels: {
                        1: "يطبق جميع الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى متميز",
                        2: "يطبق معظم الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى فاعل",
                        3: "يطبق أغلب الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى ملائم أو مناسب",
                        4: "يطبق قليل من الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى محدود",
                        5: "يطبق عدد نادر من الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى محدود جدا/ نادر"
                    },
                    evidences: ["قيادة الطالب للمجموعة أثناء الإحماء أو التطبيق", "التعاون بين الزملاء لإنجاز المهمة الحركية", "اقتراح حلول للمشكلات الخططية أثناء اللعب", "تقييم الطالب لأداء زميله باستخدام البطاقة", "الالتزام بالأدوار الموكلة إليهم داخل الفريق"],
                    neg_evidences: ["غياب دور الطالب القيادي في المجموعات", "ضعف التعاون بين أفراد الفريق الواحد", "الاعتماد الكلي على المعلم في التوجيه", "غياب التقييم الذاتي أو للزميل", "عدم الالتزام بالأدوار الموكلة داخل الفريق"]
                },
                '4': {
                    levels: {
                        1: "يلتزم جميع الطلبة بالقيم الإنسانية المشتركة، ويراعون ذلك بمستوى متميز",
                        2: "يلتزم معظم الطلبة بالقيم الإنسانية المشتركة، ويراعون ذلك بمستوى فاعل",
                        3: "يلتزم أغلب الطلبة بالقيم الإنسانية المشتركة، ويراعون ذلك بمستوى ملائم/مناسب",
                        4: "يلتزم قليل من الطلبة بالقيم الإنسانية المشتركة، ويراعون ذلك بمستوى محدود",
                        5: "يلتزم عدد محدود جدا من الطلبة بالقيم الإنسانية المشتركة، ويراعون ذلك بمستوى محدود جدا ونادر"
                    },
                    evidences: ["مصافحة الزملاء وتقبل الفوز والخسارة", "احترام قرارات الطالب الحكم أثناء المنافسة", "الالتزام بالزي الرياضي المحتشم والكامل", "المحافظة على نظافة المكان بعد انتهاء الدرس", "التعامل باحترام مع المعلم والزملاء"],
                    neg_evidences: ["ظهور سلوكيات غير رياضية أثناء المنافسة", "عدم احترام قرارات التحكيم", "مخالفة الزي الرياضي المقرر", "إهمال نظافة المكان بعد انتهاء الدرس", "التعامل بأسلوب غير لائق مع الزملاء"]
                },
                '5': {
                    levels: {
                        1: "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة متميزة",
                        2: "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة جيدة",
                        3: "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة مناسبة",
                        4: "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة محدودة",
                        5: "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة نادرة/ منعدمة"
                    },
                    evidences: ["خلو الملعب من العوائق والأجسام الخطرة", "تثبيت الأهداف والأجهزة الرياضية بشكل آمن", "توزيع الطلبة في مسافات آمنة أثناء التطبيق", "فحص الأدوات الرياضية قبل استخدامها", "وجود حقيبة إسعافات أولية جاهزة للاستخدام"],
                    neg_evidences: ["وجود عوائق في ساحة اللعب تهدد السلامة", "عدم تثبيت الأهداف والأجهزة بشكل آمن", "تزاحم الطلبة في مساحات ضيقة أثناء التطبيق", "إهمال فحص الأدوات قبل الاستخدام", "عدم توفر حقيبة إسعافات أولية"]
                },
                '6': {
                    levels: {
                        1: "يخطط المعلم لجميع دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة متميزة",
                        2: "يخطط المعلم معظم دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة جيدة",
                        3: "يخطط المعلم أغلب دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة مناسبة",
                        4: "يخطط المعلم قليل من دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة محدودة",
                        5: "يخطط المعلم عدد محدود جدا من دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة نادرة"
                    },
                    evidences: ["تنوع الأهداف (مهارية، معرفية، وجدانية) في الخطة", "تسلسل الأنشطة من السهل إلى الصعب", "شمولية التحضير الكتابي لعناصر الدرس الأساسية", "التوافق مع الخطة الفصلية وتوزيع الوحدات", "تحديد أدوات التقويم المناسبة لكل هدف"],
                    neg_evidences: ["عشوائية في تسلسل الأنشطة", "عدم وجود تحضير كتابي مكتمل العناصر", "عدم توافق الدرس مع الخطة الفصلية", "غياب أهداف الدرس الواضحة والمحددة", "عدم تحديد أدوات التقويم المناسبة"]
                },
                '7': {
                    levels: {
                        1: "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة فعالة",
                        2: "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة جيدة",
                        3: "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة ملائمة",
                        4: "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة محدودة",
                        5: "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة نادرة"
                    },
                    evidences: ["الاستجابة السريعة لإشارات البدء والتوقف", "التنقل السلس والمنظم بين أجزاء الدرس", "توزيع الأدوات بطريقة منظمة توفر الوقت", "وقوف المعلم في مكان يكشف جميع الطلبة", "استثمار وقت الحصة كاملاً في النشاط البدني"],
                    neg_evidences: ["فوضى في الانتقال بين التشكيلات", "هدر وقت الحصة في تنظيم وتوزيع الأدوات", "وقوف المعلم في مكان غير كاشف للطلبة", "عدم انضباط سلوك الطلبة أثناء الشرح", "ضياع وقت التعلم الفعلي"]
                },
                '8': {
                    levels: {
                        1: "يوظف المعلم استراتيجيات التدريس فعالة بحيث يستفيد منها جميع الطلبة في تعميق تعلمهم بمستوى متميز",
                        2: "يوظف المعلم استراتيجيات التدريس فعالة بحيث يستفيد منها معظم الطلبة في تعميق تعلمهم بمستوى فاعل",
                        3: "يوظف المعلم استراتيجيات التدريس فعالة بحيث يستفيد منها أغلب الطلبة في تعميق تعلمهم بمستوى ملائم",
                        4: "يوظف المعلم استراتيجيات التدريس فعالة بحيث يستفيد منها قليل من الطلبة في تعميق تعلمهم بمستوى محدود",
                        5: "يوظف المعلم استراتيجيات التدريس فعالة بحيث يستفيد منها عدد قليل جدا من الطلبة في تعميق تعلمهم بمستوى نادر"
                    },
                    evidences: ["استخدام أسلوب التعلم بالأقران أو المجموعات", "توظيف التعلم بالاكتشاف الموجه في المهارات", "التنويع في أساليب التدريس لمراعاة الفروق الفردية", "تفعيل الألعاب الصغيرة لخدمة الهدف المهاري", "إشراك جميع الطلبة في عملية التعلم النشط"],
                    neg_evidences: ["الاعتماد الكلي على التلقين والشرح اللفظي", "ملل الطلبة من تكرار نفس الأسلوب", "عدم مراعاة الفروق الفردية في التدريس", "قلة فرص الممارسة العملية للطلبة", "عدم إشراك الطلبة في عملية التعلم"]
                },
                '9': {
                    levels: {
                        1: "يفعل المعلم التقنيات الرقمية والمصادر التعليمية بحيث يستفيد منها جميع الطلبة في تعميق تعلمهم بمستوى متميز",
                        2: "يفعل المعلم التقنيات الرقمية والمصادر التعليمية بحيث يستفيد منها معظم الطلبة في تعميق تعلمهم بمستوى جيد",
                        3: "يفعل المعلم التقنيات الرقمية والمصادر التعليمية بحيث يستفيد منها أغلب الطلبة في تعميق تعلمهم بمستوى ملائم",
                        4: "يفعل المعلم التقنيات الرقمية والمصادر التعليمية بحيث يستفيد منها قليل من الطلبة في تعميق تعلمهم بمستوى محدود",
                        5: "يفعل المعلم التقنيات الرقمية والمصادر التعليمية بحيث يستفيد منها قليل جدا من الطلبة في تعميق تعلمهم بمستوى نادر"
                    },
                    evidences: ["استخدام الأدوات البديلة عند نقص الإمكانيات", "توظيف التقانة (فيديو/صور) لتوضيح المهارة", "الاستخدام الأمثل للمساحات المتاحة في المدرسة", "توفير أدوات كافية لزيادة عدد التكرارات", "استخدام صافرة وأدوات توضيحية بفاعلية"],
                    neg_evidences: ["عدم كفاية الأدوات لعدد الطلبة", "عدم استخدام المساحات المتاحة في المدرسة", "خلو الدرس من وسائل توضيحية مساندة", "تعطل الأدوات المستخدمة أو عدم صلاحيتها", "سوء توزيع الأدوات على المجموعات"]
                },
                '10': {
                    levels: {
                        1: "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين جميع الطلبة بما يعكس على تعلمهم بمستوى متميز",
                        2: "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين معظم الطلبة بما يعكس على تعلمهم بمستوى فاعل",
                        3: "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين أغلب الطلبة بما يعكس على تعلمهم بمستوى ملائم",
                        4: "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين قليل من الطلبة بما يعكس على تعلمهم بمستوى محدود",
                        5: "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين قليل جدا من الطلبة بما يعكس على تعلمهم بمستوى نادر"
                    },
                    evidences: ["استخدام بطاقات الملاحظة لتقييم المهارة", "تقديم تغذية راجعة فورية لتصحيح الأخطاء", "إشراك الطلبة في التقويم الذاتي والزميل", "طرح أسئلة شفهية للتأكد من الفهم المعرفي", "رصد درجات الأداء المهاري في سجل المتابعة"],
                    neg_evidences: ["غياب التغذية الراجعة المصححة للأداء", "عدم رصد الدرجات أو الملاحظات في السجل", "عدم استخدام أدوات قياس واضحة", "إهمال تقويم الجانب المعرفي", "عدم إشراك الطلبة في عملية التقويم"]
                },
                '11': {
                    levels: {
                        1: "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم جميع الطلبة بمستوى متميز",
                        2: "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم معظم الطلبة بمستوى فاعل",
                        3: "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم أغلب الطلبة بمستوى مناسب",
                        4: "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم قليل من الطلبة بمستوى محدود",
                        5: "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم قليل جدا من الطلبة بمستوى نادر"
                    },
                    evidences: ["تطبيق استراتيجيات جديدة تم تعلمها في المشاغل", "تقبل توجيهات المشرف والعمل على تنفيذها", "تحليل نتائج تعلم الطلبة وتطوير الخطط بناءً عليها", "تبادل الزيارات مع الزملاء للاستفادة من الخبرات", "المشاركة الفعالة في الإنماء المهني بالمدرسة"],
                    neg_evidences: ["عدم تقبل التوجيهات الفنية لتطوير الأداء", "تكرار نفس الممارسات الخاطئة", "غياب أثر البرامج التدريبية على الأداء", "عدم تحليل نتائج تعلم الطلبة", "عدم المشاركة في تبادل الخبرات"]
                },
                '12': {
                    levels: {
                        1: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة فعالة",
                        2: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة فاعلة",
                        3: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة مناسبة",
                        4: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة محدودة",
                        5: "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة نادرة"
                    },
                    evidences: ["الالتزام بمواعيد الحضور والانصراف للحصة", "ارتداء الزي الرياضي المناسب واللائق", "تطبيق لائحة شؤون الطلبة في المواقف السلوكية", "التقيد بتعاميم الأمن والسلامة المدرسية", "المحافظة على عهدة التربية الرياضية وسجلاتها"],
                    neg_evidences: ["التأخر عن موعد الحصة الدراسية", "عدم الالتزام بالزي الرياضي الرسمي", "تجاهل تعاميم الأمن والسلامة", "قصور في سجلات المادة والعهدة", "عدم تطبيق اللوائح السلوكية"]
                },
                '13': {
                    levels: {
                        1: "يقدم مبادرات فعالة لدعم وتحسين العملية التعليمية، كما يتميز بالتفاعل الإيجابي في جميع الأنشطة التربوية والمجتمع المحلي",
                        2: "يقدم مبادرات فاعلة لدعم وتحسين العملية التعليمية، كما يتميز بالتفاعل الإيجابي في معظم الأنشطة التربوية والمجتمع المحلي",
                        3: "يقدم مبادرات ملائمة لدعم وتحسين العملية التعليمية، كما يتميز بالتفاعل الإيجابي في أغلب الأنشطة التربوية والمجتمع المحلي",
                        4: "يقدم مبادرات محدودة لدعم وتحسين العملية التعليمية، كما يتميز بالتفاعل الإيجابي في محدود الأنشطة التربوية والمجتمع المحلي",
                        5: "نادرا ما يقدم مبادرات لدعم وتحسين العملية التعليمية، كما أن تفاعله مع الأنشطة التربوية والمجتمع المحلي محدود جدا"
                    },
                    evidences: ["تنظيم دوري رياضي داخلي أثناء الفسحة", "تفعيل برنامج الرياضة المدرسية في الطابور", "تدريب الفرق المدرسية للمسابقات الخارجية", "تنفيذ مسابقات رياضية للمعلمين أو المجتمع المحلي", "نشر الثقافة الصحية والرياضية في المدرسة"],
                    neg_evidences: ["عدم تفعيل الرياضة المدرسية في الطابور", "غياب النشاط الداخلي أثناء الفسحة", "عدم المشاركة في المسابقات الخارجية", "انعزال المعلم عن المجتمع المدرسي", "غياب المبادرات لنشر الثقافة الرياضية"]
                }
            };

            const instructionalRecommendations = { '1': "احرص على تنويع الأنشطة والتدريبات العملية لضمان إتقان جميع الطلبة للمهارات الحركية.", '2': "تابع التقدم الفردي للطلبة وقدم تحديات مناسبة لمستوياتهم.", '3': "شجع الطلبة على اتخاذ القرارات التكتيكية وتوزيع الأدوار القيادية.", '4': "عزز قيم الروح الرياضية واللعب النظيف من خلال الممارسة العملية.", '5': "افحص الملعب والأدوات دورياً وعلم الطلبة قواعد الأمن والسلامة.", '6': "استمر في التخطيط المنهجي للدروس بما يضمن التدرج في المهارات.", '7': "وظف استراتيجيات فعالة لإدارة المجموعات لزيادة وقت النشاط الفعلي.", '8': "نوّع في استخدام استراتيجيات التدريس كالتعلم باللعب والتدريس بالأقران.", '9': "استغل الموارد المتاحة بشكل إبداعي وكيف الأنشطة مع الإمكانيات.", '10': "استخدم قوائم الملاحظة لتقديم تغذية راجعة فورية للطلبة.", '11': "تأمل في ممارساتك وابحث عن أفكار جديدة لتطوير أساليبك.", '12': "التزم دائماً باللوائح وكن نموذجاً في السلوك المهني.", '13': "بادر بتنظيم فعاليات رياضية تشمل المجتمع المدرسي والمحلي." };

            function generateEvaluationForm() {
                const formContainer = supervisoryApp.querySelector('#evaluationForm');
                formContainer.innerHTML = '';
                let currentDomain = '';
                let sectionDiv;
                
                evaluationItems.forEach(item => {
                    if (item.domain !== currentDomain) {
                        currentDomain = item.domain;
                        sectionDiv = document.createElement('div');
                        sectionDiv.className = 'bg-white rounded-2xl shadow-sm border border-slate-200 mb-6';
                        sectionDiv.innerHTML = `<div class="bg-slate-100 p-4 border-b border-slate-200 rounded-t-2xl"><h3 class="font-bold text-slate-700 flex items-center gap-2"><span class="w-2 h-6 bg-blue-600 rounded-full"></span>${currentDomain}</h3></div>`;
                        formContainer.appendChild(sectionDiv);
                    }
                    
                    const itemCard = document.createElement('div');
                    itemCard.className = 'p-5 border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors item-card relative';
                    itemCard.id = `item-${item.id}`;
                    itemCard.innerHTML = `
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <div class="flex-grow"><h4 class="font-bold text-slate-800 text-lg mb-1">${item.id}. ${item.title}</h4><p class="text-slate-500 text-sm">${item.desc}</p></div>
                            <div class="score w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center font-bold text-xl text-slate-700 shadow-inner" id="score-${item.id}">3</div>
                        </div>
                        <div class="grid grid-cols-5 gap-2 mb-4 rating-selector">
                           <button type="button" class="rating-btn score-1 py-2 px-1 rounded-lg border border-slate-200 bg-white text-xs md:text-sm font-medium transition-all" data-score="1">متميز</button>
                           <button type="button" class="rating-btn score-2 py-2 px-1 rounded-lg border border-slate-200 bg-white text-xs md:text-sm font-medium transition-all" data-score="2">جيد</button>
                           <button type="button" class="rating-btn score-3 active py-2 px-1 rounded-lg border border-slate-200 bg-white text-xs md:text-sm font-medium transition-all" data-score="3">ملائم</button>
                           <button type="button" class="rating-btn score-4 py-2 px-1 rounded-lg border border-slate-200 bg-white text-xs md:text-sm font-medium transition-all" data-score="4">غير ملائم</button>
                           <button type="button" class="rating-btn score-5 py-2 px-1 rounded-lg border border-slate-200 bg-white text-xs md:text-sm font-medium transition-all" data-score="5">تدخل سريع</button>
                        </div>
                        <div class="relative">
                            <div class="flex justify-between items-center mb-1">
                                <label class="text-xs font-bold text-slate-500">الوصف الإشرافي والأدلة:</label>
                                <button type="button" class="edit-evidence-btn" id="edit-evidence-${item.id}" data-id="${item.id}">✏️ تعديل الأدلة (اختياري)</button>
                            </div>
                            <div id="notes-${item.id}" class="item-notes w-full min-h-[80px] p-3 pl-10 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" contenteditable="true"></div>
                            <div id="evidence-panel-${item.id}" class="evidence-panel hidden absolute z-50 bg-white border border-slate-200 shadow-xl rounded-lg p-4 w-full max-w-md mt-1 left-0">
                                <h5 class="font-bold text-sm mb-2 text-slate-700">اختر الشواهد المناسبة:</h5>
                                <div id="evidence-list-${item.id}" class="space-y-2 max-h-48 overflow-y-auto mb-3 p-1"></div>
                                <div class="border-t border-slate-100 pt-2 mb-2">
                                    <div class="flex gap-2 items-center">
                                        <input type="text" class="new-evidence-input w-full text-xs border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="إضافة دليل آخر..." data-id="${item.id}">
                                        <button type="button" class="add-evidence-btn bg-blue-100 text-blue-700 hover:bg-blue-200 p-1.5 rounded-md transition-colors" data-id="${item.id}" title="إضافة"><i class="fa-solid fa-plus text-sm"></i></button>
                                    </div>
                                </div>
                                <div class="flex justify-end"><button type="button" class="close-evidence-panel text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded font-medium" data-id="${item.id}">إغلاق</button></div>
                            </div>
                            ${recognition ? `<button type="button" class="mic-btn absolute bottom-2 left-2 text-slate-400 hover:text-blue-600 transition-colors p-1 rounded-full"><i class="fa-solid fa-microphone"></i></button>` : ''}
                        </div>
                    `;
                    sectionDiv.appendChild(itemCard);
                });
                evaluationItems.forEach(item => updateScore(item.id, 3, true));
            }

            function generateDescriptionText(itemId, rating, customEvidences = null) {
                const content = evidenceBasedContent[itemId];
                if (!content) return "";
                const positiveEvidences = content.evidences;
                const negativeEvidences = content.neg_evidences || [];
                let text = "";
                let selectedEvidences = [];
                if (customEvidences) {
                    selectedEvidences = customEvidences;
                } else {
                    if (rating == 1) selectedEvidences = getRandomEvidences(positiveEvidences, 2);
                    else if (rating == 2) selectedEvidences = getRandomEvidences(positiveEvidences, 1);
                    else if (rating == 3) selectedEvidences = getRandomEvidences(positiveEvidences, 1);
                    else if (rating == 4) selectedEvidences = getRandomEvidences(negativeEvidences, 1);
                    else if (rating == 5) selectedEvidences = getRandomEvidences(negativeEvidences, 2);
                }
                const joinEvidences = (list) => { if (list.length === 0) return ""; if (list.length === 1) return list[0]; return list.join("، و"); };
                const joinedEvidencesText = joinEvidences(selectedEvidences);
                
                if (content.levels && content.levels[rating]) {
                    text = `${content.levels[rating]}، ويتضح ذلك من خلال ${joinedEvidencesText}.`;
                } else {
                    // Fallback in case level is missing (should not happen with updated data)
                    text = `مستوى ${rating}، ويتضح ذلك من خلال ${joinedEvidencesText}.`;
                }
                return text;
            }

            function getRandomEvidences(arr, count) {
                if (!arr || arr.length === 0) return [];
                const shuffled = [...arr].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }

            function openEvidencePanel(itemId) {
                const panel = supervisoryApp.querySelector(`#evidence-panel-${itemId}`);
                const listContainer = supervisoryApp.querySelector(`#evidence-list-${itemId}`);
                const currentText = supervisoryApp.querySelector(`#notes-${itemId}`).textContent;
                const content = evidenceBasedContent[itemId];
                const rating = supervisoryApp.querySelector(`#score-${itemId}`).textContent;
                if (!content) return;
                supervisoryApp.querySelectorAll('.evidence-panel').forEach(p => p.classList.add('hidden'));
                const sourceList = (rating >= 4) ? (content.neg_evidences || []) : content.evidences;
                listContainer.innerHTML = '';
                if(sourceList.length === 0) {
                    listContainer.innerHTML = '<p class="text-xs text-gray-400 p-2">لا توجد شواهد مقترحة لهذا التقدير.</p>';
                } else {
                    sourceList.forEach((ev, index) => {
                        const isChecked = currentText.includes(ev);
                        const div = document.createElement('div');
                        div.className = 'evidence-item flex items-center gap-2 group hover:bg-slate-50 p-1 rounded';
                        div.innerHTML = `<input type="checkbox" id="ev-${itemId}-${index}" class="evidence-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" value="${ev}" ${isChecked ? 'checked' : ''} data-item-id="${itemId}"><label for="ev-${itemId}-${index}" class="text-sm text-slate-700 leading-tight cursor-pointer select-none flex-grow">${ev}</label><button type="button" class="delete-evidence-btn text-slate-300 hover:text-red-500 transition-opacity p-1" data-item-id="${itemId}" data-value="${ev}" title="حذف"><i class="fa-solid fa-trash-can text-xs"></i></button>`;
                        listContainer.appendChild(div);
                    });
                }
                panel.classList.remove('hidden');
            }

            function updateDescriptionFromPanel(itemId) {
                const checkboxes = supervisoryApp.querySelectorAll(`#evidence-list-${itemId} .evidence-checkbox:checked`);
                const selectedEvidences = Array.from(checkboxes).map(cb => cb.value);
                const rating = supervisoryApp.querySelector(`#score-${itemId}`).textContent;
                const newText = generateDescriptionText(itemId, rating, selectedEvidences);
                supervisoryApp.querySelector(`#notes-${itemId}`).textContent = newText;
            }

            function updateScore(itemId, score, forceUpdate = false) {
                const mainScoreDisplay = supervisoryApp.querySelector(`#score-${itemId}`);
                mainScoreDisplay.textContent = score;
                updateScoreColor(mainScoreDisplay, score);
                const ratingContainer = supervisoryApp.querySelector(`#item-${itemId} .rating-selector`);
                ratingContainer.querySelectorAll('.rating-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.score == score));
                supervisoryApp.querySelector(`#edit-evidence-${itemId}`).classList.remove('hidden');
                const notesDiv = supervisoryApp.querySelector(`#notes-${itemId}`);
                if (forceUpdate || notesDiv.textContent.trim() === '') {
                    notesDiv.textContent = generateDescriptionText(itemId, score);
                }
            }
            
            function updateScoreColor(element, score) {
                element.className = 'score w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl shadow-inner transition-colors';
                if (score == 1) element.classList.add('bg-green-100', 'text-green-800'); else if (score == 2) element.classList.add('bg-blue-100', 'text-blue-800'); else if (score == 3) element.classList.add('bg-amber-100', 'text-amber-800'); else if (score == 4) element.classList.add('bg-red-50', 'text-red-800'); else if (score == 5) element.classList.add('bg-red-600', 'text-white');
            }

            // ... (Rest of existing supervisory functions: toggleView, print, export etc.)
            function toggleView(viewId) {
                supervisoryApp.querySelectorAll('#form-view, #dashboard-view, #saved-reports-view').forEach(view => view.classList.add('hidden'));
                supervisoryApp.querySelector(`#${viewId}`).classList.remove('hidden');
                supervisoryApp.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active', 'bg-white', 'shadow-sm', 'text-blue-700');
                    tab.classList.add('text-slate-500');
                    if(tab.dataset.view === viewId) {
                        tab.classList.add('active', 'bg-white', 'shadow-sm', 'text-blue-700');
                        tab.classList.remove('text-slate-500');
                    }
                });
                if (viewId === 'saved-reports-view') renderSavedReports();
                else if (viewId === 'dashboard-view') { populateTeacherDashboardDropdown(); updateDashboardView(); }
            }
            function getSchoolName() { return supervisoryApp.querySelector('#school').value.trim(); }
            function getTeacherName() { return supervisoryApp.querySelector('#teacherName').value.trim(); }
            function prepareOfficialPrint() {
                const printTbody = supervisoryApp.querySelector('#print-main-tbody');
                printTbody.innerHTML = '';
                ['school', 'teacherName', 'fileNumber', 'subject', 'visitNumber', 'visitDate', 'class', 'lesson', 'topic', 'visitorName', 'visitorPosition'].forEach(id => {
                    supervisoryApp.querySelector(`#print-${id}`).textContent = (id === 'school') ? getSchoolName() : (id === 'teacherName') ? getTeacherName() : supervisoryApp.querySelector(`#${id}`).value;
                });
                ['strengthsContent', 'developmentContent', 'recommendationsContent'].forEach(id => { supervisoryApp.querySelector(`#print-${id}`).innerText = supervisoryApp.querySelector(`#${id}`).value; });
                const groupedItems = evaluationItems.reduce((acc, item) => { acc[item.domain] = acc[item.domain] || {}; (acc[item.domain][item.standard] = acc[item.domain][item.standard] || []).push(item); return acc; }, {});
                for (const domain in groupedItems) {
                    const standards = groupedItems[domain];
                    const domainItemCount = Object.values(standards).flat().length;
                    let isFirstRowOfDomain = true;
                    for (const standard in standards) {
                        const items = standards[standard];
                        const standardItemCount = items.length;
                        items.forEach((item, itemIndex) => {
                            const row = document.createElement('tr');
                            const score = supervisoryApp.querySelector(`#score-${item.id}`).textContent;
                            let domainCell = (isFirstRowOfDomain && itemIndex === 0) ? `<td rowspan="${domainItemCount}" class="font-bold bg-gray-50 align-top p-2">${domain}</td>` : '';
                            let standardCell = (itemIndex === 0) ? `<td rowspan="${standardItemCount}" class="font-bold align-top p-2">${standard}</td>` : '';
                            row.innerHTML = `${domainCell}${standardCell}<td class="text-center">${item.id}</td><td class="text-right p-2">${item.title}</td><td class="font-bold text-center">${score}</td>`;
                            printTbody.appendChild(row);
                        });
                        isFirstRowOfDomain = false;
                    }
                }
            }
            function printOfficialReport() { prepareOfficialPrint(); window.print(); }
            function exportToWord() { /* Same as before */ 
                const teacher = getTeacherName() || ""; const school = getSchoolName() || ""; const subject = supervisoryApp.querySelector("#subject").value || ""; const date = supervisoryApp.querySelector("#visitDate").value || ""; const fileNo = supervisoryApp.querySelector("#fileNumber").value || ""; const visitNo = supervisoryApp.querySelector("#visitNumber").value || ""; const className = supervisoryApp.querySelector("#class").value || ""; const lesson = supervisoryApp.querySelector("#lesson").value || ""; const topic = supervisoryApp.querySelector("#topic").value || ""; 
                const groupedItems = evaluationItems.reduce((acc, item) => { acc[item.domain] = acc[item.domain] || {}; (acc[item.domain][item.standard] = acc[item.domain][item.standard] || []).push(item); return acc; }, {});
                let tableRows = "";
                for (const domain in groupedItems) { const standards = groupedItems[domain]; const domainItemCount = Object.values(standards).flat().length; let isFirstRowOfDomain = true; for (const standard in standards) { const items = standards[standard]; items.forEach((item, itemIndex) => { const score = supervisoryApp.querySelector(`#score-${item.id}`).textContent; let domainCell = (isFirstRowOfDomain && itemIndex === 0) ? `<td rowspan="${domainItemCount}" style="width:15%; border:1px solid #000; padding:5px; text-align:center; vertical-align:middle; font-weight:bold;">${domain}</td>` : ''; let standardCell = (itemIndex === 0) ? `<td rowspan="${items.length}" style="width:15%; border:1px solid #000; padding:5px; text-align:center; vertical-align:middle; font-weight:bold;">${standard}</td>` : ''; tableRows += `<tr>${domainCell}${standardCell}<td style="width:5%; border:1px solid #000; padding:5px; text-align:center; vertical-align:middle;">${item.id}</td><td style="border:1px solid #000; padding:5px; text-align:right; vertical-align:middle;">${item.title}</td><td style="width:10%; border:1px solid #000; padding:5px; text-align:center; vertical-align:middle; font-weight:bold;">${score}</td></tr>`; }); isFirstRowOfDomain = false; } }
                const strengths = supervisoryApp.querySelector('#strengthsContent').value.replace(/\n/g, '<br>'); const needs = supervisoryApp.querySelector('#developmentContent').value.replace(/\n/g, '<br>'); const recs = supervisoryApp.querySelector('#recommendationsContent').value.replace(/\n/g, '<br>');
                const wordHTML = `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><style>body{font-family:'Arial',serif;font-size:14px;text-align:right;}table{border-collapse:collapse;width:100%;margin-bottom:10px;}td,th{border:1px solid #000;padding:5px;}.title-box{background-color:#fff2cc;border:1px solid #fff;padding:8px;text-align:center;font-weight:bold;margin:10px auto;width:60%;}</style></head><body><table style="border:none;"><tr><td style="border:none;text-align:right;width:40%;">المديرية العامة للتربية والتعليم<br>دائرة الإشراف التربوي</td><td style="border:none;text-align:left;width:60%;">العام الدراسي: 2025/2026م</td></tr></table><div class="title-box">استمارة زيارة إشرافية</div><table style="width:100%;border:none;"><tr><td style="text-align:right;"><strong>المدرسة:</strong> ${school}</td><td style="text-align:left;"><strong>المعلم:</strong> ${teacher}</td></tr><tr><td style="text-align:right;"><strong>رقم الملف:</strong> ${fileNo}</td><td style="text-align:left;"><strong>المادة:</strong> رياضة</td></tr><tr><td style="text-align:right;"><strong>التاريخ:</strong> ${date}</td><td style="text-align:left;"><strong>الزيارة:</strong> ${visitNo}</td></tr><tr><td colspan="2"><strong>الموضوع:</strong> ${topic}</td></tr></table><table><thead><tr style="background-color:#f2f2f2;"><th>المجال</th><th>المعيار</th><th>م</th><th>البند</th><th>التقدير</th></tr></thead><tbody>${tableRows}</tbody></table><br><strong>جوانب الإجادة:</strong><br>${strengths}<br><br><strong>تحتاج لتطوير:</strong><br>${needs}<br><br><strong>التوصيات:</strong><br>${recs}</body></html>`;
                const fileName = `${visitNo || 'زيارة'} - ${school} - ${teacher}.docx`;
                const converted = htmlDocx.asBlob(wordHTML, { orientation: 'portrait', margins: { top: 720, bottom: 720, left: 720, right: 720 } });
                const link = document.createElement('a'); link.href = URL.createObjectURL(converted); link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('تم تصدير ملف Word بنجاح');
            }
            function generateReport() { /* ... same as before */ 
                let itemsByScore = { 1: [], 2: [], 3: [], 4: [], 5: [] }; evaluationItems.forEach(item => { const score = parseInt(supervisoryApp.querySelector(`#score-${item.id}`).textContent); itemsByScore[score].push({ id: item.id, title: item.title, standard: item.standard, notes: supervisoryApp.querySelector(`#notes-${item.id}`).textContent }); });
                const strengths = [...itemsByScore[1], ...itemsByScore[2]].slice(0, 4); const developments = [...itemsByScore[5], ...itemsByScore[4]].slice(0, 4);
                let recommendationsList = [...developments]; const extraRecs = itemsByScore[3].sort(() => 0.5 - Math.random()).slice(0, 2); extraRecs.forEach(rec => { if (!recommendationsList.find(item => item.id === rec.id)) recommendationsList.push(rec); });
                supervisoryApp.querySelector('#strengthsContent').value = strengths.map(s => `• ${s.standard}: ${s.notes}`).join('\n'); supervisoryApp.querySelector('#developmentContent').value = developments.map(d => `• ${d.standard}: ${d.notes}`).join('\n'); let recommendationsText = "نوصي المعلم بالآتي:\n"; recommendationsList.forEach(rec => { if (instructionalRecommendations[rec.id]) recommendationsText += `• ${rec.standard}: ${instructionalRecommendations[rec.id]}\n`; }); supervisoryApp.querySelector('#recommendationsContent').value = recommendationsText + "\nوالله ولي التوفيق.";
                supervisoryApp.querySelector('#reportSection').classList.remove('hidden'); supervisoryApp.querySelector('#reportSection').scrollIntoView({ behavior: 'smooth' }); showToast('تم توليد التقرير بنجاح');
            }
            // ... (Rest of event listeners and logic helpers)
            function startDictation(divId, button) {
                if (!recognition) { showToast('المتصفح لا يدعم الإملاء الصوتي', 'error'); return; }
                button.classList.add('recording'); recognition.start();
                recognition.onresult = (event) => { supervisoryApp.querySelector(`#${divId}`).innerHTML += (supervisoryApp.querySelector(`#${divId}`).textContent.length > 0 ? ' ' : '') + event.results[0][0].transcript; };
                recognition.onspeechend = () => recognition.stop(); recognition.onend = () => { button.classList.remove('recording'); };
            }
            function copyReportContent(textareaId) {
                const textarea = supervisoryApp.querySelector(`#${textareaId}`);
                if (!textarea.value) { showToast('لا يوجد محتوى لنسخه', 'error'); return; }
                navigator.clipboard.writeText(textarea.value).then(() => showToast('تم نسخ النص')).catch(() => showToast('فشل النسخ', 'error'));
            }
            function showConfirmationModal(title, message, onConfirm) {
                supervisoryApp.querySelector('#supervisory-modal-title').textContent = title; supervisoryApp.querySelector('#supervisory-modal-message').textContent = message;
                const modal = supervisoryApp.querySelector('#supervisoryConfirmationModal'); modal.classList.remove('hidden');
                const confirmBtn = supervisoryApp.querySelector('#supervisory-modal-confirm-btn'); const cancelBtn = supervisoryApp.querySelector('#supervisory-modal-cancel-btn');
                const newConfirm = confirmBtn.cloneNode(true); const newCancel = cancelBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn); cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);
                newConfirm.addEventListener('click', () => { onConfirm(); modal.classList.add('hidden'); }); newCancel.addEventListener('click', () => { modal.classList.add('hidden'); });
            }
            function performReset() {
                supervisoryApp.querySelector('#evaluationForm').reset(); supervisoryApp.querySelectorAll('input:not([type="button"]), textarea').forEach(input => input.value = ''); supervisoryApp.querySelector('#visitDate').value = new Date().toISOString().split('T')[0];
                evaluationItems.forEach(item => { updateScore(item.id, 3, true); supervisoryApp.querySelector(`#notes-${item.id}`).textContent = generateDescriptionText(item.id, 3); });
                supervisoryApp.querySelector('#reportSection').classList.add('hidden'); showToast('تم إعادة تعيين النموذج');
            }
            function savePermanentReport() {
                const teacherName = getTeacherName(); const visitDate = supervisoryApp.querySelector('#visitDate').value; if (!teacherName || !visitDate) { showToast('يرجى إدخال اسم المعلم والتاريخ', 'error'); return; }
                const reportId = `visit_v5_${Date.now()}`; const reportData = { id: reportId, teacherName, visitDate, school: getSchoolName(), formData: {} };
                supervisoryApp.querySelectorAll('input, select, textarea').forEach(el => { if (el.id) reportData.formData[el.id] = el.value; });
                evaluationItems.forEach(item => { reportData.formData[`score-${item.id}`] = supervisoryApp.querySelector(`#score-${item.id}`).textContent; reportData.formData[`notes-${item.id}`] = supervisoryApp.querySelector(`#notes-${item.id}`).textContent; });
                localStorage.setItem(reportId, JSON.stringify(reportData));
                const visitDataForDashboard = { date: visitDate, scores: {} }; evaluationItems.forEach(item => visitDataForDashboard.scores[`item-${item.id}`] = parseInt(supervisoryApp.querySelector(`#score-${item.id}`).textContent) || 3);
                const teacherArchiveKey = `teacher_archive_v5_${teacherName}`; let archive = JSON.parse(localStorage.getItem(teacherArchiveKey)) || []; const existingVisitIndex = archive.findIndex(v => v.date === visitDate); if (existingVisitIndex > -1) archive[existingVisitIndex] = visitDataForDashboard; else archive.push(visitDataForDashboard); archive.sort((a, b) => new Date(a.date) - new Date(b.date)); localStorage.setItem(teacherArchiveKey, JSON.stringify(archive)); showToast('تم حفظ التقرير بنجاح');
            }
            function loadPermanentReport(reportKey) {
                const data = JSON.parse(localStorage.getItem(reportKey));
                if (data && data.formData) { performReset(); Object.keys(data.formData).forEach(key => { const el = supervisoryApp.querySelector(`#${key}`); if (el) { if (el.classList.contains('item-notes')) el.textContent = data.formData[key]; else if (el.classList.contains('score')) el.textContent = data.formData[key]; else el.value = data.formData[key]; } }); if(data.formData['school']) supervisoryApp.querySelector('#school').value = data.formData['school']; if(data.formData['teacherName']) supervisoryApp.querySelector('#teacherName').value = data.formData['teacherName']; evaluationItems.forEach(item => updateScore(item.id, parseInt(data.formData[`score-${item.id}`] || 3))); toggleView('form-view'); showToast('تم تحميل التقرير'); }
            }
            function renderSavedReports() {
                const listContainer = supervisoryApp.querySelector('#saved-reports-list'); const noReportsMessage = supervisoryApp.querySelector('#no-saved-reports-message'); const filterText = supervisoryApp.querySelector('#filter-reports-input').value.toLowerCase(); listContainer.innerHTML = '';
                let reports = []; for (let i = 0; i < localStorage.length; i++) { if (localStorage.key(i).startsWith('visit_v5_')) reports.push({ key: localStorage.key(i), data: JSON.parse(localStorage.getItem(localStorage.key(i))) }); } reports.sort((a, b) => new Date(b.data.visitDate) - new Date(a.data.visitDate));
                let found = false; reports.forEach(({ key, data }) => { const schoolName = data.school || '-'; if (data.teacherName.toLowerCase().includes(filterText) || schoolName.toLowerCase().includes(filterText)) { found = true; const card = document.createElement('div'); card.className = 'bg-white border border-slate-200 rounded-xl p-5 hover:shadow-md transition-shadow flex flex-col justify-between'; card.innerHTML = `<div class="mb-4"><h4 class="font-bold text-slate-800 text-lg">${data.teacherName}</h4><div class="text-sm text-slate-500 mt-1 flex flex-col gap-1"><span><i class="fa-solid fa-school ml-1 text-slate-400"></i> ${schoolName}</span><span><i class="fa-regular fa-calendar ml-1 text-slate-400"></i> ${data.visitDate}</span></div></div><div class="flex gap-2 mt-auto pt-4 border-t border-slate-100"><button class="load-btn flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 py-2 rounded-lg text-sm font-bold transition-colors" data-key="${key}">عرض</button><button class="delete-btn flex-1 bg-red-50 text-red-600 hover:bg-red-100 py-2 rounded-lg text-sm font-bold transition-colors" data-key="${key}">حذف</button></div>`; listContainer.appendChild(card); } }); if(found) noReportsMessage.classList.add('hidden'); else noReportsMessage.classList.remove('hidden');
            }
            function deletePermanentReport(key) { showConfirmationModal('تأكيد الحذف', 'سيتم حذف التقرير نهائياً', () => { const data = JSON.parse(localStorage.getItem(key)); localStorage.removeItem(key); if(data) { const teacherArchiveKey = `teacher_archive_v5_${data.teacherName}`; let archive = (JSON.parse(localStorage.getItem(teacherArchiveKey)) || []).filter(visit => visit.date !== data.visitDate); if (archive.length > 0) localStorage.setItem(teacherArchiveKey, JSON.stringify(archive)); else localStorage.removeItem(teacherArchiveKey); } renderSavedReports(); showToast('تم الحذف بنجاح'); }); }
            function populateTeacherDashboardDropdown() { const teacherSelect = supervisoryApp.querySelector('#teacher-dashboard-select'); const teacherNames = new Set(); for (let i = 0; i < localStorage.length; i++) if (localStorage.key(i).startsWith('teacher_archive_v5_')) teacherNames.add(localStorage.key(i).replace('teacher_archive_v5_', '')); teacherSelect.innerHTML = '<option value="">اختر معلمًا...</option>'; teacherNames.forEach(name => teacherSelect.innerHTML += `<option value="${name}">${name}</option>`); }
            function updateDashboardView() { if (performanceChartInstance) performanceChartInstance.destroy(); const teacherName = supervisoryApp.querySelector('#teacher-dashboard-select').value; const chartContainer = supervisoryApp.querySelector('#chart-container'); const noDataMessage = supervisoryApp.querySelector('#no-data-message'); const chartType = supervisoryApp.querySelector('#chartTypeSelect').value; const dateGroup = supervisoryApp.querySelector('#visitDateGroup'); dateGroup.classList.toggle('hidden', chartType !== 'radar'); if (!teacherName) { chartContainer.classList.add('hidden'); noDataMessage.classList.remove('hidden'); return; } const archive = JSON.parse(localStorage.getItem(`teacher_archive_v5_${teacherName}`)); if (!archive || archive.length === 0) { chartContainer.classList.add('hidden'); noDataMessage.classList.remove('hidden'); return; } chartContainer.classList.remove('hidden'); noDataMessage.classList.add('hidden'); const visitDateSelect = supervisoryApp.querySelector('#visitDateSelect'); if(chartType === 'radar') { if(visitDateSelect.children.length === 0 || visitDateSelect.children.length !== archive.length) { visitDateSelect.innerHTML = ''; archive.forEach(visit => visitDateSelect.innerHTML += `<option value="${visit.date}">${visit.date}</option>`); visitDateSelect.value = archive[archive.length - 1].date; } } const ctx = supervisoryApp.querySelector('#performanceChart').getContext('2d'); const labels = evaluationItems.map(item => `${item.id}. ${item.standard}`); const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']; let chartConfig = { type: chartType, data: { labels: (chartType === 'line' ? archive.map(v=>v.date) : labels), datasets: [] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { r: { min: 0, max: 5, ticks: { stepSize: 1 } }, y: { min: 0, max: 5 } } } }; if (chartType === 'line') { chartConfig.data.datasets = evaluationItems.map((item, i) => ({ label: item.title.substring(0, 20) + '...', data: archive.map(v => v.scores[`item-${item.id}`] || 0), borderColor: colors[i % colors.length], tension: 0.2 })); } else if (chartType === 'radar') { const visitData = archive.find(v => v.date === visitDateSelect.value); const data = visitData ? evaluationItems.map(item => visitData.scores[`item-${item.id}`] || 0) : []; chartConfig.data.datasets = [{ label: `أداء ${visitDateSelect.value}`, data: data, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6', pointBackgroundColor: '#fff' }]; } else { const avgScores = evaluationItems.map(item => { const s = archive.map(v => v.scores[`item-${item.id}`]||0); return s.reduce((a,b)=>a+b,0)/s.length; }); chartConfig.data.datasets = [{ label: 'المتوسط العام', data: avgScores, backgroundColor: '#3b82f6' }]; } performanceChartInstance = new Chart(ctx, chartConfig); }
            function addCustomEvidence(itemId) { const input = supervisoryApp.querySelector(`.new-evidence-input[data-id="${itemId}"]`); const value = input.value.trim(); const rating = parseInt(supervisoryApp.querySelector(`#score-${itemId}`).textContent); const content = evidenceBasedContent[itemId]; if (!value || !content) return; const targetList = (rating >= 4) ? (content.neg_evidences || []) : content.evidences; if (rating >= 4 && !content.neg_evidences) { content.neg_evidences = []; } const listToPush = (rating >= 4) ? content.neg_evidences : content.evidences; if (!listToPush.includes(value)) { listToPush.push(value); } input.value = ''; openEvidencePanel(itemId); const checkboxes = supervisoryApp.querySelectorAll(`#evidence-list-${itemId} .evidence-checkbox`); checkboxes.forEach(cb => { if (cb.value === value) { cb.checked = true; } }); updateDescriptionFromPanel(itemId); }
            function deleteCustomEvidence(itemId, value) { const rating = parseInt(supervisoryApp.querySelector(`#score-${itemId}`).textContent); const content = evidenceBasedContent[itemId]; if (!content) return; const evidenceList = (rating >= 4) ? content.neg_evidences : content.evidences; if (evidenceList) { const index = evidenceList.indexOf(value); if (index > -1) { evidenceList.splice(index, 1); openEvidencePanel(itemId); updateDescriptionFromPanel(itemId); } } }

            // Supervisory Listeners Init
            supervisoryApp.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => toggleView(tab.dataset.view)));
            supervisoryApp.querySelector('#evaluationForm').addEventListener('click', e => { if (e.target.matches('.rating-btn')) updateScore(e.target.closest('.item-card').id.split('-')[1], e.target.dataset.score, true); if (e.target.closest('.mic-btn')) startDictation(e.target.closest('.mic-btn').previousElementSibling.id, e.target.closest('.mic-btn')); if (e.target.closest('.edit-evidence-btn')) { const itemId = e.target.closest('.edit-evidence-btn').dataset.id; openEvidencePanel(itemId); } if (e.target.matches('.close-evidence-panel')) { e.target.closest('.evidence-panel').classList.add('hidden'); } if (e.target.closest('.add-evidence-btn')) { const btn = e.target.closest('.add-evidence-btn'); addCustomEvidence(btn.dataset.id); } if (e.target.closest('.delete-evidence-btn')) { const btn = e.target.closest('.delete-evidence-btn'); deleteCustomEvidence(btn.dataset.itemId, btn.dataset.value); } });
            supervisoryApp.querySelector('#evaluationForm').addEventListener('change', e => { if (e.target.matches('.evidence-checkbox')) { const itemId = e.target.dataset.itemId; updateDescriptionFromPanel(itemId); } });
            supervisoryApp.querySelector('#evaluationForm').addEventListener('keypress', e => { if (e.target.matches('.new-evidence-input') && e.key === 'Enter') { e.preventDefault(); addCustomEvidence(e.target.dataset.id); } });
            document.getElementById('savePermanentReportBtn').addEventListener('click', savePermanentReport);
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            document.getElementById('printOfficialReportBtn').addEventListener('click', printOfficialReport);
            document.getElementById('exportToWordBtn').addEventListener('click', exportToWord);
            document.getElementById('showResetConfirmationBtn').addEventListener('click', () => showConfirmationModal('إعادة تعيين', 'هل أنت متأكد؟', performReset));
            document.getElementById('updateDashboardViewBtn').addEventListener('click', updateDashboardView);
            supervisoryApp.querySelector('#reportSection').addEventListener('click', e => { if(e.target.closest('.copy-btn')) copyReportContent(e.target.closest('.copy-btn').dataset.target); });
            supervisoryApp.querySelector('#saved-reports-list').addEventListener('click', e => { if(e.target.dataset.key) { if(e.target.classList.contains('load-btn')) loadPermanentReport(e.target.dataset.key); if(e.target.classList.contains('delete-btn')) deletePermanentReport(e.target.dataset.key); } });
            supervisoryApp.querySelector('#filter-reports-input').addEventListener('input', renderSavedReports);
            generateEvaluationForm();
            supervisoryApp.querySelector('#visitDate').value = new Date().toISOString().split('T')[0];
            toggleView('form-view');
        }

        // --- SCHOOL VISITS APP CODE (Fully Implemented) ---
        function initializeSchoolApp() {
            let visitTypesData = {};
            // Classroom Visits State
            let classroomVisits = [];
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = SpeechRecognition ? new SpeechRecognition() : null;
            if (recognition) {
                recognition.continuous = false;
                recognition.lang = 'ar-SA';
            }

            const defaultVisitTypesData = {
                'supervisory': {
                    name: 'زيارة إشرافية',
                    objectives: [
                        'الالتقاء بالفاضل مدير المدرسة ومعلمي مادة الرياضة المدرسية',
                        'حضور الطابور المدرسي والاطلاع على إجراءات التنظيم والانضباط',
                        'متابعة تنفيذ خطة المنهاج والاطلاع على سجلات المتابعة الخاصة بالزي والمشاركة',
                        'حضور مواقف صفية مع معلمي المادة وإجراء المداولة الإشرافية',
                        'متابعة التحضير في منصة «نور»'
                    ]
                },
                'exploratory': {
                    name: 'زيارة استطلاعية',
                    objectives: [
                        'متابعة انتظام الهيئات التدريسية والإدارية',
                        'متابعة نظافة المبنى المدرسي والمرافق',
                        'متابعة توفر الكتب الدراسية والأثاث',
                        'متابعة تفعيل طابور الصباح',
                        'الوقوف على التحديات التي تواجه المدرسة'
                    ]
                },
                'technical': {
                    name: 'زيارة فنية',
                    objectives: [
                        'متابعة أداء المعلمين في الغرف الصفية',
                        'متابعة خطط المعلمين وسجلاتهم',
                        'متابعة مستوى التحصيل الدراسي للطلبة',
                        'متابعة تفعيل المختبرات ومصادر التعلم'
                    ]
                },
                'admin': {
                    name: 'زيارة إدارية',
                    objectives: [
                        'متابعة السجلات الإدارية والمالية',
                        'متابعة تنفيذ اللوائح والأنظمة',
                        'متابعة خطة المبنى المدرسي والصيانة'
                    ]
                }
            };

            const dashboardView = document.getElementById('schoolDashboardView');
            const formView = document.getElementById('schoolFormView');
            const reportsListContainer = document.getElementById('reportsListContainer');
            const visitTypeSelect = document.getElementById('visitTypeSelect');
            const objectivesContainer = document.getElementById('objectivesContainer');
            const reportForm = document.getElementById('reportForm');
            const manageTypesModal = document.getElementById('manageTypesModal');
            const addEditTypeModal = document.getElementById('addEditTypeModal');
            const visitTypesList = document.getElementById('visitTypesList');
            const addEditTypeForm = document.getElementById('addEditTypeForm');
            const previewContainer = document.getElementById('reportPreviewContainer');
            const classroomVisitsList = document.getElementById('classroomVisitsList');

            function loadVisitTypes() {
                const storedTypes = localStorage.getItem('school_visit_types');
                if (storedTypes) { visitTypesData = JSON.parse(storedTypes); } 
                else { visitTypesData = defaultVisitTypesData; localStorage.setItem('school_visit_types', JSON.stringify(visitTypesData)); }
                populateVisitTypeDropdown();
                renderVisitTypesList();
            }

            function populateVisitTypeDropdown() {
                visitTypeSelect.innerHTML = '<option value="" disabled selected>اختر نوع الزيارة</option>';
                Object.keys(visitTypesData).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = visitTypesData[key].name;
                    visitTypeSelect.appendChild(opt);
                });
            }

            function renderObjectives(typeKey) {
                objectivesContainer.innerHTML = '';
                const typeData = visitTypesData[typeKey];
                if (typeData && typeData.objectives) {
                    typeData.objectives.forEach((obj, index) => {
                        const div = document.createElement('div');
                        div.className = 'flex items-start gap-2 p-2 hover:bg-slate-100 rounded-lg';
                        div.innerHTML = `
                            <input type="checkbox" name="objectives" value="${obj}" id="obj-${index}" class="mt-1 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="obj-${index}" class="text-sm font-medium text-gray-900 cursor-pointer select-none">${obj}</label>
                        `;
                        objectivesContainer.appendChild(div);
                    });
                }
            }

            function renderClassroomVisits() {
                classroomVisitsList.innerHTML = '';
                if (classroomVisits.length === 0) {
                    classroomVisitsList.innerHTML = '<p class="text-xs text-slate-400 italic p-2">لم تتم إضافة أي مواقف صفية بعد.</p>';
                    return;
                }
                
                classroomVisits.forEach((visit, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-indigo-50 p-2 rounded-lg text-sm';
                    div.innerHTML = `
                        <div class="flex-grow">
                            <span class="font-bold text-indigo-700">${visit.teacher}</span> 
                            <span class="text-slate-500 mx-1">|</span> 
                            <span class="text-slate-600">الصف ${visit.grade}</span>
                            <span class="text-slate-500 mx-1">|</span>
                            <span class="text-slate-600">الحصة ${visit.period}</span>
                            <span class="text-slate-500 mx-1">|</span>
                            <span class="text-slate-600">${visit.subject}</span>
                            <span class="text-slate-500 mx-1">|</span>
                            <span class="font-semibold text-slate-700">${visit.rating}</span>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700 delete-visit-btn p-1" data-index="${index}">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    `;
                    classroomVisitsList.appendChild(div);
                });

                document.querySelectorAll('.delete-visit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = e.currentTarget.dataset.index;
                        classroomVisits.splice(idx, 1);
                        renderClassroomVisits();
                    });
                });
            }

            function addClassroomVisit() {
                const teacher = document.getElementById('cvTeacher').value.trim();
                const grade = document.getElementById('cvGrade').value.trim();
                const period = document.getElementById('cvPeriod').value.trim();
                const subject = document.getElementById('cvSubject').value.trim();
                const rating = document.getElementById('cvRating').value;

                if (!teacher || !grade || !subject || !period) {
                    showToast('يرجى تعبئة جميع بيانات الموقف الصفي', 'error');
                    return;
                }

                classroomVisits.push({ teacher, grade, period, subject, rating });
                renderClassroomVisits();
                
                document.getElementById('cvTeacher').value = '';
                document.getElementById('cvGrade').value = '';
                document.getElementById('cvPeriod').value = '';
                document.getElementById('cvSubject').value = '';
                showToast('تمت إضافة الموقف الصفي');
            }

            function renderReportsList() {
                reportsListContainer.innerHTML = '';
                const reports = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('school_report_')) {
                        reports.push({ key, ...JSON.parse(localStorage.getItem(key)) });
                    }
                }
                reports.sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate));

                if (reports.length === 0) {
                    reportsListContainer.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400"><i class="fa-solid fa-folder-open text-4xl mb-2"></i><p>لا توجد تقارير محفوظة.</p></div>`;
                    return;
                }

                reports.forEach(report => {
                    const typeName = visitTypesData[report.visitType]?.name || 'غير محدد';
                    const card = document.createElement('div');
                    card.className = 'bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow flex flex-col';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-bold text-lg text-slate-800">${report.schoolName}</h3>
                            <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-blue-200">${typeName}</span>
                        </div>
                        <div class="text-sm text-slate-500 mb-4 space-y-1">
                            <div class="flex items-center"><i class="fa-regular fa-calendar ml-2 w-4"></i> ${report.visitDate}</div>
                            <div class="flex items-center"><i class="fa-solid fa-check-double ml-2 w-4"></i> ${report.objectives?.length || 0} أهداف محققة</div>
                        </div>
                        <div class="mt-auto flex gap-2 pt-3 border-t border-slate-100">
                            <button class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 rounded-lg text-sm font-medium transition-colors view-report-btn" data-key="${report.key}">عرض</button>
                            <button class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 py-2 rounded-lg text-sm font-medium transition-colors edit-report-btn" data-key="${report.key}">تعديل</button>
                            <button class="flex-1 bg-red-50 hover:bg-red-100 text-red-600 py-2 rounded-lg text-sm font-medium transition-colors delete-report-btn" data-key="${report.key}">حذف</button>
                        </div>
                    `;
                    reportsListContainer.appendChild(card);
                });
            }

            function generateSmartVisitorOpinion() {
                const objectives = [];
                reportForm.querySelectorAll('input[name="objectives"]:checked').forEach(cb => objectives.push(cb.value));
                
                if (objectives.length === 0 && classroomVisits.length === 0) {
                    showToast('يرجى تحديد الأهداف أو إضافة مواقف صفية أولاً', 'error');
                    return;
                }

                let opinionText = "";
                let counter = 1;
                
                objectives.forEach(obj => {
                    let text = obj.trim();
                    if (text.startsWith("الالتقاء")) text = text.replace("الالتقاء", "تم الالتقاء");
                    else if (text.startsWith("حضور")) text = text.replace("حضور", "تم حضور");
                    else if (text.startsWith("متابعة")) text = text.replace("متابعة", "تمت متابعة");
                    else if (text.startsWith("شرح")) text = text.replace("شرح", "تم شرح");
                    else if (text.startsWith("الاطلاع")) text = text.replace("الاطلاع", "تم الاطلاع");
                    else text = "تم " + text;

                    if (text.includes("الطابور المدرسي")) text += "، وقد لوحظ أن الهتاف كان واضحًا وبصوت عالٍ، كما كان انصراف الطلاب منظمًا وسلسًا.";
                    if (text.includes("خطة المنهاج")) text += "، والاطلاع على سجلات المتابعة (الزي والمشاركة).";
                    if (text.includes("التوصيات السابقة")) text += "، وتبين التزام المعلمين بما ورد فيها وتحسن مستوى الأداء العام.";
                    opinionText += counter + "- " + text + "\n";
                    counter++;
                });

                if (classroomVisits.length > 0) {
                    opinionText += counter + "- تم حضور مواقف صفية وإجراء المداولة الإشرافية، وذلك على النحو الآتي:\n";
                    classroomVisits.forEach((cv, idx) => {
                        opinionText += `   • الحصة (${cv.period}): الأستاذ ${cv.teacher} – درس ${cv.subject} – الصف ${cv.grade}، وكان مستوى الأداء ${cv.rating}.\n`;
                    });
                } else if (opinionText.includes("مواقف صفية")) {
                     opinionText += " (لم يتم إدراج تفاصيل الحصص).\n";
                }

                document.getElementById('visitorOpinion').value = opinionText.trim();
                showToast('تم توليد الرأي الذكي بنجاح');
            }

            function startSchoolDictation(targetId, btn) {
                if (!recognition) { showToast('المتصفح لا يدعم الإملاء الصوتي', 'error'); return; }
                const target = document.getElementById(targetId);
                btn.classList.add('recording');
                recognition.start();
                recognition.onresult = (event) => { 
                    const current = target.value;
                    const newText = event.results[0][0].transcript;
                    target.value = current + (current.length > 0 ? ' ' : '') + newText;
                };
                recognition.onspeechend = () => recognition.stop();
                recognition.onend = () => { btn.classList.remove('recording'); };
            }

            function saveReport(e) {
                e.preventDefault();
                const formData = new FormData(reportForm);
                const objectives = [];
                reportForm.querySelectorAll('input[name="objectives"]:checked').forEach(cb => objectives.push(cb.value));
                
                const reportId = document.getElementById('reportId').value || `school_report_${Date.now()}`;
                const visitType = visitTypeSelect.value;
                
                if (!visitType) { showToast('يرجى اختيار نوع الزيارة', 'error'); return; }

                const reportData = {
                    id: reportId,
                    schoolName: formData.get('schoolName'),
                    visitDate: formData.get('visitDate'),
                    visitType: visitType,
                    objectives: objectives,
                    classroomVisits: classroomVisits, // Save this data structure
                    visitorOpinion: document.getElementById('visitorOpinion').value,
                    recommendations: document.getElementById('recommendations').value
                };

                localStorage.setItem(reportId, JSON.stringify(reportData));
                showToast('تم حفظ التقرير بنجاح');
                showDashboard();
            }

            function editReport(key) {
                const report = JSON.parse(localStorage.getItem(key));
                if (!report) return;

                document.getElementById('reportId').value = key;
                document.getElementById('schoolName').value = report.schoolName;
                document.getElementById('schoolVisitDate').value = report.visitDate;
                visitTypeSelect.value = report.visitType;
                document.getElementById('visitorOpinion').value = report.visitorOpinion || '';
                document.getElementById('recommendations').value = report.recommendations || '';
                
                classroomVisits = report.classroomVisits || [];
                renderClassroomVisits();

                renderObjectives(report.visitType);

                if (report.objectives) {
                    setTimeout(() => {
                        report.objectives.forEach(objVal => {
                            const cb = Array.from(document.querySelectorAll('input[name="objectives"]')).find(el => el.value === objVal);
                            if (cb) cb.checked = true;
                        });
                    }, 0);
                }

                showForm();
            }

            function viewReport(key) {
                const report = JSON.parse(localStorage.getItem(key));
                if (!report) return;
                generatePreview(report);
                formView.classList.add('hidden');
                dashboardView.classList.add('hidden');
                previewContainer.classList.remove('hidden');
            }

            function generatePreview(report) {
                const typeName = visitTypesData[report.visitType]?.name || 'زيارة مدرسية';
                let objectivesHtml = '<ol class="list-decimal list-inside space-y-1 text-slate-700 mt-2">';
                if(report.objectives && report.objectives.length > 0) {
                    report.objectives.forEach(obj => objectivesHtml += `<li>${obj}</li>`);
                } else {
                    objectivesHtml += '<li class="text-slate-400 italic">لا توجد أهداف محددة.</li>';
                }
                objectivesHtml += '</ol>';
                
                const content = `
                    <div class="text-center mb-8 border-b pb-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">تقرير زيارة مدرسية</h2>
                        <span class="inline-block bg-slate-100 rounded-full px-4 py-1 text-sm font-semibold text-slate-600">${typeName}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-6 mb-8 bg-slate-50 p-6 rounded-xl border border-slate-100">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">المدرسة</p>
                            <p class="font-bold text-lg text-slate-800">${report.schoolName}</p>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">التاريخ</p>
                            <p class="font-bold text-lg text-slate-800">${report.visitDate}</p>
                        </div>
                    </div>
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-slate-800 mb-3 border-r-4 border-blue-500 pr-3">أولاً: أهداف الزيارة</h3>
                        <div class="bg-white border border-slate-200 rounded-xl p-5">${objectivesHtml}</div>
                    </div>
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-slate-800 mb-3 border-r-4 border-purple-500 pr-3">ثانياً: رأي الزائر</h3>
                        <div class="bg-white border border-slate-200 rounded-xl p-5 min-h-[100px] whitespace-pre-wrap">${report.visitorOpinion || 'لا يوجد رأي للزائر.'}</div>
                    </div>
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-slate-800 mb-3 border-r-4 border-green-500 pr-3">ثالثاً: التوصيات والملاحظات</h3>
                        <div class="bg-white border border-slate-200 rounded-xl p-5 min-h-[100px] whitespace-pre-wrap">${report.recommendations || 'لا توجد توصيات.'}</div>
                    </div>
                `;
                document.getElementById('reportContent').innerHTML = content;
                
                document.getElementById('backToFormBtn').onclick = () => {
                    document.getElementById('reportId').value = report.id;
                    if(document.getElementById('reportId').value) editReport(document.getElementById('reportId').value);
                    else {
                        document.getElementById('schoolName').value = report.schoolName;
                        document.getElementById('schoolVisitDate').value = report.visitDate;
                        visitTypeSelect.value = report.visitType;
                        document.getElementById('visitorOpinion').value = report.visitorOpinion;
                        document.getElementById('recommendations').value = report.recommendations;
                        classroomVisits = report.classroomVisits || [];
                        renderClassroomVisits();
                        renderObjectives(report.visitType);
                        setTimeout(() => { 
                            if(report.objectives) report.objectives.forEach(val => { const cb = Array.from(document.querySelectorAll('input[name="objectives"]')).find(el => el.value === val); if(cb) cb.checked = true; });
                        }, 0);
                        showForm();
                    }
                };
            }

            function deleteReport(key) {
                if(confirm('هل أنت متأكد من حذف هذا التقرير؟')) {
                    localStorage.removeItem(key);
                    renderReportsList();
                    showToast('تم الحذف بنجاح');
                }
            }

            function renderVisitTypesList() {
                visitTypesList.innerHTML = '';
                Object.keys(visitTypesData).forEach(key => {
                    const type = visitTypesData[key];
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-slate-50 rounded-lg border border-slate-200';
                    
                    const objectivesList = type.objectives.map(obj => `<li class="text-xs text-slate-600 truncate">• ${obj}</li>`).join('');
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-slate-700">${type.name}</h4>
                            <div class="flex gap-2">
                                <button class="text-blue-500 hover:text-blue-700 edit-type-btn p-1" data-key="${key}">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-700 delete-type-btn p-1" data-key="${key}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <ul class="pl-2 space-y-1 max-h-20 overflow-y-auto custom-scrollbar">
                            ${objectivesList}
                        </ul>
                    `;
                    visitTypesList.appendChild(div);
                });
            }

            function showDashboard() {
                dashboardView.classList.remove('hidden');
                formView.classList.add('hidden');
                previewContainer.classList.add('hidden');
                renderReportsList();
            }
            function showForm() {
                dashboardView.classList.add('hidden');
                formView.classList.remove('hidden');
                previewContainer.classList.add('hidden');
            }

            document.getElementById('addNewReportBtn').addEventListener('click', () => {
                reportForm.reset();
                document.getElementById('reportId').value = '';
                document.getElementById('schoolVisitDate').value = new Date().toISOString().split('T')[0];
                objectivesContainer.innerHTML = '';
                classroomVisits = [];
                renderClassroomVisits();
                showForm();
            });

            document.getElementById('generateVisitorOpinionBtn').addEventListener('click', generateSmartVisitorOpinion);
            document.getElementById('addClassroomVisitBtn').addEventListener('click', addClassroomVisit);
            
            document.querySelector('#schoolFormView').addEventListener('click', (e) => {
                 if (e.target.closest('.mic-btn')) {
                     const btn = e.target.closest('.mic-btn');
                     const targetId = btn.previousElementSibling.id;
                     startSchoolDictation(targetId, btn);
                 }
            });

            document.getElementById('quickRecs').addEventListener('change', (e) => {
                const val = e.target.value;
                if(val) {
                    const textarea = document.getElementById('recommendations');
                    textarea.value += (textarea.value.length > 0 ? '\n- ' : '- ') + val;
                    e.target.value = '';
                }
            });

            document.getElementById('copyObjectivesBtn').addEventListener('click', () => {
                const checked = Array.from(document.querySelectorAll('#objectivesContainer input:checked')).map((cb, index) => (index + 1) + '- ' + cb.value).join('\n');
                copyText(checked);
            });
            document.getElementById('copyVisitorOpinionBtn').addEventListener('click', () => {
                copyText(document.getElementById('visitorOpinion').value);
            });
            document.getElementById('copyRecommendationsBtn').addEventListener('click', () => {
                copyText(document.getElementById('recommendations').value);
            });

            document.getElementById('backToDashboardBtn').addEventListener('click', showDashboard);
            document.getElementById('backToFormBtn').addEventListener('click', showForm);

            visitTypeSelect.addEventListener('change', (e) => {
                renderObjectives(e.target.value);
            });

            reportForm.addEventListener('submit', saveReport);

            document.getElementById('previewReportBtn').addEventListener('click', () => {
                const formData = new FormData(reportForm);
                const objectives = [];
                reportForm.querySelectorAll('input[name="objectives"]:checked').forEach(cb => objectives.push(cb.value));
                
                const tempReport = {
                    id: document.getElementById('reportId').value,
                    schoolName: formData.get('schoolName'),
                    visitDate: formData.get('visitDate'),
                    visitType: visitTypeSelect.value,
                    objectives: objectives,
                    classroomVisits: classroomVisits,
                    visitorOpinion: document.getElementById('visitorOpinion').value,
                    recommendations: document.getElementById('recommendations').value
                };
                
                if(!tempReport.visitType) { showToast('اختر نوع الزيارة أولاً', 'error'); return; }
                
                generatePreview(tempReport);
                formView.classList.add('hidden');
                previewContainer.classList.remove('hidden');
            });

            reportsListContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-report-btn')) deleteReport(e.target.dataset.key);
                if (e.target.classList.contains('edit-report-btn')) editReport(e.target.dataset.key);
                if (e.target.classList.contains('view-report-btn')) viewReport(e.target.dataset.key);
            });

            document.getElementById('manageVisitTypesBtn').addEventListener('click', () => {
                renderVisitTypesList();
                manageTypesModal.classList.remove('hidden');
            });
            document.getElementById('closeManageModalBtn').addEventListener('click', () => manageTypesModal.classList.add('hidden'));
            
            visitTypesList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-type-btn');
                const editBtn = e.target.closest('.edit-type-btn');

                if (deleteBtn) {
                    const key = deleteBtn.dataset.key;
                    if (confirm('هل أنت متأكد من حذف هذا النوع؟')) {
                        delete visitTypesData[key];
                        localStorage.setItem('school_visit_types', JSON.stringify(visitTypesData));
                        renderVisitTypesList();
                        populateVisitTypeDropdown();
                        showToast('تم حذف النوع بنجاح');
                    }
                }

                if (editBtn) {
                    const key = editBtn.dataset.key;
                    const type = visitTypesData[key];
                    
                    document.getElementById('typeName').value = type.name;
                    document.getElementById('typeObjectives').value = type.objectives.join('\n');
                    document.getElementById('editTypeKey').value = key;
                    document.getElementById('addEditModalTitle').textContent = 'تعديل نوع زيارة';
                    
                    manageTypesModal.classList.add('hidden');
                    addEditTypeModal.classList.remove('hidden');
                }
            });

            document.getElementById('openAddTypeModalBtn').addEventListener('click', () => {
                addEditTypeForm.reset();
                document.getElementById('editTypeKey').value = '';
                document.getElementById('addEditModalTitle').textContent = 'إضافة نوع زيارة';
                manageTypesModal.classList.add('hidden');
                addEditTypeModal.classList.remove('hidden');
            });
            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                addEditTypeModal.classList.add('hidden');
                manageTypesModal.classList.remove('hidden');
            });

            addEditTypeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('typeName').value;
                const objectives = document.getElementById('typeObjectives').value.split('\n').filter(o => o.trim() !== '');
                let key = document.getElementById('editTypeKey').value;
                
                if (objectives.length === 0) {
                    showToast('يرجى إضافة هدف واحد على الأقل', 'error');
                    return;
                }

                if (!key) {
                    key = 'custom_' + Date.now();
                }
                
                visitTypesData[key] = { name, objectives };
                localStorage.setItem('school_visit_types', JSON.stringify(visitTypesData));
                
                renderVisitTypesList();
                populateVisitTypeDropdown();
                addEditTypeModal.classList.add('hidden');
                manageTypesModal.classList.remove('hidden');
                showToast('تم حفظ النوع بنجاح');
            });

            loadVisitTypes();
            renderReportsList();
        }

        // --- GLOBAL INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeSupervisoryApp();
            initializeSchoolApp();
            showView(welcomeView);
        });

    </script>
</body>
</html>
