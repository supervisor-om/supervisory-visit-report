<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقرير زيارة مدرسية</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Font (Cairo) from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to use the Cairo font and for print/modal transitions */
        body {
            font-family: 'Cairo', sans-serif;
        }
        @media print {
            .no-print { display: none !important; }
            body * {
                visibility: hidden;
            }
            #reportPreviewContainer, #reportPreviewContainer * {
                visibility: visible;
            }
            #reportPreviewContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
            }
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Dashboard View -->
    <div id="dashboardView" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg hidden">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b pb-4 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">سجل التقارير</h1>
                <p class="text-gray-500 mt-2">عرض وإدارة جميع تقارير الزيارات المحفوظة</p>
            </div>
             <div class="flex items-center gap-4 w-full sm:w-auto">
                <div class="relative flex-grow">
                     <input type="text" id="searchInput" placeholder="ابحث عن تقرير..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 pr-10">
                     <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                     </div>
                </div>
                <button id="addNewReportBtn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-6 py-3 whitespace-nowrap transition-colors">
                    + تقرير جديد
                </button>
            </div>
        </header>
        <div class="flex justify-end gap-2 my-4 no-print">
            <button id="exportDataBtn" class="text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg px-4 py-2 hover:bg-gray-100 transition-colors">تصدير البيانات</button>
            <label for="importDataInput" class="cursor-pointer text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg px-4 py-2 hover:bg-gray-100 transition-colors">استيراد البيانات</label>
            <input type="file" id="importDataInput" class="hidden" accept=".json">
        </div>
        <div id="reportsListContainer">
            <!-- Reports list will be dynamically populated here -->
        </div>
    </div>


    <!-- Form View -->
    <div id="formView" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg hidden no-print">
        <header class="text-center mb-8">
            <h1 id="formTitle" class="text-3xl font-bold text-gray-800">إنشاء تقرير زيارة إشرافية</h1>
            <p class="text-gray-500 mt-2">نموذج لتوثيق الزيارات الإشرافية للمعلمين</p>
        </header>

        <form id="reportForm" class="space-y-8">
             <input type="hidden" id="reportId" value="">

            <!-- Basic Info Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">معلومات أساسية</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <label for="schoolName" class="block mb-2 text-sm font-medium text-gray-900">اسم المدرسة</label>
                        <select id="schoolName" name="schoolName" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <option value="" selected disabled>اختر المدرسة</option>
                            <option value="أبو القاسم الزهراوي">أبو القاسم الزهراوي</option>
                            <option value="أبو أيوب الحضرمي">أبو أيوب الحضرمي</option>
                            <option value="أبو تمام">أبو تمام</option>
                            <option value="أحمد بن النعمان">أحمد بن النعمان</option>
                            <option value="الشيخ سالم السيابي">الشيخ سالم السيابي</option>
                            <option value="الشيخ سعيد الكندي مسائي">الشيخ سعيد الكندي مسائي</option>
                            <option value="الشيخ ناصر الخروصي">الشيخ ناصر الخروصي</option>
                            <option value="جنادة الازدى (موسى سابقا)">جنادة الازدى (موسى سابقا)</option>
                            <option value="حفص بن راشد">حفص بن راشد</option>
                            <option value="خريس الحبوس">خريس الحبوس</option>
                            <option value="سهيل بن عمرو العامري">سهيل بن عمرو العامري</option>
                            <option value="كعب بن زيد">كعب بن زيد</option>
                            <option value="يزيد الطائي">يزيد الطائي</option>
                            <option value="اجيال الثقافة">اجيال الثقافة</option>
                            <option value="اجيال الفردوس - الحيل">اجيال الفردوس - الحيل</option>
                            <option value="البيان">البيان</option>
                            <option value="الجيل المبدع">الجيل المبدع</option>
                            <option value="الريادة">الريادة</option>
                            <option value="السراج">السراج</option>
                            <option value="الصفوة المعبيلة">الصفوة المعبيلة</option>
                            <option value="المجد">المجد</option>
                            <option value="انس بن مالك (المنار سابقا)">انس بن مالك (المنار سابقا)</option>
                            <option value="جيفر بن الجلندي">جيفر بن الجلندي</option>
                            <option value="ضياء المستقبل">ضياء المستقبل</option>
                            <option value="مشاعل مسقط سور الحديد">مشاعل مسقط سور الحديد</option>
                            <option value="منابع التفوق">منابع التفوق</option>
                        </select>
                    </div>
                    <div id="teacherContainer" class="hidden">
                        <label for="teacherName" class="block mb-2 text-sm font-medium text-gray-900">اسم المعلم/ة</label>
                        <select id="teacherName" name="teacherName" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <!-- Teacher options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="visitDate" class="block mb-2 text-sm font-medium text-gray-900">تاريخ الزيارة</label>
                        <input type="date" id="visitDate" name="visitDate" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                </div>
            </fieldset>
            
            <!-- Visit Type Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">نوع الزيارة</legend>
                <div class="flex items-center gap-4 mt-2">
                    <select id="visitTypeSelect" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <!-- Options will be dynamically generated by JS -->
                    </select>
                    <button type="button" id="manageVisitTypesBtn" class="p-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg border hover:bg-gray-200 transition-colors whitespace-nowrap">
                        ⚙️ إدارة الأنواع
                    </button>
                </div>
            </fieldset>

            <!-- Visit Objectives Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <div class="flex justify-between items-center mb-4">
                     <legend class="text-lg font-semibold text-gray-700 px-2">أهداف الزيارة</legend>
                     <button type="button" id="selectAllObjectivesBtn" class="text-sm font-medium text-blue-600 hover:underline">اختيار الكل</button>
                </div>
                <div id="objectivesContainer" class="space-y-4">
                    <!-- Checkboxes will be dynamically generated by JS -->
                </div>
            </fieldset>

            <!-- Visitor's Opinion Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">رأي الزائر</legend>
                 <p class="text-sm text-gray-500 mb-4">اكتب ملاحظاتك لكل هدف من الأهداف المحددة أعلاه.</p>
                <div id="opinionsContainer" class="space-y-6">
                    <!-- Opinion textareas will be generated here -->
                </div>
            </fieldset>

            <!-- Recommendations Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">التوصيات</legend>
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-2 gap-4 flex-wrap">
                        <label for="recommendations" class="block text-sm font-medium text-gray-900 sr-only">التوصيات</label>
                        <button type="button" id="generate-recommendations-btn" class="flex items-center text-sm text-blue-600 font-semibold hover:text-blue-800 transition-colors">
                            📋 توليد التوصيات
                        </button>
                    </div>
                    <textarea id="recommendations" name="recommendations" rows="5" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="اكتب التوصيات والملاحظات النهائية هنا أو استخدم زر التوليد التلقائي..."></textarea>
                </div>
            </fieldset>

            <!-- Attachments Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">المرفقات</legend>
                <div class="mt-4">
                    <label for="attachmentsInput" class="block mb-2 text-sm font-medium text-gray-900">اختر ملفات (صور، مستندات...)</label>
                    <input type="file" id="attachmentsInput" multiple class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                    <div id="attachmentsList" class="mt-4 space-y-2">
                        <!-- Attached files will be listed here -->
                    </div>
                </div>
            </fieldset>
            
            <!-- Action Buttons -->
            <div class="flex justify-end pt-4 gap-4">
                 <button type="button" id="backToDashboardBtn" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">إلغاء</button>
                <button type="button" id="prepareReportBtn" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">معاينة التقرير</button>
                <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">حفظ التقرير</button>
            </div>

        </form>
    </div>

    <!-- Report Preview Section -->
    <div id="reportPreviewContainer" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg hidden">
         <div id="reportContent" class="prose max-w-none prose-p:my-2 prose-ol:my-2 prose-h3:my-4">
            <!-- Generated report will be injected here -->
         </div>
         <div class="flex justify-end pt-6 mt-6 border-t no-print gap-4 flex-wrap">
            <button id="backToBtn" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">رجوع</button>
            <button id="copyAllBtn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">نسخ الكل</button>
            <button onclick="window.print()" class="text-white bg-gray-800 hover:bg-gray-900 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">طباعة</button>
       </div>
    </div>
    
    <!-- Modals -->
    <div id="manageTypesModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-backdrop">
        <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white modal-content">
            <div class="flex justify-between items-center border-b pb-3">
                 <h3 class="text-lg leading-6 font-medium text-gray-900">إدارة أنواع الزيارات</h3>
                 <button id="closeManageModalBtn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                 </button>
            </div>
            <div class="mt-4">
                <div id="visitTypesList" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                <div class="mt-6 pt-4 border-t">
                    <button id="addNewTypeBtn" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">إضافة نوع زيارة جديد</button>
                </div>
            </div>
        </div>
    </div>
    <div id="addEditTypeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-backdrop">
        <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white modal-content">
            <h3 id="addEditModalTitle" class="text-lg leading-6 font-medium text-gray-900 mb-4"></h3>
            <form id="addEditTypeForm">
                <input type="hidden" id="editTypeKey" value="">
                <div>
                    <label for="typeName" class="block mb-2 text-sm font-medium text-gray-900">اسم نوع الزيارة</label>
                    <input type="text" id="typeName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mt-4">
                    <label for="typeObjectives" class="block mb-2 text-sm font-medium text-gray-900">الأهداف (كل هدف في سطر)</label>
                    <textarea id="typeObjectives" rows="8" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                <div class="items-center px-4 py-3 gap-3 flex justify-end mt-4 border-t pt-4">
                    <button id="saveTypeBtn" type="submit" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-700">حفظ</button>
                    <button id="cancelEditBtn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-backdrop">
        <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white modal-content">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">تأكيد الإجراء</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirmationMessage" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3 gap-3 flex justify-center">
                    <button id="confirmActionBtn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700">تأكيد</button>
                    <button id="cancelActionBtn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- Your web app's Firebase configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyAEQsh6E351S1isxL4CFFGIpGSU2pVP5sc",
                authDomain: "my-report-9b33f.firebaseapp.com",
                projectId: "my-report-9b33f",
                storageBucket: "my-report-9b33f.firebasestorage.app",
                messagingSenderId: "176527739587",
                appId: "1:176527739587:web:7a524a73a2355b5a503076",
                measurementId: "G-C24VPXRD1R"
            };

            // --- Initialize Firebase ---
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            let userId; // Will be set on auth state change


            // --- DATABASE (Original Data Structure) ---
            const schoolTeacherData = {
                "أبو القاسم الزهراوي": { teachers: ["أيوب سلطان ناصر الوردي", "يحيى عبدالله اليوسفي"], gender: "male" },
                "أبو أيوب الحضرمي": { teachers: ["عبدالله بن سعيد بن عامر الفائدي"], gender: "male" },
                "أبو تمام": { teachers: ["هاشم راشد سيف الهاشمي", "المعتصم بن عبدالله بن علي الفظيطي", "سعيد محمد المخيني"], gender: "male" },
                "أحمد بن النعمان": { teachers: ["طارق يوسف يسند", "سليمان بن سالم بن مبارك الرزيقي", "عمر بن سعيد بن عبيد الشنجي"], gender: "male" },
                "الشيخ سالم السيابي": { teachers: ["إبراهيم بن ناصر بن خميس البوسعيدي", "فهد محمد سعيد الخربوشي"], gender: "male" },
                "الشيخ سعيد الكندي مسائي": { teachers: ["محمد سعيد محاد العمري", "راشد بن سالم بن خلفان المشيفري"], gender: "male" },
                "الشيخ ناصر الخروصي": { teachers: ["عدنان حسين محاد تبوك"], gender: "male" },
                "جنادة الازدى (موسى سابقا)": { teachers: ["إبراهيم بن محمد بن حمود الراسبي", "محمد ثاني خلفان الصلطي", "منصور بن محمد بن جمعه", "اسامة بن سليمان الدهماني", "محمود حمد خلفان المحروقي"], gender: "male" },
                "حفص بن راشد": { teachers: ["سعود بن سيف بن ناصر الراسبي", "سليمان بن سيف بن سالم الوهيبي", "حميد بن حمد بن هديب السابعي", "عبدالحميد بن محمد بن عبدالرسول الزدجالي", "محمد بن احمد بن خالد الخضوري"], gender: "male" },
                "خريس الحبوس": { teachers: ["عبدالله فرج الحجري"], gender: "male" },
                "سهيل بن عمرو العامري": { teachers: ["راشد بن سالم بن خالد الرشيدي", "عمار بن علي بن صالح الحمادي", "محمد قاسم حمدان الناصري"], gender: "male" },
                "كعب بن زيد": { teachers: ["أحمد بن سليمان بن سالم الحسني", "يوسف بن عبدالله بن سيف اليوسفي"], gender: "male" },
                "يزيد الطائي": { teachers: [], gender: "male" },
                "البيان": { teachers: ["جيهان علي محمد احمد يوسف"], gender: "female" },
                "الجيل المبدع": { teachers: ["علياء عاطف سيد محمد"], gender: "female" },
                "الريادة": { teachers: ["اسماء سعد سعد ابراهيم سعد", "Hossam mohammed Zayid"], gender: "mixed" },
                "السراج": { teachers: ["عزاء بنت محمد بن حمود المالكي"], gender: "female" },
                "الصفوة المعبيلة": { teachers: ["رحمة محمد محمد شلقامي"], gender: "female" },
                "المجد": { teachers: ["آيه رضا عبد الفتاح العليمي حلاوه"], gender: "female" },
                "انس بن مالك (المنار سابقا)": { teachers: ["اسراء محمد حسين"], gender: "female" },
                "ضياء المستقبل": { teachers: ["علاء احمد وزيري"], gender: "female" },
                "مشاعل مسقط سور الحديد": { teachers: ["دينا اشرف حبيب"], gender: "female" },
                "منابع التفوق": { teachers: ["مها محمود السيد"], gender: "female" },
                "اجيال الثقافة": { teachers: [], gender: "female" },
                "اجيال الفردوس - الحيل": { teachers: [], gender: "female" },
                "جيفر بن الجلندي": { teachers: [], gender: "male" }
            };

            const defaultVisitTypesData = {
                'custom_exploratory': {
                    name: 'زيارة استطلاعية',
                    objectives_list: ["مقابلة مديرة المدرسة معلمةالرياضة المدرسية.","حضور الطابور المدرسي.","تحديث قاعدة بيانات المعلمة.","متابعة موافقات التعيين.","متابعة توفر الأدلة وكتاب الطالب وتحديثها.","متابعة توزيع الجدول ونصاب الحصص للمعلمة.","متابعة الملاعب وتخطيطها والأدوات الرياضية.","متابعة النشرات ووثائق التقويم ومناقشة مستجداتها.","متابعة المنهاج وسجلات المعلمة.","حضور حصة للمعلمة والمداولة الاشرافية."],
                    completedOpinions: ["تم مقابلة الفاضلة مديرة المدرسة ومعلمة الرياضة المدرسية.","تم حضور الطابور المدرسي وكان الهتاف بصوت عالي والانصراف منظم ومراسم رفع العلم صحيحة.","تم تحديث قاعدة بيانات المعلمة عبر الرابط.","تم متابعة موافقات التعيين والمعلمة على اقامة المدرسة.","تم متابعة توفر الأدلة وتحديثها وكانت محدثة.","تم متابعة توزيع الجدول المدرسي وكان متوافقًا مع الأنظمة.","تم متابعة الملاعب وتخطيطها والأدوات الرياضية وكانت متوفرة.","تم متابعة النشرات ووثائق التقويم ومناقشة مستجداتها.","تم متابعة المنهاج وسجلات المعلمة وكانت مكتملة وتم اعتماد خطط المعلمة الفصلية.","تم حضور موقف صفي للمعلمة وكان الأداء جيد جدا."],
                    incompleteOpinions: ["تم مقابلة الفاضلة مديرة المدرسة وبغياب معلمة الرياضة المدرسية.","تم حضور الطابور المدرسي وكان الهتاف بصوت منخفض والانصراف غير منظم وتلاحظ اخطاء في مراسم رفع العلم وتم توجيه المعلم المسؤول عن الكشافة بتدريب الكشافة على المراسم الصحيحة.","قاعدة بيانات المعلمة بحاجة إلى تحديث، وتم التنبيه على ضرورة استكمالها عبر الرابط.","","تم متابعة توفر الأدلة وتحديثها وكانت محدثة بصيغة (PDF).","تم متابعة توزيع الجدول المدرسي وتلاحظ وجود حصص موزعة في الجدول السابعة والثامنة وكذلك تفريغ المعلمة يوم الثلاثاء بدون عذر مقبول وتم توجيه ادارة المدرسة بتعديل ذلك والابتعاد عن الحصص الأخيرة.","تم متابعة الملاعب وتخطيطها والأدوات الرياضية وتلاحظ عدم وجود أدوات رياضية في المدرسة وتم توجيه إدارة المدرسة بتوفير الأدوات وتجديد تخطيط الملعب.","تم متابعة النشرات ووثائق التقويم ومناقشة مستجداتها ولوحظ عدم وصول النشرات الى المعلمين وتم ارسال النشرات والوثائق مرة اخرى الى المعلمين عبر الوتساب.","تم متابعة المنهاج وسجلات المعلمة وكانت غير مكتملة، وتم توجيه المعلمة لاستكمالها.","تعذر حضور حصة مع المعلمة."],
                    recommendations: ["متابعة التزام الهيئة التدريسية بالحضور.","متابعة تدريب الكشافة على مراسم رفع العلم الصحيحة وتحسين تنظيم انصراف الطلبة.","التأكيد على تحديث قاعدة بيانات المعلمة بشكل دوري.","ضرورة الإسراع في استكمال موافقات التعيين الرسمية.","التواصل مع الجهات المعنية لتوفير الكتب المدرسية الناقصة.","تغيير جدول المعلمة ليكون لديها حصة رياضة كل يوم، وتوزيع الحصص بحيث يتم الابتعاد عن الحصة السابعة والثامنة.","توفير الأدوات الرياضية حسب الكشف المرفق ونخص بالذكر (جهاز الوثب العالي مع المرتبة الخاصة به، الصندوق المقسم، المقعد السويدي، مرمى لكرة اليد عدد (2)، قوائم للسلة عدد (2)، شبك لكرة الطائرة) بالإضافة لباقي الأدوات في الكشف، وتجديد تخطيط الملعب.","التأكيد على وصول جميع النشرات والوثائق للمعلمين وتوثيق استلامهم لها.","متابعة استكمال سجلات المعلمة (التحضير+الزي والملاحظة+الخطة).","التنسيق المسبق مع المعلمة لحضور حصة دراسية."]
                },
                'supervisory_october': {
                    name: 'زيارة اشرافية (أكتوبر)',
                    objectives_list: ["الالتقاء بالفاضلة مديرة المدرسة ومعلمةالرياضة المدرسية.","حضور الطابور المدرسي.","متابعة تنفيذ خطة المنهاج والاطلاع على سجلات المتابعة (الزي والمشاركة).","حضور موقف صفي مع المعلمة والمداولة الاشرافية.","شرح اليه تنفيذ الحصة كتطبيقات تنافسية.","حث المعلمة على الاطلاع على زياراته الاشرافية والحرص على الالتزام بتنفيذ النشرات الخاصة بالمادة.","متابعة تنفيذ التوصيات السابقة."],
                    completedOpinions: ["تم الالتقاء بالفاضلة مديرة المدرسة ومعلمة الرياضة المدرسية.","تم حضور الطابور المدرسي وكان منظماً.","تم متابعة تنفيذ خطة المنهاج وسجلات المتابعة وكانت مكتملة.","تم حضور موقف صفي مع المعلمة وكانت المداولة مثمرة.","تم شرح اليه تنفيذ الحصة كتطبيقات تنافسية.","تم حث المعلمة على الاطلاع على الزيارات الاشرافية والالتزام بالنشرات.","تمت متابعة تنفيذ التوصيات السابقة وكانت مكتملة."],
                    incompleteOpinions: ["تم الالتقاء بالفاضلة مديرة المدرسة وبغياب معلمة الرياضة المدرسية.","لوحظ وجود بعض الملاحظات في تنظيم الطابور المدرسي.","سجلات المتابعة (الزي والمشاركة) غير مكتملة، وتم توجيه المعلمة لاستكمالها.","تعذر حضور موقف صفي مع المعلمة.","لوحظ ضعف في تطبيق الحصة كتطبيقات تنافسية، وتم إعادة شرح الآلية للمعلمة.","لوحظ عدم اطلاع المعلمة على الزيارات السابقة، وتم التأكيد عليها بضرورة المتابعة.","بعض التوصيات السابقة لم يتم تنفيذها، وتم مناقشة الأسباب مع المعلمة والإدارة."],
                    recommendations: ["متابعة التزام الهيئة التدريسية بالحضور.","تحسين تنظيم الطابور الصباحي.","ضرورة استكمال سجلات المتابعة (الزي والمشاركة) بشكل دوري.","التنسيق المسبق لحضور موقف صفي.","التأكيد على تنفيذ الحصص كتطبيقات تنافسية لزيادة تفاعل الطلبة.","حث المعلمة على المتابعة الدورية للزيارات الإشرافية والنشرات.","متابعة تنفيذ التوصيات السابقة وتقديم الدعم اللازم."]
                }
            };
            
            // --- STATE VARIABLES ---
            let visitTypesData = {};
            let savedReports = [];
            let currentAttachments = [];
            let currentVisitTypeKey = '';
            let previewSource = 'form';

            // --- MAIN VIEWS ---
            const dashboardView = document.getElementById('dashboardView');
            const formView = document.getElementById('formView');
            const reportPreviewContainer = document.getElementById('reportPreviewContainer');
            
            // --- FORM ELEMENTS ---
            const reportForm = document.getElementById('reportForm');
            const reportIdInput = document.getElementById('reportId');
            const formTitle = document.getElementById('formTitle');
            const schoolNameSelect = document.getElementById('schoolName');
            const teacherContainer = document.getElementById('teacherContainer');
            const teacherNameSelect = document.getElementById('teacherName');
            const visitTypeSelect = document.getElementById('visitTypeSelect');
            const objectivesContainer = document.getElementById('objectivesContainer');
            const opinionsContainer = document.getElementById('opinionsContainer');
            const recommendationsTextarea = document.getElementById('recommendations');
            const attachmentsInput = document.getElementById('attachmentsInput');
            const attachmentsList = document.getElementById('attachmentsList');

            // --- BUTTONS ---
            const addNewReportBtn = document.getElementById('addNewReportBtn');
            const backToDashboardBtn = document.getElementById('backToDashboardBtn');
            const prepareReportBtn = document.getElementById('prepareReportBtn');
            const backToBtn = document.getElementById('backToBtn');
            const selectAllObjectivesBtn = document.getElementById('selectAllObjectivesBtn');
            const copyAllBtn = document.getElementById('copyAllBtn');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importDataInput = document.getElementById('importDataInput');

            // --- DASHBOARD ELEMENTS ---
            const reportsListContainer = document.getElementById('reportsListContainer');
            const searchInput = document.getElementById('searchInput');
            
            // --- MODAL ELEMENTS (VISIT TYPES) ---
            const manageVisitTypesBtn = document.getElementById('manageVisitTypesBtn');
            const manageTypesModal = document.getElementById('manageTypesModal');
            const closeManageModalBtn = document.getElementById('closeManageModalBtn');
            const visitTypesList = document.getElementById('visitTypesList');
            const addNewTypeBtn = document.getElementById('addNewTypeBtn');
            const addEditTypeModal = document.getElementById('addEditTypeModal');
            const addEditModalTitle = document.getElementById('addEditModalTitle');
            const addEditTypeForm = document.getElementById('addEditTypeForm');
            const editTypeKeyInput = document.getElementById('editTypeKey');
            const typeNameInput = document.getElementById('typeName');
            const typeObjectivesTextarea = document.getElementById('typeObjectives');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const generateRecsBtn = document.getElementById('generate-recommendations-btn');

            // --- MODAL ELEMENTS (CONFIRMATION) ---
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationMessage = document.getElementById('confirmationMessage');
            const confirmActionBtn = document.getElementById('confirmActionBtn');
            const cancelActionBtn = document.getElementById('cancelActionBtn');


            // --- DATA MANAGEMENT (FIRESTORE) ---
            async function saveVisitTypes() {
                if (!userId) return;
                try {
                    const typesDocRef = db.collection('users').doc(userId).collection('settings').doc('visitTypes');
                    await typesDocRef.set({ data: visitTypesData });
                    console.log("Visit types saved to Firestore.");
                } catch (e) {
                    console.error("Error saving visit types: ", e);
                }
            }

            function subscribeToData(uid) {
                // onSnapshot for visit types
                const typesDocRef = db.collection('users').doc(uid).collection('settings').doc('visitTypes');
                typesDocRef.onSnapshot((docSnap) => {
                    if (docSnap.exists && docSnap.data().data && Object.keys(docSnap.data().data).length > 0) {
                        visitTypesData = docSnap.data().data;
                    } else {
                        // First time user or empty data, save default types
                        visitTypesData = defaultVisitTypesData;
                        saveVisitTypes(); // Save to firestore for future use
                    }
                    const keys = Object.keys(visitTypesData);
                    currentVisitTypeKey = keys.length > 0 ? keys[0] : '';
                    populateVisitTypeDropdown();
                    renderObjectivesForCurrentType();
                });

                // onSnapshot for reports
                const reportsCollectionRef = db.collection('users').doc(uid).collection('reports');
                reportsCollectionRef.onSnapshot((querySnapshot) => {
                    savedReports = [];
                    querySnapshot.forEach((doc) => {
                        savedReports.push({ id: doc.id, ...doc.data() });
                    });
                    renderDashboard(); // Re-render dashboard with new data
                }, (error) => {
                    console.error("Error listening to reports: ", error);
                });
            }


            // --- GENDER/PLURALITY LOGIC ---
            function getTeacherContext(schoolName) {
                const school = schoolTeacherData[schoolName];
                if (!school) {
                     return { gender: 'female', count: 1, teachers: [] };
                }
                if (school.gender === 'mixed' || (school.teachers && school.teachers.length > 1)) {
                    return { gender: 'plural', count: school.teachers.length, teachers: school.teachers };
                }
                return { gender: school.gender, count: 1, teachers: school.teachers || [] };
            }

            function applyGender(text, context) {
                if (!text) return "";
                if (context.count > 1) {
                    return text.replace(/الفاضلة مديرة/g, 'الفاضل مدير').replace(/مديرة/g, 'مدير').replace(/معلمةالرياضة/g, 'معلمي الرياضة').replace(/المعلمة/g, 'المعلمين').replace(/معلمة/g, 'معلمي').replace(/وهي /g, 'وهم ').replace(/لديها/g, 'لديهم');
                } else if (context.gender === 'male') {
                    return text.replace(/الفاضلة مديرة/g, 'الفاضل مدير').replace(/مديرة/g, 'مدير').replace(/معلمةالرياضة/g, 'معلم الرياضة').replace(/المعلمة/g, 'المعلم').replace(/معلمة/g, 'معلم').replace(/وهي /g, 'وهو ').replace(/لديها/g, 'لديه');
                }
                return text;
            }

            // --- VIEW MANAGEMENT ---
            function showDashboardView() {
                renderDashboard();
                dashboardView.classList.remove('hidden');
                formView.classList.add('hidden');
                reportPreviewContainer.classList.add('hidden');
            }

            function showFormView(reportId = null) {
                formView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                reportPreviewContainer.classList.add('hidden');
                if (reportId) {
                    const report = savedReports.find(r => r.id === reportId);
                    if (report) {
                        populateForm(report);
                        formTitle.textContent = 'تعديل تقرير زيارة';
                    }
                } else {
                    resetForm();
                    formTitle.textContent = 'إنشاء تقرير زيارة إشرافية';
                }
            }

            function showPreviewView(reportData) {
                renderReportPreview(reportData);
                reportPreviewContainer.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                formView.classList.add('hidden');
            }

            // --- DASHBOARD RENDERING ---
            function renderDashboard() {
                reportsListContainer.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase().trim();

                const filteredReports = savedReports.filter(report => {
                    if (!searchTerm) return true;
                    const reportDate = new Date(report.visitDate).toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric' });
                    return report.schoolName.toLowerCase().includes(searchTerm) ||
                           report.visitTypeName.toLowerCase().includes(searchTerm) ||
                           reportDate.includes(searchTerm);
                });

                if (filteredReports.length === 0) {
                    reportsListContainer.innerHTML = `<div class="text-center py-10 px-6 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">لا توجد تقارير محفوظة تطابق البحث</h3>
                        <p class="text-gray-500 mt-2">ابدأ بإضافة تقرير جديد أو قم بتغيير كلمة البحث.</p>
                    </div>`;
                    return;
                }

                const list = document.createElement('div');
                list.className = 'space-y-4';
                filteredReports.sort((a, b) => a.visitDate - b.visitDate).reverse().forEach(report => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-4 bg-white border rounded-lg shadow-sm hover:shadow-md transition-shadow';
                    const reportDate = new Date(report.visitDate).toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric' });
                    const attachmentIcon = (report.attachments && report.attachments.length > 0) ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a3 3 0 006 0V7a1 1 0 112 0v4a5 5 0 01-10 0V7a5 5 0 0110 0v4a1 1 0 11-2 0V7a3 3 0 00-3-3z" clip-rule="evenodd" /></svg>` : '';
                    item.innerHTML = `
                        <div class="flex items-center">
                            ${attachmentIcon}
                            <div>
                                <p class="font-bold text-gray-800">${report.schoolName}</p>
                                <p class="text-sm text-gray-500">${reportDate} - ${report.visitTypeName}</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button data-id="${report.id}" class="view-btn text-sm text-green-600 hover:underline">عرض</button>
                            <button data-id="${report.id}" class="edit-btn text-sm text-blue-600 hover:underline">تعديل</button>
                            <button data-id="${report.id}" class="delete-btn text-sm text-red-600 hover:underline">حذف</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
                reportsListContainer.appendChild(list);
            }

            // --- FORM MANAGEMENT ---
            function resetForm() {
                reportForm.reset();
                reportIdInput.value = '';
                document.getElementById('visitDate').valueAsDate = new Date();
                currentVisitTypeKey = Object.keys(visitTypesData)[0] || '';
                visitTypeSelect.value = currentVisitTypeKey;
                currentAttachments = [];
                renderAttachmentsList();
                renderTeacherDropdown(''); // Hide teacher dropdown
                renderObjectivesForCurrentType();
            }
            
            function populateForm(report) {
                resetForm();
                reportIdInput.value = report.id;
                schoolNameSelect.value = report.schoolName;
                document.getElementById('visitDate').value = new Date(report.visitDate).toISOString().split('T')[0];
                recommendationsTextarea.value = report.recommendations;
                
                renderTeacherDropdown(report.schoolName);
                if (report.teacherName) {
                    teacherNameSelect.value = report.teacherName;
                }

                currentVisitTypeKey = report.visitTypeKey;
                visitTypeSelect.value = currentVisitTypeKey;
                currentAttachments = report.attachments || [];
                renderAttachmentsList();
                renderObjectivesForCurrentType();

                const checkboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    if (report.checkedObjectives.includes(cb.dataset.genderedValue)) {
                        cb.checked = true;
                    }
                });

                updateOpinionsSection();

                setTimeout(() => {
                     report.opinions.forEach(op => {
                        const textarea = document.getElementById(`opinion-${op.index}`);
                        if (textarea) textarea.value = op.text;
                    });
                }, 0);
            }

            function populateVisitTypeDropdown() {
                visitTypeSelect.innerHTML = '';
                Object.keys(visitTypesData).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = visitTypesData[key].name;
                    visitTypeSelect.appendChild(option);
                });
                if (currentVisitTypeKey) {
                    visitTypeSelect.value = currentVisitTypeKey;
                }
            }

            function renderTeacherDropdown(schoolName) {
                const school = schoolTeacherData[schoolName];
                teacherNameSelect.innerHTML = '';
                if (school && school.teachers && school.teachers.length > 0) {
                    teacherNameSelect.innerHTML = '<option value="" selected>اختر المعلم/ة...</option>';
                    school.teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher;
                        option.textContent = teacher;
                        teacherNameSelect.appendChild(option);
                    });
                    teacherContainer.classList.remove('hidden');
                } else {
                    teacherContainer.classList.add('hidden');
                }
            }
            
            function renderObjectivesForCurrentType() {
                if (!currentVisitTypeKey || !visitTypesData[currentVisitTypeKey]) return;
                const schoolName = schoolNameSelect.value;
                const context = getTeacherContext(schoolName);
                const data = visitTypesData[currentVisitTypeKey];
                objectivesContainer.innerHTML = '';
                data.objectives_list.forEach((objective, index) => {
                    const genderedObjective = applyGender(objective, context);
                    objectivesContainer.innerHTML += `
                        <div class="flex items-start">
                            <input id="objective-${index}" type="checkbox" value="${objective}" data-gendered-value="${genderedObjective}" data-index="${index}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mt-1">
                            <label for="objective-${index}" class="mr-2 text-sm font-medium text-gray-900">${index + 1}- ${genderedObjective}</label>
                        </div>`;
                });
                updateOpinionsSection();
                updateSelectAllButtonState();
            }

            // --- OPINIONS & RECOMMENDATIONS SECTION LOGIC (UNCHANGED from original) ---
            // This extensive logic is kept as is because it works perfectly.
            function updateSelectAllButtonState() {
                const checkboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]');
                if (checkboxes.length === 0) {
                    selectAllObjectivesBtn.textContent = 'اختيار الكل';
                    return;
                }
                const allSelected = Array.from(checkboxes).every(cb => cb.checked);
                selectAllObjectivesBtn.textContent = allSelected ? 'إلغاء اختيار الكل' : 'اختيار الكل';
            }
            function updateOpinionsSection() {
                const previouslySavedOpinions = new Map();
                opinionsContainer.querySelectorAll('.opinion-block textarea').forEach(textarea => {
                    previouslySavedOpinions.set(textarea.id, textarea.value);
                });

                opinionsContainer.innerHTML = '';
                const checkedCheckboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]:checked');
                
                if (checkedCheckboxes.length === 0) {
                    opinionsContainer.innerHTML = '<p class="text-center text-gray-500">لم يتم تحديد أي هدف بعد.</p>';
                    return;
                }
                
                checkedCheckboxes.forEach(checkbox => {
                    const index = checkbox.dataset.index;
                    const baseObjectiveText = checkbox.value;
                    const genderedObjectiveText = checkbox.dataset.genderedValue;
                    const opinionId = `opinion-${index}`;
                    
                    const opinionBlock = document.createElement('div');
                    opinionBlock.className = 'opinion-block space-y-2';

                    let specialInputsHTML = '';
                    let standardButtonsHTML = `<div class="flex gap-2"><button type="button" data-opinion="completed" data-index="${index}" class="px-3 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full hover:bg-green-200 transition-colors">✅ مكتمل</button><button type="button" data-opinion="incomplete" data-index="${index}" class="px-3 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full hover:bg-red-200 transition-colors">❌ غير مكتمل</button></div>`;
                    const approvalObjectiveText = "متابعة موافقات التعيين.";
                    if (baseObjectiveText === approvalObjectiveText) {
                        specialInputsHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-2 p-3 bg-gray-100 rounded-md border items-center"><div><label for="approval-status-${index}" class="text-xs text-gray-600 block mb-1">في حالة عدم الاكتمال، اختر السبب:</label><select id="approval-status-${index}" data-index="${index}" class="approval-status-select bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"><option value="" selected>اختر السبب...</option><option value="in_progress">في اجراءات التعيين</option><option value="no_approval">ليس لديها موافقة تعيين</option><option value="expired">الموافقة المبدئية منتهية الصلاحية</option></select></div><div class="self-end"><button type="button" data-opinion="completed" data-index="${index}" data-special="approval" class="w-full px-3 py-2.5 text-sm font-medium text-green-800 bg-green-100 rounded-lg hover:bg-green-200 transition-colors">✅ مكتمل</button></div></div>`;
                        standardButtonsHTML = '';
                    }

                    opinionBlock.innerHTML = `<label for="${opinionId}" class="block text-sm font-semibold text-gray-800">${parseInt(index) + 1}- ${genderedObjectiveText}</label>${specialInputsHTML}${standardButtonsHTML}<textarea id="${opinionId}" name="${opinionId}" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 mt-2" placeholder="..."></textarea>`;
                    opinionsContainer.appendChild(opinionBlock);
                });
                
                previouslySavedOpinions.forEach((value, id) => {
                    const textarea = document.getElementById(id);
                    if (textarea) textarea.value = value;
                });
            }

            // --- ATTACHMENTS HANDLING ---
            function renderAttachmentsList() {
                attachmentsList.innerHTML = '';
                if (currentAttachments.length === 0) return;
                currentAttachments.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-md text-sm';
                    item.innerHTML = `<span class="text-gray-700 truncate">${file.name}</span><button type="button" data-index="${index}" class="remove-attachment-btn text-red-500 hover:text-red-700">&times;</button>`;
                    attachmentsList.appendChild(item);
                });
            }

            // --- REPORT PREVIEW ---
            function renderReportPreview(data) {
                const reportContent = document.getElementById('reportContent');
                const visitDate = new Date(data.visitDate).toLocaleDateString('ar-OM');
                let reportHTML = `<h2 class="text-2xl font-bold mb-4 text-center">تقرير زيارة إشرافية</h2>`;
                reportHTML += `<div class="grid grid-cols-2 gap-4 mb-6 border-b pb-4">
                                   <p><strong>اسم المدرسة:</strong> ${data.schoolName}</p>
                                   <p><strong>تاريخ الزيارة:</strong> ${visitDate}</p>
                                   <p><strong>اسم المعلم/ة:</strong> ${data.teacherName || 'لم يحدد'}</p>
                                   <p><strong>نوع الزيارة:</strong> ${data.visitTypeName}</p>
                               </div>`;
                
                reportHTML += `<div id="reportObjectives"><div class="flex justify-between items-center mt-6 mb-3"><h3 class="text-xl font-semibold">أهداف الزيارة:</h3><button data-target="reportObjectives" class="copy-section-btn text-xs text-blue-600 hover:underline no-print">نسخ</button></div><ol class="list-decimal list-inside space-y-2">`;
                data.checkedObjectives.forEach(obj => { reportHTML += `<li>${obj}</li>`; });
                reportHTML += `</ol></div>`;
                
                reportHTML += `<div id="reportOpinions"><div class="flex justify-between items-center mt-6 mb-3"><h3 class="text-xl font-semibold">رأي الزائر:</h3><button data-target="reportOpinions" class="copy-section-btn text-xs text-blue-600 hover:underline no-print">نسخ</button></div><ol class="list-decimal list-inside space-y-2">`;
                data.opinions.sort((a,b) => a.index - b.index).forEach(op => { reportHTML += `<li class="text-gray-700">${op.text.replace(/\n/g, '<br>')}</li>`; });
                reportHTML += `</ol></div>`;

                if(data.recommendations) {
                    reportHTML += `<div id="reportRecommendations"><div class="flex justify-between items-center mt-6 mb-3"><h3 class="text-xl font-semibold">التوصيات:</h3><button data-target="reportRecommendations" class="copy-section-btn text-xs text-blue-600 hover:underline no-print">نسخ</button></div><p class="text-gray-700">${data.recommendations.replace(/\n/g, '<br>')}</p></div>`;
                }

                if(data.attachments && data.attachments.length > 0) {
                    reportHTML += `<div id="reportAttachments" class="no-print"><h3 class="text-xl font-semibold mt-6 mb-3">المرفقات:</h3><ul class="list-disc list-inside space-y-1">`;
                    data.attachments.forEach(file => { reportHTML += `<li class="text-gray-700">${file.name}</li>`; });
                    reportHTML += `</ul></div>`;
                }
                
                reportContent.innerHTML = reportHTML;
            }

            // --- EVENT LISTENERS ---
            addNewReportBtn.addEventListener('click', () => showFormView());
            backToDashboardBtn.addEventListener('click', showDashboardView);
            searchInput.addEventListener('input', renderDashboard);
            
            reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) {
                    console.error("User not authenticated. Cannot save report.");
                    return;
                }

                const reportId = reportIdInput.value;
                const checkedObjectives = Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => cb.dataset.genderedValue);
                const opinions = Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => {
                    return { index: cb.dataset.index, text: document.getElementById(`opinion-${cb.dataset.index}`).value };
                });

                const reportData = {
                    schoolName: schoolNameSelect.value,
                    teacherName: teacherNameSelect.value,
                    visitDate: new Date(document.getElementById('visitDate').value).getTime(),
                    visitTypeKey: currentVisitTypeKey,
                    visitTypeName: visitTypesData[currentVisitTypeKey].name,
                    checkedObjectives, opinions,
                    recommendations: recommendationsTextarea.value,
                    attachments: currentAttachments,
                };

                try {
                    if (reportId) { // Editing existing report
                        const reportDocRef = db.collection('users').doc(userId).collection('reports').doc(reportId);
                        await reportDocRef.set(reportData, { merge: true });
                    } else { // Creating new report
                        await db.collection('users').doc(userId).collection('reports').add(reportData);
                    }
                    showDashboardView();
                } catch (error) {
                    console.error("Error saving report to Firestore: ", error);
                }
            });
            
            prepareReportBtn.addEventListener('click', function() {
                if (!reportForm.checkValidity()) {
                    reportForm.reportValidity();
                    return;
                }
                previewSource = 'form';
                const checkedObjectives = Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => cb.dataset.genderedValue);
                const opinions = Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => {
                    return { index: cb.dataset.index, text: document.getElementById(`opinion-${cb.dataset.index}`).value };
                });
                const reportData = {
                    schoolName: schoolNameSelect.value,
                    teacherName: teacherNameSelect.value,
                    visitDate: new Date(document.getElementById('visitDate').value),
                    visitTypeName: visitTypesData[currentVisitTypeKey].name,
                    checkedObjectives, opinions,
                    recommendations: recommendationsTextarea.value,
                    attachments: currentAttachments
                };
                showPreviewView(reportData);
            });

            backToBtn.addEventListener('click', () => {
                if (previewSource === 'dashboard') {
                    showDashboardView();
                } else {
                    showFormView(reportIdInput.value || null);
                }
            });
            
            function copyToClipboard(text, buttonElement) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.opacity = 0;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = buttonElement.textContent;
                    buttonElement.textContent = 'تم النسخ!';
                    setTimeout(() => { buttonElement.textContent = originalText; }, 2000);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
            }

            copyAllBtn.addEventListener('click', (e) => {
                const sections = ['reportObjectives', 'reportOpinions', 'reportRecommendations'];
                const titles = ['أهداف الزيارة:', 'رأي الزائر:', 'التوصيات:'];
                let textToCopy = "";

                sections.forEach((id, i) => {
                    const element = document.getElementById(id);
                    if (element) {
                        textToCopy += titles[i] + "\n";
                        if (id === 'reportRecommendations') {
                            textToCopy += element.querySelector('p').innerText.trim() + "\n\n";
                        } else {
                            element.querySelectorAll('li').forEach((li, index) => {
                                textToCopy += `${index + 1}- ${li.textContent.trim()}\n`;
                            });
                            textToCopy += "\n";
                        }
                    }
                });
                copyToClipboard(textToCopy.trim(), e.target);
            });

            reportPreviewContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('copy-section-btn')) {
                    const targetId = e.target.dataset.target;
                    const targetElement = document.getElementById(targetId);
                    if (!targetElement) return;

                    let textToCopy = "";
                    if (targetId === 'reportRecommendations') {
                        textToCopy = targetElement.querySelector('p').innerText.trim();
                    } else {
                        targetElement.querySelectorAll('li').forEach((li, index) => {
                            textToCopy += `${index + 1}- ${li.textContent.trim()}\n`;
                        });
                    }
                    copyToClipboard(textToCopy.trim(), e.target);
                }
            });

            reportsListContainer.addEventListener('click', (e) => {
                const target = e.target;
                const reportId = target.dataset.id;
                if (!reportId) return;
                if (target.classList.contains('view-btn')) {
                    previewSource = 'dashboard';
                    const report = savedReports.find(r => r.id === reportId);
                    showPreviewView(report);
                }
                if (target.classList.contains('edit-btn')) {
                    showFormView(reportId);
                }
                if (target.classList.contains('delete-btn')) {
                    const report = savedReports.find(r => r.id === reportId);
                    showConfirmation(`هل أنت متأكد من حذف تقرير مدرسة "${report.schoolName}"؟`, async () => {
                        if (!userId) return;
                        try {
                           await db.collection('users').doc(userId).collection('reports').doc(reportId).delete();
                           // onSnapshot will handle UI update automatically
                        } catch (error) {
                            console.error("Error deleting report: ", error);
                        }
                    });
                }
            });
            
            schoolNameSelect.addEventListener('change', (e) => {
                renderTeacherDropdown(e.target.value);
                renderObjectivesForCurrentType();
            });

            visitTypeSelect.addEventListener('change', (e) => {
                currentVisitTypeKey = e.target.value;
                renderObjectivesForCurrentType();
            });

            objectivesContainer.addEventListener('change', () => {
                updateOpinionsSection();
                updateSelectAllButtonState();
            });

            selectAllObjectivesBtn.addEventListener('click', () => {
                const checkboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]');
                if (checkboxes.length === 0) return;
                const allSelected = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => { cb.checked = !allSelected; });
                updateOpinionsSection();
                updateSelectAllButtonState();
            });

            opinionsContainer.addEventListener('click', (e) => {
                if(e.target.matches('button[data-opinion]')) {
                    const opinionType = e.target.dataset.opinion;
                    const index = e.target.dataset.index;
                    const textarea = document.getElementById(`opinion-${index}`);
                    const context = getTeacherContext(schoolNameSelect.value);
                    
                    let baseOpinionText = (opinionType === 'completed') 
                        ? visitTypesData[currentVisitTypeKey].completedOpinions[index] 
                        : visitTypesData[currentVisitTypeKey].incompleteOpinions[index];

                    let generatedText = applyGender(baseOpinionText, context);

                    if (e.target.dataset.special === 'approval') {
                        const dropdown = document.getElementById(`approval-status-${index}`);
                        if (dropdown) dropdown.value = '';
                    }

                    textarea.value = generatedText;
                }
            });
            
             opinionsContainer.addEventListener('change', (e) => {
                if (e.target.matches('select.approval-status-select')) {
                    const index = e.target.dataset.index;
                    const textarea = document.getElementById(`opinion-${index}`);
                    const context = getTeacherContext(schoolNameSelect.value);
                    const selectedValue = e.target.value;

                    if (selectedValue && textarea) {
                         let text = '';
                        switch(selectedValue) {
                            case 'in_progress': text = "تم متابعة موافقات التعيين وهي في اجراءات التعيين."; break;
                            case 'no_approval': text = "تم متابعة موافقات التعيين وليس لديها موافقة تعيين."; break;
                            case 'expired': text = "تم متابعة موافقات التعيين والموافقة المبدئية منتهية الصلاحية."; break;
                        }
                        textarea.value = applyGender(text, context);
                    }
                }
            });

            generateRecsBtn.addEventListener('click', () => {
                const checkedCheckboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]:checked');
                if (checkedCheckboxes.length === 0) {
                    showConfirmation("الرجاء تحديد هدف واحد على الأقل للمتابعة.", () => {});
                    return;
                }
                const currentTypeData = visitTypesData[currentVisitTypeKey];
                const context = getTeacherContext(schoolNameSelect.value);
                let generatedRecommendations = [];

                checkedCheckboxes.forEach(checkbox => {
                    const index = checkbox.dataset.index;
                    const opinionTextarea = document.getElementById(`opinion-${index}`);
                    let genderedIncompleteOpinion = applyGender(currentTypeData.incompleteOpinions[index], context);

                    if (opinionTextarea && opinionTextarea.value.trim() === genderedIncompleteOpinion.trim()) {
                        let genderedRecommendation = applyGender(currentTypeData.recommendations[index], context);
                        generatedRecommendations.push(genderedRecommendation);
                    }
                });

                if (generatedRecommendations.length > 0) {
                    recommendationsTextarea.value = "نوصي إدارة المدرسة بالاتي:\n- " + generatedRecommendations.join('\n- ') + "\n\nوالله الموفق.";
                } else {
                    recommendationsTextarea.value = "سير العمل ممتاز ولا توجد حاجة لتوصيات حالية.";
                }
            });

            attachmentsInput.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        // Note: Storing large files as base64 in Firestore is not recommended.
                        // For a production app, use Firebase Storage instead.
                        currentAttachments.push({ name: file.name, data: event.target.result });
                        renderAttachmentsList();
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = '';
            });

            attachmentsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-attachment-btn')) {
                    currentAttachments.splice(e.target.dataset.index, 1);
                    renderAttachmentsList();
                }
            });

            // --- DATA EXPORT/IMPORT ---
            exportDataBtn.addEventListener('click', async () => {
                if (!userId) return;
                const reportsSnapshot = await db.collection('users').doc(userId).collection('reports').get();
                const reportsData = reportsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const typesDoc = await db.collection('users').doc(userId).collection('settings').doc('visitTypes').get();
                const typesData = typesDoc.exists ? typesDoc.data().data : {};

                const dataToExport = {
                    visitTypesData: typesData,
                    savedReports: reportsData // Note: this is a snapshot, not real-time
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `school_reports_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            importDataInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file || !userId) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.visitTypesData && importedData.savedReports) {
                            showConfirmation("سيؤدي هذا إلى الكتابة فوق جميع البيانات الحالية. هل أنت متأكد؟", async () => {
                                // Save visit types
                                await db.collection('users').doc(userId).collection('settings').doc('visitTypes').set({data: importedData.visitTypesData});

                                // Clear existing reports and add new ones
                                const batch = db.batch();
                                const currentReportsSnapshot = await db.collection('users').doc(userId).collection('reports').get();
                                currentReportsSnapshot.forEach(doc => batch.delete(doc.ref));
                                
                                importedData.savedReports.forEach(report => {
                                    const { id, ...reportData } = report; // separate id from data
                                    const newDocRef = db.collection('users').doc(userId).collection('reports').doc();
                                    batch.set(newDocRef, reportData);
                                });
                                
                                await batch.commit();
                                // onSnapshot will update the UI automatically.
                            });
                        } else {
                            throw new Error("ملف غير صالح.");
                        }
                    } catch (error) {
                         showConfirmation(`حدث خطأ أثناء استيراد الملف: ${error.message}`, () => {});
                    } finally {
                        importDataInput.value = '';
                    }
                };
                reader.readAsText(file);
            });

            // --- MODAL LOGIC ---
            function showConfirmation(message, onConfirm) {
                confirmationMessage.textContent = message;
                confirmationModal.classList.remove('hidden');

                const confirmHandler = () => {
                    onConfirm();
                    hideConfirmation();
                };

                const cancelHandler = () => {
                    hideConfirmation();
                };

                const hideConfirmation = () => {
                    confirmationModal.classList.add('hidden');
                    confirmActionBtn.removeEventListener('click', confirmHandler);
                    cancelActionBtn.removeEventListener('click', cancelHandler);
                };

                confirmActionBtn.addEventListener('click', confirmHandler, { once: true });
                cancelActionBtn.addEventListener('click', cancelHandler, { once: true });
            }
            
            manageVisitTypesBtn.addEventListener('click', () => { renderManagerModal(); manageTypesModal.classList.remove('hidden'); });
            closeManageModalBtn.addEventListener('click', () => manageTypesModal.classList.add('hidden'));
            addNewTypeBtn.addEventListener('click', () => { editTypeKeyInput.value = ''; addEditModalTitle.textContent = 'إضافة نوع زيارة جديد'; addEditTypeForm.reset(); addEditTypeModal.classList.remove('hidden'); });
            
            visitTypesList.addEventListener('click', (e) => {
                const key = e.target.dataset.key;
                if (!key) return;
                if (e.target.classList.contains('edit-btn')) {
                    editTypeKeyInput.value = key; addEditModalTitle.textContent = 'تعديل نوع الزيارة'; typeNameInput.value = visitTypesData[key].name; typeObjectivesTextarea.value = visitTypesData[key].objectives_list.join('\n'); addEditTypeModal.classList.remove('hidden');
                }
                if (e.target.classList.contains('delete-btn')) {
                    if (Object.keys(visitTypesData).length <= 1) { showConfirmation("يجب أن يكون هناك نوع زيارة واحد على الأقل.", ()=>{}); return; }
                    showConfirmation(`هل أنت متأكد من حذف "${visitTypesData[key].name}"؟`, () => {
                        delete visitTypesData[key];
                        saveVisitTypes(); // This now saves to Firestore
                    });
                }
            });

            cancelEditBtn.addEventListener('click', () => addEditTypeModal.classList.add('hidden'));
            
            addEditTypeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const key = editTypeKeyInput.value;
                const name = typeNameInput.value.trim();
                const objectives = typeObjectivesTextarea.value.trim().split('\n').filter(line => line.trim() !== '');
                if (!name || objectives.length === 0) { showConfirmation("الرجاء إدخال اسم ونوع وهدف واحد على الأقل.", ()=>{}); return; }
                
                const newKey = key || `type_${Date.now()}`;
                
                visitTypesData[newKey] = { name, objectives_list: objectives, completedOpinions: objectives.map(o => `تم ${o.replace(/\.$/, "")} بنجاح.`), incompleteOpinions: objectives.map(o => `يوجد ملاحظات بخصوص ${o.replace(/\.$/, "")}`), recommendations: objectives.map(o => `متابعة ${o.replace(/\.$/, "")}.`) };
                await saveVisitTypes(); // Save updated types to Firestore
                
                currentVisitTypeKey = newKey;
                renderManagerModal(); 
                populateVisitTypeDropdown(); 
                renderObjectivesForCurrentType(); 
                addEditTypeModal.classList.add('hidden');
            });
            function renderManagerModal() {
                visitTypesList.innerHTML = '';
                 Object.keys(visitTypesData).forEach(key => {
                    const type = visitTypesData[key];
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
                    item.innerHTML = `<span class="font-medium">${type.name}</span><div class="flex gap-2"><button data-key="${key}" class="edit-btn text-sm text-blue-600 hover:underline">تعديل</button><button data-key="${key}" class="delete-btn text-sm text-red-600 hover:underline">حذف</button></div>`;
                    visitTypesList.appendChild(item);
                });
            }

            // --- APP INITIALIZATION & AUTHENTICATION ---
            function initializeApp() {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        // User is signed in anonymously.
                        userId = user.uid;
                        console.log("Authenticated with userId:", userId);
                        // Subscribe to real-time data now that we have a user ID
                        subscribeToData(userId); 
                    } else {
                        // User is signed out.
                        userId = null;
                        console.log("User is not authenticated.");
                        // Here you could clear the UI or show a login element if you expand auth
                        reportsListContainer.innerHTML = `<p class="text-center text-gray-500">جاري المصادقة...</p>`;
                    }
                });

                auth.signInAnonymously().catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                    reportsListContainer.innerHTML = `<p class="text-center text-red-500">فشل تسجيل الدخول. الرجاء تحديث الصفحة.</p>`;
                });
                
                showDashboardView(); 
            }

            initializeApp();
        });
    </script>
</body>
</html>

