<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชูุฑูุฑ ุฒูุงุฑุฉ ูุฏุฑุณูุฉ</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to use the Cairo font */
        body {
            font-family: 'Cairo', sans-serif;
        }
        @media print {
            .no-print { display: none !important; }
            body * {
                visibility: hidden;
            }
            #reportPreviewContainer, #reportPreviewContainer * {
                visibility: visible;
            }
            #reportPreviewContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Dashboard View -->
    <div id="dashboardView" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg">
        <header class="flex justify-between items-center mb-8 border-b pb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ุณุฌู ุงูุชูุงุฑูุฑ</h1>
                <p class="text-gray-500 mt-2">ุนุฑุถ ูุฅุฏุงุฑุฉ ุฌููุน ุชูุงุฑูุฑ ุงูุฒูุงุฑุงุช ุงููุญููุธุฉ</p>
            </div>
            <button id="addNewReportBtn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-6 py-3 whitespace-nowrap transition-colors">
                + ุชูุฑูุฑ ุฌุฏูุฏ
            </button>
        </header>
        <div id="reportsListContainer">
            <!-- Reports list will be dynamically populated here -->
        </div>
    </div>


    <!-- Form View -->
    <div id="formView" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg hidden no-print">
        <header class="text-center mb-8">
            <h1 id="formTitle" class="text-3xl font-bold text-gray-800">ุฅูุดุงุก ุชูุฑูุฑ ุฒูุงุฑุฉ ุฅุดุฑุงููุฉ</h1>
            <p class="text-gray-500 mt-2">ูููุฐุฌ ูุชูุซูู ุงูุฒูุงุฑุงุช ุงูุฅุดุฑุงููุฉ ูููุนูููู</p>
        </header>

        <form id="reportForm" class="space-y-8">
             <input type="hidden" id="reportId" value="">

            <!-- School and Date Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">ูุนูููุงุช ุฃุณุงุณูุฉ</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <label for="schoolName" class="block mb-2 text-sm font-medium text-gray-900">ุงุณู ุงููุฏุฑุณุฉ</label>
                        <select id="schoolName" name="schoolName" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <option value="" selected disabled>ุงุฎุชุฑ ุงููุฏุฑุณุฉ</option>
                            <option value="ุฃุจู ุงููุงุณู ุงูุฒูุฑุงูู">ุฃุจู ุงููุงุณู ุงูุฒูุฑุงูู</option>
                            <option value="ุฃุจู ุฃููุจ ุงูุญุถุฑูู">ุฃุจู ุฃููุจ ุงูุญุถุฑูู</option>
                            <option value="ุฃุจู ุชูุงู">ุฃุจู ุชูุงู</option>
                            <option value="ุฃุญูุฏ ุจู ุงููุนูุงู">ุฃุญูุฏ ุจู ุงููุนูุงู</option>
                            <option value="ุงูุดูุฎ ุณุงูู ุงูุณูุงุจู">ุงูุดูุฎ ุณุงูู ุงูุณูุงุจู</option>
                            <option value="ุงูุดูุฎ ุณุนูุฏ ุงูููุฏู ูุณุงุฆู">ุงูุดูุฎ ุณุนูุฏ ุงูููุฏู ูุณุงุฆู</option>
                            <option value="ุงูุดูุฎ ูุงุตุฑ ุงูุฎุฑูุตู">ุงูุดูุฎ ูุงุตุฑ ุงูุฎุฑูุตู</option>
                            <option value="ุฌูุงุฏุฉ ุงูุงุฒุฏู (ููุณู ุณุงุจูุง)">ุฌูุงุฏุฉ ุงูุงุฒุฏู (ููุณู ุณุงุจูุง)</option>
                            <option value="ุญูุต ุจู ุฑุงุดุฏ">ุญูุต ุจู ุฑุงุดุฏ</option>
                            <option value="ุฎุฑูุณ ุงูุญุจูุณ">ุฎุฑูุณ ุงูุญุจูุณ</option>
                            <option value="ุณููู ุจู ุนูุฑู ุงูุนุงูุฑู">ุณููู ุจู ุนูุฑู ุงูุนุงูุฑู</option>
                            <option value="ูุนุจ ุจู ุฒูุฏ">ูุนุจ ุจู ุฒูุฏ</option>
                            <option value="ูุฒูุฏ ุงูุทุงุฆู">ูุฒูุฏ ุงูุทุงุฆู</option>
                            <option value="ุงุฌูุงู ุงูุซูุงูุฉ">ุงุฌูุงู ุงูุซูุงูุฉ</option>
                            <option value="ุงุฌูุงู ุงููุฑุฏูุณ - ุงูุญูู">ุงุฌูุงู ุงููุฑุฏูุณ - ุงูุญูู</option>
                            <option value="ุงูุจูุงู">ุงูุจูุงู</option>
                            <option value="ุงูุฌูู ุงููุจุฏุน">ุงูุฌูู ุงููุจุฏุน</option>
                            <option value="ุงูุฑูุงุฏุฉ">ุงูุฑูุงุฏุฉ</option>
                            <option value="ุงูุณุฑุงุฌ">ุงูุณุฑุงุฌ</option>
                            <option value="ุงูุตููุฉ ุงููุนุจููุฉ">ุงูุตููุฉ ุงููุนุจููุฉ</option>
                            <option value="ุงููุฌุฏ">ุงููุฌุฏ</option>
                            <option value="ุงูุณ ุจู ูุงูู (ุงูููุงุฑ ุณุงุจูุง)">ุงูุณ ุจู ูุงูู (ุงูููุงุฑ ุณุงุจูุง)</option>
                            <option value="ุฌููุฑ ุจู ุงูุฌููุฏู">ุฌููุฑ ุจู ุงูุฌููุฏู</option>
                            <option value="ุถูุงุก ุงููุณุชูุจู">ุถูุงุก ุงููุณุชูุจู</option>
                            <option value="ูุดุงุนู ูุณูุท ุณูุฑ ุงูุญุฏูุฏ">ูุดุงุนู ูุณูุท ุณูุฑ ุงูุญุฏูุฏ</option>
                            <option value="ููุงุจุน ุงูุชููู">ููุงุจุน ุงูุชููู</option>
                        </select>
                    </div>
                    <div>
                        <label for="visitDate" class="block mb-2 text-sm font-medium text-gray-900">ุชุงุฑูุฎ ุงูุฒูุงุฑุฉ</label>
                        <input type="date" id="visitDate" name="visitDate" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                </div>
            </fieldset>
            
            <!-- Visit Type Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">ููุน ุงูุฒูุงุฑุฉ</legend>
                <div class="flex items-center gap-4 mt-2">
                    <select id="visitTypeSelect" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <!-- Options will be dynamically generated by JS -->
                    </select>
                    <button type="button" id="manageVisitTypesBtn" class="p-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg border hover:bg-gray-200 transition-colors whitespace-nowrap">
                        โ๏ธ ุฅุฏุงุฑุฉ ุงูุฃููุงุน
                    </button>
                </div>
            </fieldset>

            <!-- Visit Objectives Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <div class="flex justify-between items-center mb-4">
                     <legend class="text-lg font-semibold text-gray-700 px-2">ุฃูุฏุงู ุงูุฒูุงุฑุฉ</legend>
                     <button type="button" id="selectAllObjectivesBtn" class="text-sm font-medium text-blue-600 hover:underline">ุงุฎุชูุงุฑ ุงููู</button>
                </div>
                <div id="objectivesContainer" class="space-y-4">
                    <!-- Checkboxes will be dynamically generated by JS -->
                </div>
            </fieldset>

            <!-- Visitor's Opinion Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">ุฑุฃู ุงูุฒุงุฆุฑ</legend>
                 <p class="text-sm text-gray-500 mb-4">ุงูุชุจ ููุงุญุธุงุชู ููู ูุฏู ูู ุงูุฃูุฏุงู ุงููุญุฏุฏุฉ ุฃุนูุงู.</p>
                <div id="opinionsContainer" class="space-y-6">
                    <!-- Opinion textareas will be generated here -->
                </div>
            </fieldset>

            <!-- Recommendations Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">ุงูุชูุตูุงุช</legend>
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-2 gap-4 flex-wrap">
                        <label for="recommendations" class="block text-sm font-medium text-gray-900 sr-only">ุงูุชูุตูุงุช</label>
                        <div class="flex gap-4">
                             <button type="button" id="generate-recommendations-btn" class="flex items-center text-sm text-blue-600 font-semibold hover:text-blue-800 transition-colors">
                                ๐ ุชูููุฏ ุงูุชูุตูุงุช
                            </button>
                        </div>
                    </div>
                    <textarea id="recommendations" name="recommendations" rows="5" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="ุงูุชุจ ุงูุชูุตูุงุช ูุงูููุงุญุธุงุช ุงูููุงุฆูุฉ ููุง ุฃู ุงุณุชุฎุฏู ุฒุฑ ุงูุชูููุฏ ุงูุชููุงุฆู..."></textarea>
                </div>
            </fieldset>

            <!-- Attachments Section -->
            <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                <legend class="text-lg font-semibold text-gray-700 px-2">ุงููุฑููุงุช</legend>
                <div class="mt-4">
                    <label for="attachmentsInput" class="block mb-2 text-sm font-medium text-gray-900">ุงุฎุชุฑ ูููุงุช (ุตูุฑุ ูุณุชูุฏุงุช...)</label>
                    <input type="file" id="attachmentsInput" multiple class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                    <div id="attachmentsList" class="mt-4 space-y-2">
                        <!-- Attached files will be listed here -->
                    </div>
                </div>
            </fieldset>
            
            <!-- Action Buttons -->
            <div class="flex justify-end pt-4 gap-4">
                 <button type="button" id="backToDashboardBtn" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">ุฅูุบุงุก</button>
                <button type="button" id="prepareReportBtn" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">ูุนุงููุฉ ุงูุชูุฑูุฑ</button>
                <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">ุญูุธ ุงูุชูุฑูุฑ</button>
            </div>

        </form>
    </div>

    <!-- Report Preview Section -->
    <div id="reportPreviewContainer" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg hidden">
         <div id="reportContent" class="prose max-w-none">
            <!-- Generated report will be injected here -->
         </div>
         <div class="flex justify-end pt-6 mt-6 border-t no-print gap-4 flex-wrap">
            <button id="backToBtn" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">ุฑุฌูุน</button>
            <button id="copyAllBtn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">ูุณุฎ ุงููู</button>
            <button onclick="window.print()" class="text-white bg-gray-800 hover:bg-gray-900 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">ุทุจุงุนุฉ</button>
         </div>
    </div>
    
    <!-- Modals (Unchanged) -->
    <div id="manageTypesModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-backdrop">
        <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white modal-content">
            <div class="flex justify-between items-center border-b pb-3">
                 <h3 class="text-lg leading-6 font-medium text-gray-900">ุฅุฏุงุฑุฉ ุฃููุงุน ุงูุฒูุงุฑุงุช</h3>
                 <button id="closeManageModalBtn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                 </button>
            </div>
            <div class="mt-4">
                <div id="visitTypesList" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                <div class="mt-6 pt-4 border-t">
                    <button id="addNewTypeBtn" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">ุฅุถุงูุฉ ููุน ุฒูุงุฑุฉ ุฌุฏูุฏ</button>
                </div>
            </div>
        </div>
    </div>
    <div id="addEditTypeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-backdrop">
        <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white modal-content">
            <h3 id="addEditModalTitle" class="text-lg leading-6 font-medium text-gray-900 mb-4"></h3>
            <form id="addEditTypeForm">
                <input type="hidden" id="editTypeKey" value="">
                <div>
                    <label for="typeName" class="block mb-2 text-sm font-medium text-gray-900">ุงุณู ููุน ุงูุฒูุงุฑุฉ</label>
                    <input type="text" id="typeName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mt-4">
                    <label for="typeObjectives" class="block mb-2 text-sm font-medium text-gray-900">ุงูุฃูุฏุงู (ูู ูุฏู ูู ุณุทุฑ)</label>
                    <textarea id="typeObjectives" rows="8" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                <div class="items-center px-4 py-3 gap-3 flex justify-end mt-4 border-t pt-4">
                    <button id="saveTypeBtn" type="submit" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-700">ุญูุธ</button>
                    <button id="cancelEditBtn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">ุฅูุบุงุก</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- STORAGE KEYS ---
            const TYPES_STORAGE_KEY = 'visitTypesData';
            const REPORTS_STORAGE_KEY = 'savedReportsData';

            // --- DATABASE ---
            const schoolTeacherData = {
                "ุฃุจู ุงููุงุณู ุงูุฒูุฑุงูู": { teachers: ["ุฃููุจ ุณูุทุงู ูุงุตุฑ ุงููุฑุฏู", "ูุญูู ุนุจุฏุงููู ุงูููุณูู"], gender: "male" },
                "ุฃุจู ุฃููุจ ุงูุญุถุฑูู": { teachers: ["ุนุจุฏุงููู ุจู ุณุนูุฏ ุจู ุนุงูุฑ ุงููุงุฆุฏู"], gender: "male" },
                "ุฃุจู ุชูุงู": { teachers: ["ูุงุดู ุฑุงุดุฏ ุณูู ุงููุงุดูู", "ุงููุนุชุตู ุจู ุนุจุฏุงููู ุจู ุนูู ุงููุธูุทู", "ุณุนูุฏ ูุญูุฏ ุงููุฎููู"], gender: "male" },
                "ุฃุญูุฏ ุจู ุงููุนูุงู": { teachers: ["ุทุงุฑู ููุณู ูุณูุฏ", "ุณูููุงู ุจู ุณุงูู ุจู ูุจุงุฑู ุงูุฑุฒููู", "ุนูุฑ ุจู ุณุนูุฏ ุจู ุนุจูุฏ ุงูุดูุฌู"], gender: "male" },
                "ุงูุดูุฎ ุณุงูู ุงูุณูุงุจู": { teachers: ["ุฅุจุฑุงููู ุจู ูุงุตุฑ ุจู ุฎููุณ ุงูุจูุณุนูุฏู", "ููุฏ ูุญูุฏ ุณุนูุฏ ุงูุฎุฑุจูุดู"], gender: "male" },
                "ุงูุดูุฎ ุณุนูุฏ ุงูููุฏู ูุณุงุฆู": { teachers: ["ูุญูุฏ ุณุนูุฏ ูุญุงุฏ ุงูุนูุฑู", "ุฑุงุดุฏ ุจู ุณุงูู ุจู ุฎููุงู ุงููุดููุฑู"], gender: "male" },
                "ุงูุดูุฎ ูุงุตุฑ ุงูุฎุฑูุตู": { teachers: ["ุนุฏูุงู ุญุณูู ูุญุงุฏ ุชุจูู"], gender: "male" },
                "ุฌูุงุฏุฉ ุงูุงุฒุฏู (ููุณู ุณุงุจูุง)": { teachers: ["ุฅุจุฑุงููู ุจู ูุญูุฏ ุจู ุญููุฏ ุงูุฑุงุณุจู", "ูุญูุฏ ุซุงูู ุฎููุงู ุงูุตูุทู", "ููุตูุฑ ุจู ูุญูุฏ ุจู ุฌูุนู", "ุงุณุงูุฉ ุจู ุณูููุงู ุงูุฏููุงูู", "ูุญููุฏ ุญูุฏ ุฎููุงู ุงููุญุฑููู"], gender: "male" },
                "ุญูุต ุจู ุฑุงุดุฏ": { teachers: ["ุณุนูุฏ ุจู ุณูู ุจู ูุงุตุฑ ุงูุฑุงุณุจู", "ุณูููุงู ุจู ุณูู ุจู ุณุงูู ุงููููุจู", "ุญููุฏ ุจู ุญูุฏ ุจู ูุฏูุจ ุงูุณุงุจุนู", "ุนุจุฏุงูุญููุฏ ุจู ูุญูุฏ ุจู ุนุจุฏุงูุฑุณูู ุงูุฒุฏุฌุงูู", "ูุญูุฏ ุจู ุงุญูุฏ ุจู ุฎุงูุฏ ุงูุฎุถูุฑู"], gender: "male" },
                "ุฎุฑูุณ ุงูุญุจูุณ": { teachers: ["ุนุจุฏุงููู ูุฑุฌ ุงูุญุฌุฑู"], gender: "male" },
                "ุณููู ุจู ุนูุฑู ุงูุนุงูุฑู": { teachers: ["ุฑุงุดุฏ ุจู ุณุงูู ุจู ุฎุงูุฏ ุงูุฑุดูุฏู", "ุนูุงุฑ ุจู ุนูู ุจู ุตุงูุญ ุงูุญูุงุฏู", "ูุญูุฏ ูุงุณู ุญูุฏุงู ุงููุงุตุฑู"], gender: "male" },
                "ูุนุจ ุจู ุฒูุฏ": { teachers: ["ุฃุญูุฏ ุจู ุณูููุงู ุจู ุณุงูู ุงูุญุณูู", "ููุณู ุจู ุนุจุฏุงููู ุจู ุณูู ุงูููุณูู"], gender: "male" },
                "ูุฒูุฏ ุงูุทุงุฆู": { teachers: [], gender: "male" },
                "ุงูุจูุงู": { teachers: ["ุฌููุงู ุนูู ูุญูุฏ ุงุญูุฏ ููุณู"], gender: "female" },
                "ุงูุฌูู ุงููุจุฏุน": { teachers: ["ุนููุงุก ุนุงุทู ุณูุฏ ูุญูุฏ"], gender: "female" },
                "ุงูุฑูุงุฏุฉ": { teachers: ["ุงุณูุงุก ุณุนุฏ ุณุนุฏ ุงุจุฑุงููู ุณุนุฏ", "Hossam mohammed Zayid"], gender: "mixed" },
                "ุงูุณุฑุงุฌ": { teachers: ["ุนุฒุงุก ุจูุช ูุญูุฏ ุจู ุญููุฏ ุงููุงููู"], gender: "female" },
                "ุงูุตููุฉ ุงููุนุจููุฉ": { teachers: ["ุฑุญูุฉ ูุญูุฏ ูุญูุฏ ุดููุงูู"], gender: "female" },
                "ุงููุฌุฏ": { teachers: ["ุขูู ุฑุถุง ุนุจุฏ ุงููุชุงุญ ุงูุนูููู ุญูุงูู"], gender: "female" },
                "ุงูุณ ุจู ูุงูู (ุงูููุงุฑ ุณุงุจูุง)": { teachers: ["ุงุณุฑุงุก ูุญูุฏ ุญุณูู"], gender: "female" },
                "ุถูุงุก ุงููุณุชูุจู": { teachers: ["ุนูุงุก ุงุญูุฏ ูุฒูุฑู"], gender: "female" },
                "ูุดุงุนู ูุณูุท ุณูุฑ ุงูุญุฏูุฏ": { teachers: ["ุฏููุง ุงุดุฑู ุญุจูุจ"], gender: "female" },
                "ููุงุจุน ุงูุชููู": { teachers: ["ููุง ูุญููุฏ ุงูุณูุฏ"], gender: "female" },
                "ุงุฌูุงู ุงูุซูุงูุฉ": { teachers: [], gender: "female" },
                "ุงุฌูุงู ุงููุฑุฏูุณ - ุงูุญูู": { teachers: [], gender: "female" },
                "ุฌููุฑ ุจู ุงูุฌููุฏู": { teachers: [], gender: "male" }
            };

            const defaultVisitTypesData = {
                 'custom_exploratory': {
                    name: 'ุฒูุงุฑุฉ ุงุณุชุทูุงุนูุฉ',
                    objectives_list: [
                        "ููุงุจูุฉ ูุฏูุฑุฉ ุงููุฏุฑุณุฉ ูุนููุฉุงูุฑูุงุถุฉ ุงููุฏุฑุณูุฉ.",
                        "ุญุถูุฑ ุงูุทุงุจูุฑ ุงููุฏุฑุณู.",
                        "ุชุญุฏูุซ ูุงุนุฏุฉ ุจูุงูุงุช ุงููุนููุฉ.",
                        "ูุชุงุจุนุฉ ููุงููุงุช ุงูุชุนููู.",
                        "ูุชุงุจุนุฉ ุชููุฑ ุงูุฃุฏูุฉ ููุชุงุจ ุงูุทุงูุจ ูุชุญุฏูุซูุง.",
                        "ูุชุงุจุนุฉ ุชูุฒูุน ุงูุฌุฏูู ููุตุงุจ ุงูุญุตุต ูููุนููุฉ.",
                        "ูุชุงุจุนุฉ ุงูููุงุนุจ ูุชุฎุทูุทูุง ูุงูุฃุฏูุงุช ุงูุฑูุงุถูุฉ.",
                        "ูุชุงุจุนุฉ ุงููุดุฑุงุช ููุซุงุฆู ุงูุชูููู ูููุงูุดุฉ ูุณุชุฌุฏุงุชูุง.",
                        "ูุชุงุจุนุฉ ุงููููุงุฌ ูุณุฌูุงุช ุงููุนููุฉ.",
                        "ุญุถูุฑ ุญุตุฉ ูููุนููุฉ ูุงููุฏุงููุฉ ุงูุงุดุฑุงููุฉ."
                    ],
                    completedOpinions: [
                        "ุชู ููุงุจูุฉ ูุฏูุฑุฉ ุงููุฏุฑุณุฉ ููุนููุฉ ุงูุฑูุงุถุฉ ุงููุฏุฑุณูุฉ.",
                        "ุชู ุญุถูุฑ ุงูุทุงุจูุฑ ุงููุฏุฑุณู ููุงู ุงููุชุงู ุจุตูุช ุนุงูู ูุงูุงูุตุฑุงู ููุธู ููุฑุงุณู ุฑูุน ุงูุนูู ุตุญูุญุฉ.",
                        "ุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุจูุงูุงุช ุงููุนููุฉ ุนุจุฑ ุงูุฑุงุจุท.",
                        "ุชู ูุชุงุจุนุฉ ููุงููุงุช ุงูุชุนููู ูุงููุนููุฉ ุนูู ุงูุงูุฉ ุงููุฏุฑุณุฉ.",
                        "ุชู ูุชุงุจุนุฉ ุชููุฑ ุงูุฃุฏูุฉ ูุชุญุฏูุซูุง ููุงูุช ูุญุฏุซุฉ.",
                        "ุชู ูุชุงุจุนุฉ ุชูุฒูุน ุงูุฌุฏูู ุงููุฏุฑุณู ููุงู ูุชูุงูููุง ูุน ุงูุฃูุธูุฉ.",
                        "ุชู ูุชุงุจุนุฉ ุงูููุงุนุจ ูุชุฎุทูุทูุง ูุงูุฃุฏูุงุช ุงูุฑูุงุถูุฉ ููุงูุช ูุชููุฑุฉ.",
                        "ุชู ูุชุงุจุนุฉ ุงููุดุฑุงุช ููุซุงุฆู ุงูุชูููู ูููุงูุดุฉ ูุณุชุฌุฏุงุชูุง.",
                        "ุชู ูุชุงุจุนุฉ ุงููููุงุฌ ูุณุฌูุงุช ุงููุนููุฉ ููุงูุช ููุชููุฉ ูุชู ุงุนุชูุงุฏ ุฎุทุท ุงููุนููุฉ ุงููุตููุฉ.",
                        "ุชู ุญุถูุฑ ูููู ุตูู ูููุนููุฉ ููุงู ุงูุฃุฏุงุก ุฌูุฏ ุฌุฏุง."
                    ],
                    incompleteOpinions: [
                        "ุชู ููุงุจูุฉ ูุฏูุฑุฉ ุงููุฏุฑุณุฉ ูุจุบูุงุจ ูุนููุฉ ุงูุฑูุงุถุฉ ุงููุฏุฑุณูุฉ.",
                        "ุชู ุญุถูุฑ ุงูุทุงุจูุฑ ุงููุฏุฑุณู ููุงู ุงููุชุงู ุจุตูุช ููุฎูุถ ูุงูุงูุตุฑุงู ุบูุฑ ููุธู ูุชูุงุญุธ ุงุฎุทุงุก ูู ูุฑุงุณู ุฑูุน ุงูุนูู ูุชู ุชูุฌูู ุงููุนูู ุงููุณุคูู ุนู ุงููุดุงูุฉ ุจุชุฏุฑูุจ ุงููุดุงูุฉ ุนูู ุงููุฑุงุณู ุงูุตุญูุญุฉ.",
                        "ูุงุนุฏุฉ ุจูุงูุงุช ุงููุนููุฉ ุจุญุงุฌุฉ ุฅูู ุชุญุฏูุซุ ูุชู ุงูุชูุจูู ุนูู ุถุฑูุฑุฉ ุงุณุชููุงููุง ุนุจุฑ ุงูุฑุงุจุท.",
                        "ุงููุนููุฉ ูู ุงุฌุฑุงุกุงุช ุงูุชุนููู.", // Default for the dropdown
                        "ุชู ูุชุงุจุนุฉ ุชููุฑ ุงูุฃุฏูุฉ ูุชุญุฏูุซูุง ููุงูุช ูุญุฏุซุฉ ุจุตูุบุฉ (PDF).",
                        "ุชู ูุชุงุจุนุฉ ุชูุฒูุน ุงูุฌุฏูู ุงููุฏุฑุณู ูุชูุงุญุธ ูุฌูุฏ ุญุตุต ููุฒุนุฉ ูู ุงูุฌุฏูู ุงูุณุงุจุนุฉ ูุงูุซุงููุฉ ููุฐูู ุชูุฑูุบ ุงููุนููุฉ ููู ุงูุซูุงุซุงุก ุจุฏูู ุนุฐุฑ ููุจูู ูุชู ุชูุฌูู ุงุฏุงุฑุฉ ุงููุฏุฑุณุฉ ุจุชุนุฏูู ุฐูู ูุงูุงุจุชุนุงุฏ ุนู ุงูุญุตุต ุงูุฃุฎูุฑุฉ.",
                        "ุชู ูุชุงุจุนุฉ ุงูููุงุนุจ ูุชุฎุทูุทูุง ูุงูุฃุฏูุงุช ุงูุฑูุงุถูุฉ ูุชูุงุญุธ ุนุฏู ูุฌูุฏ ุฃุฏูุงุช ุฑูุงุถูุฉ ูู ุงููุฏุฑุณุฉ ูุชู ุชูุฌูู ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ ุจุชูููุฑ ุงูุฃุฏูุงุช ูุชุฌุฏูุฏ ุชุฎุทูุท ุงูููุนุจ.",
                        "ุชู ูุชุงุจุนุฉ ุงููุดุฑุงุช ููุซุงุฆู ุงูุชูููู ูููุงูุดุฉ ูุณุชุฌุฏุงุชูุง ูููุญุธ ุนุฏู ูุตูู ุงููุดุฑุงุช ุงูู ุงููุนูููู ูุชู ุงุฑุณุงู ุงููุดุฑุงุช ูุงููุซุงุฆู ูุฑุฉ ุงุฎุฑู ุงูู ุงููุนูููู ุนุจุฑ ุงููุชุณุงุจ.",
                        "ุชู ูุชุงุจุนุฉ ุงููููุงุฌ ูุณุฌูุงุช ุงููุนููุฉ ููุงูุช ุบูุฑ ููุชููุฉุ ูุชู ุชูุฌูู ุงููุนููุฉ ูุงุณุชููุงููุง.",
                        "ุชุนุฐุฑ ุญุถูุฑ ุญุตุฉ ูุน ุงููุนููุฉ."
                    ],
                    recommendations: [
                        "ูุชุงุจุนุฉ ุงูุชุฒุงู ุงูููุฆุฉ ุงูุชุฏุฑูุณูุฉ ุจุงูุญุถูุฑ.",
                        "ูุชุงุจุนุฉ ุชุฏุฑูุจ ุงููุดุงูุฉ ุนูู ูุฑุงุณู ุฑูุน ุงูุนูู ุงูุตุญูุญุฉ ูุชุญุณูู ุชูุธูู ุงูุตุฑุงู ุงูุทูุจุฉ.",
                        "ุงูุชุฃููุฏ ุนูู ุชุญุฏูุซ ูุงุนุฏุฉ ุจูุงูุงุช ุงููุนููุฉ ุจุดูู ุฏูุฑู.",
                        "ุถุฑูุฑุฉ ุงูุฅุณุฑุงุน ูู ุงุณุชููุงู ููุงููุงุช ุงูุชุนููู ุงูุฑุณููุฉ.",
                        "ุงูุชูุงุตู ูุน ุงูุฌูุงุช ุงููุนููุฉ ูุชูููุฑ ุงููุชุจ ุงููุฏุฑุณูุฉ ุงููุงูุตุฉ.",
                        "ุชุบููุฑ ุฌุฏูู ุงููุนููุฉ ููููู ูุฏููุง ุญุตุฉ ุฑูุงุถุฉ ูู ูููุ ูุชูุฒูุน ุงูุญุตุต ุจุญูุซ ูุชู ุงูุงุจุชุนุงุฏ ุนู ุงูุญุตุฉ ุงูุณุงุจุนุฉ ูุงูุซุงููุฉ.",
                        "ุชูููุฑ ุงูุฃุฏูุงุช ุงูุฑูุงุถูุฉ ุญุณุจ ุงููุดู ุงููุฑูู ููุฎุต ุจุงูุฐูุฑ (ุฌูุงุฒ ุงููุซุจ ุงูุนุงูู ูุน ุงููุฑุชุจุฉ ุงูุฎุงุตุฉ ุจูุ ุงูุตูุฏูู ุงูููุณูุ ุงูููุนุฏ ุงูุณููุฏูุ ูุฑูู ููุฑุฉ ุงููุฏ ุนุฏุฏ (2)ุ ููุงุฆู ููุณูุฉ ุนุฏุฏ (2)ุ ุดุจู ููุฑุฉ ุงูุทุงุฆุฑุฉ) ุจุงูุฅุถุงูุฉ ูุจุงูู ุงูุฃุฏูุงุช ูู ุงููุดูุ ูุชุฌุฏูุฏ ุชุฎุทูุท ุงูููุนุจ.",
                        "ุงูุชุฃููุฏ ุนูู ูุตูู ุฌููุน ุงููุดุฑุงุช ูุงููุซุงุฆู ูููุนูููู ูุชูุซูู ุงุณุชูุงููู ููุง.",
                        "ูุชุงุจุนุฉ ุงุณุชููุงู ุณุฌูุงุช ุงููุนููุฉ (ุงูุชุญุถูุฑ+ุงูุฒู ูุงูููุงุญุธุฉ+ุงูุฎุทุฉ).",
                        "ุงูุชูุณูู ุงููุณุจู ูุน ุงููุนููุฉ ูุญุถูุฑ ุญุตุฉ ุฏุฑุงุณูุฉ."
                    ]
                }
            };
            
            // --- STATE VARIABLES ---
            let visitTypesData = {};
            let savedReports = [];
            let currentAttachments = [];
            let currentVisitTypeKey = '';
            let previewSource = 'form';

            // --- MAIN VIEWS ---
            const dashboardView = document.getElementById('dashboardView');
            const formView = document.getElementById('formView');
            const reportPreviewContainer = document.getElementById('reportPreviewContainer');
            
            // --- FORM ELEMENTS ---
            const reportForm = document.getElementById('reportForm');
            const reportIdInput = document.getElementById('reportId');
            const formTitle = document.getElementById('formTitle');
            const schoolNameSelect = document.getElementById('schoolName');
            const visitTypeSelect = document.getElementById('visitTypeSelect');
            const objectivesContainer = document.getElementById('objectivesContainer');
            const opinionsContainer = document.getElementById('opinionsContainer');
            const recommendationsTextarea = document.getElementById('recommendations');
            const attachmentsInput = document.getElementById('attachmentsInput');
            const attachmentsList = document.getElementById('attachmentsList');

            // --- BUTTONS ---
            const addNewReportBtn = document.getElementById('addNewReportBtn');
            const backToDashboardBtn = document.getElementById('backToDashboardBtn');
            const prepareReportBtn = document.getElementById('prepareReportBtn');
            const backToBtn = document.getElementById('backToBtn');
            const selectAllObjectivesBtn = document.getElementById('selectAllObjectivesBtn');
            const copyAllBtn = document.getElementById('copyAllBtn');

            // --- DASHBOARD ELEMENTS ---
            const reportsListContainer = document.getElementById('reportsListContainer');
            
            // --- MODAL ELEMENTS ---
            const manageVisitTypesBtn = document.getElementById('manageVisitTypesBtn');
            const manageTypesModal = document.getElementById('manageTypesModal');
            const closeManageModalBtn = document.getElementById('closeManageModalBtn');
            const visitTypesList = document.getElementById('visitTypesList');
            const addNewTypeBtn = document.getElementById('addNewTypeBtn');
            const addEditTypeModal = document.getElementById('addEditTypeModal');
            const addEditModalTitle = document.getElementById('addEditModalTitle');
            const addEditTypeForm = document.getElementById('addEditTypeForm');
            const editTypeKeyInput = document.getElementById('editTypeKey');
            const typeNameInput = document.getElementById('typeName');
            const typeObjectivesTextarea = document.getElementById('typeObjectives');
            const saveTypeBtn = document.getElementById('saveTypeBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const generateRecsBtn = document.getElementById('generate-recommendations-btn');

            // --- DATA MANAGEMENT ---
            function saveVisitTypes() { localStorage.setItem(TYPES_STORAGE_KEY, JSON.stringify(visitTypesData)); }
            function saveReports() { localStorage.setItem(REPORTS_STORAGE_KEY, JSON.stringify(savedReports)); }

            function loadData() {
                const storedTypes = localStorage.getItem(TYPES_STORAGE_KEY);
                visitTypesData = storedTypes ? JSON.parse(storedTypes) : defaultVisitTypesData;
                const storedReports = localStorage.getItem(REPORTS_STORAGE_KEY);
                savedReports = storedReports ? JSON.parse(storedReports) : [];
                const keys = Object.keys(visitTypesData);
                currentVisitTypeKey = keys.length > 0 ? keys[0] : '';
            }

            // --- GENDER/PLURALITY LOGIC ---
            function getTeacherContext(schoolName) {
                const school = schoolTeacherData[schoolName];
                if (!school || !school.teachers) {
                    const isFemaleSchool = !schoolName.includes("ุจููู");
                    return { gender: isFemaleSchool ? 'female' : 'male', count: 1, teachers: [] };
                }
                if (school.gender === 'mixed' || school.teachers.length > 1) {
                    return { gender: 'plural', count: school.teachers.length, teachers: school.teachers };
                }
                return { gender: school.gender, count: 1, teachers: school.teachers };
            }

            function applyGender(text, context) {
                if (!text) return "";
                if (context.count > 1) {
                    return text.replace(/ูุฏูุฑุฉ/g, 'ูุฏูุฑ')
                               .replace(/ูุนููุฉุงูุฑูุงุถุฉ/g, 'ูุนููู ุงูุฑูุงุถุฉ')
                               .replace(/ุงููุนููุฉ/g, 'ุงููุนูููู')
                               .replace(/ูุนููุฉ/g, 'ูุนููู')
                               .replace(/ููู /g, 'ููู ')
                               .replace(/ูุฏููุง/g, 'ูุฏููู');
                } else if (context.gender === 'male') {
                     return text.replace(/ูุฏูุฑุฉ/g, 'ูุฏูุฑ')
                               .replace(/ูุนููุฉุงูุฑูุงุถุฉ/g, 'ูุนูู ุงูุฑูุงุถุฉ')
                               .replace(/ุงููุนููุฉ/g, 'ุงููุนูู')
                               .replace(/ูุนููุฉ/g, 'ูุนูู')
                               .replace(/ููู /g, 'ููู ')
                               .replace(/ูุฏููุง/g, 'ูุฏูู');
                }
                return text;
            }


            // --- VIEW MANAGEMENT ---
            function showDashboardView() {
                renderDashboard();
                dashboardView.classList.remove('hidden');
                formView.classList.add('hidden');
                reportPreviewContainer.classList.add('hidden');
            }

            function showFormView(reportId = null) {
                formView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                reportPreviewContainer.classList.add('hidden');
                if (reportId) {
                    const report = savedReports.find(r => r.id === reportId);
                    if (report) {
                        populateForm(report);
                        formTitle.textContent = 'ุชุนุฏูู ุชูุฑูุฑ ุฒูุงุฑุฉ';
                    }
                } else {
                    resetForm();
                    formTitle.textContent = 'ุฅูุดุงุก ุชูุฑูุฑ ุฒูุงุฑุฉ ุฅุดุฑุงููุฉ';
                }
            }

            function showPreviewView(reportData) {
                renderReportPreview(reportData);
                reportPreviewContainer.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                formView.classList.add('hidden');
            }

            // --- DASHBOARD RENDERING ---
            function renderDashboard() {
                reportsListContainer.innerHTML = '';
                if (savedReports.length === 0) {
                    reportsListContainer.innerHTML = `<div class="text-center py-10 px-6 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-700">ูุง ุชูุฌุฏ ุชูุงุฑูุฑ ูุญููุธุฉ ุจุนุฏ</h3>
                        <p class="text-gray-500 mt-2">ุงุจุฏุฃ ุจุฅุถุงูุฉ ุชูุฑูุฑู ุงูุฃูู ุจุงูุถุบุท ุนูู ุฒุฑ "+ ุชูุฑูุฑ ุฌุฏูุฏ".</p>
                    </div>`;
                    return;
                }

                const list = document.createElement('div');
                list.className = 'space-y-4';
                savedReports.sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate)).forEach(report => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-4 bg-white border rounded-lg shadow-sm hover:shadow-md transition-shadow';
                    const reportDate = new Date(report.visitDate).toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric' });
                    const attachmentIcon = (report.attachments && report.attachments.length > 0) ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a3 3 0 006 0V7a1 1 0 112 0v4a5 5 0 01-10 0V7a5 5 0 0110 0v4a1 1 0 11-2 0V7a3 3 0 00-3-3z" clip-rule="evenodd" /></svg>` : '';
                    item.innerHTML = `
                        <div class="flex items-center">
                            ${attachmentIcon}
                            <div>
                                <p class="font-bold text-gray-800">${report.schoolName}</p>
                                <p class="text-sm text-gray-500">${reportDate} - ${report.visitTypeName}</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button data-id="${report.id}" class="view-btn text-sm text-green-600 hover:underline">ุนุฑุถ</button>
                            <button data-id="${report.id}" class="edit-btn text-sm text-blue-600 hover:underline">ุชุนุฏูู</button>
                            <button data-id="${report.id}" class="delete-btn text-sm text-red-600 hover:underline">ุญุฐู</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
                reportsListContainer.appendChild(list);
            }

            // --- FORM MANAGEMENT ---
            function resetForm() {
                reportForm.reset();
                reportIdInput.value = '';
                document.getElementById('visitDate').valueAsDate = new Date();
                currentVisitTypeKey = Object.keys(visitTypesData)[0] || '';
                visitTypeSelect.value = currentVisitTypeKey;
                currentAttachments = [];
                renderAttachmentsList();
                renderObjectivesForCurrentType();
            }
            
            function populateForm(report) {
                resetForm();
                reportIdInput.value = report.id;
                schoolNameSelect.value = report.schoolName;
                document.getElementById('visitDate').value = report.visitDate;
                recommendationsTextarea.value = report.recommendations;
                
                currentVisitTypeKey = report.visitTypeKey;
                visitTypeSelect.value = currentVisitTypeKey;
                currentAttachments = report.attachments || [];
                renderAttachmentsList();
                renderObjectivesForCurrentType();

                const checkboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    if (report.checkedObjectives.includes(cb.dataset.genderedValue)) {
                        cb.checked = true;
                    }
                });

                updateOpinionsSection();

                setTimeout(() => {
                     report.opinions.forEach(op => {
                        const textarea = document.getElementById(`opinion-${op.index}`);
                        if (textarea) textarea.value = op.text;
                    });
                }, 0);
            }

            function populateVisitTypeDropdown() {
                visitTypeSelect.innerHTML = '';
                Object.keys(visitTypesData).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = visitTypesData[key].name;
                    visitTypeSelect.appendChild(option);
                });
                if (currentVisitTypeKey) {
                    visitTypeSelect.value = currentVisitTypeKey;
                }
            }
            
            function renderObjectivesForCurrentType() {
                if (!currentVisitTypeKey || !visitTypesData[currentVisitTypeKey]) return;
                const schoolName = schoolNameSelect.value;
                const context = getTeacherContext(schoolName);
                const data = visitTypesData[currentVisitTypeKey];
                objectivesContainer.innerHTML = '';
                data.objectives_list.forEach((objective, index) => {
                    const genderedObjective = applyGender(objective, context);
                    objectivesContainer.innerHTML += `
                        <div class="flex items-start">
                            <input id="objective-${index}" type="checkbox" value="${objective}" data-gendered-value="${genderedObjective}" data-index="${index}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mt-1">
                            <label for="objective-${index}" class="mr-2 text-sm font-medium text-gray-900">${index + 1}- ${genderedObjective}</label>
                        </div>`;
                });
                updateOpinionsSection();
                updateSelectAllButtonState();
            }


            function updateSelectAllButtonState() {
                const checkboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]');
                if (checkboxes.length === 0) {
                    selectAllObjectivesBtn.textContent = 'ุงุฎุชูุงุฑ ุงููู';
                    return;
                }
                const allSelected = Array.from(checkboxes).every(cb => cb.checked);
                selectAllObjectivesBtn.textContent = allSelected ? 'ุฅูุบุงุก ุงุฎุชูุงุฑ ุงููู' : 'ุงุฎุชูุงุฑ ุงููู';
            }

            function updateOpinionsSection() {
                const previouslySavedOpinions = new Map();
                opinionsContainer.querySelectorAll('.opinion-block textarea').forEach(textarea => {
                    previouslySavedOpinions.set(textarea.id, textarea.value);
                });

                opinionsContainer.innerHTML = '';
                const checkedCheckboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]:checked');
                
                if (checkedCheckboxes.length === 0) {
                    opinionsContainer.innerHTML = '<p class="text-center text-gray-500">ูู ูุชู ุชุญุฏูุฏ ุฃู ูุฏู ุจุนุฏ.</p>';
                    return;
                }
                
                checkedCheckboxes.forEach(checkbox => {
                    const index = checkbox.dataset.index;
                    const baseObjectiveText = checkbox.value;
                    const genderedObjectiveText = checkbox.dataset.genderedValue;
                    const opinionId = `opinion-${index}`;
                    
                    const opinionBlock = document.createElement('div');
                    opinionBlock.className = 'opinion-block space-y-2';

                    let specialInputsHTML = '';
                    let standardButtonsHTML = `
                        <div class="flex gap-2">
                            <button type="button" data-opinion="completed" data-index="${index}" class="px-3 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full hover:bg-green-200 transition-colors">โ ููุชูู</button>
                            <button type="button" data-opinion="incomplete" data-index="${index}" class="px-3 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full hover:bg-red-200 transition-colors">โ ุบูุฑ ููุชูู</button>
                        </div>`;

                    const timetableObjectiveText = "ูุชุงุจุนุฉ ุชูุฒูุน ุงูุฌุฏูู ููุตุงุจ ุงูุญุตุต ูููุนููุฉ.";
                    const approvalObjectiveText = "ูุชุงุจุนุฉ ููุงููุงุช ุงูุชุนููู.";
                    const classSessionObjectiveText = "ุญุถูุฑ ุญุตุฉ ูููุนููุฉ ูุงููุฏุงููุฉ ุงูุงุดุฑุงููุฉ.";

                    if (baseObjectiveText === timetableObjectiveText) {
                         specialInputsHTML = `
                            <div class="p-3 bg-gray-100 rounded-md border space-y-3">
                                <div id="teacher-rows-container-${index}" class="space-y-2">
                                    <div class="grid grid-cols-4 gap-2 items-center teacher-timetable-row">
                                        <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md teacher-name-input" placeholder="ุงุณู ุงููุนูู">
                                        <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md teacher-load-input" placeholder="ูุตุงุจ ุงูุญุตุต">
                                        <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md teacher-classes-input" placeholder="ุงูุตููู ุงูุชู ูุฏุฑุณูุง">
                                        <span></span>
                                    </div>
                                </div>
                                <button type="button" data-index="${index}" class="add-teacher-btn text-sm text-blue-600 hover:underline">+ ุฅุถุงูุฉ ูุนูู</button>
                            </div>
                        `;
                    } else if (baseObjectiveText === approvalObjectiveText) {
                        specialInputsHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 p-3 bg-gray-100 rounded-md border items-center">
                                <div>
                                    <label for="approval-status-${index}" class="text-xs text-gray-600 block mb-1">ูู ุญุงูุฉ ุนุฏู ุงูุงูุชูุงูุ ุงุฎุชุฑ ุงูุณุจุจ:</label>
                                    <select id="approval-status-${index}" data-index="${index}" class="approval-status-select bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                        <option value="" selected>ุงุฎุชุฑ ุงูุณุจุจ...</option>
                                        <option value="in_progress">ูู ุงุฌุฑุงุกุงุช ุงูุชุนููู</option>
                                        <option value="no_approval">ููุณ ูุฏููุง ููุงููุฉ ุชุนููู</option>
                                        <option value="expired">ุงูููุงููุฉ ุงููุจุฏุฆูุฉ ููุชููุฉ ุงูุตูุงุญูุฉ</option>
                                    </select>
                                </div>
                                <div class="self-end">
                                    <button type="button" data-opinion="completed" data-index="${index}" data-special="approval" class="w-full px-3 py-2.5 text-sm font-medium text-green-800 bg-green-100 rounded-lg hover:bg-green-200 transition-colors">โ ููุชูู</button>
                                </div>
                            </div>
                        `;
                        standardButtonsHTML = '';
                    } else if (baseObjectiveText === classSessionObjectiveText) {
                        specialInputsHTML = `
                            <div class="p-3 bg-gray-100 rounded-md border space-y-3">
                                <div id="session-rows-container-${index}" class="space-y-2">
                                    <div class="grid grid-cols-6 gap-2 items-center session-row">
                                        <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md lesson-number-input" placeholder="ุฑูู ุงูุญุตุฉ">
                                        <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md lesson-name-input" placeholder="ุงูุฏุฑุณ">
                                        <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md class-name-input" placeholder="ุงูุตู/ุงูุดุนุจุฉ">
                                        <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md teacher-name-input" placeholder="ุงุณู ุงููุนูู">
                                        <select class="w-full text-sm p-1.5 border-gray-300 rounded-md performance-level-select bg-white">
                                            <option value="ููุชุงุฒ">ููุชุงุฒ</option>
                                            <option value="ุฌูุฏ ุฌุฏุง">ุฌูุฏ ุฌุฏุง</option>
                                            <option value="ุฌูุฏ">ุฌูุฏ</option>
                                            <option value="ููุจูู">ููุจูู</option>
                                            <option value="ุถุนูู">ุถุนูู</option>
                                        </select>
                                        <span></span>
                                    </div>
                                </div>
                                <button type="button" data-index="${index}" class="add-session-btn text-sm text-blue-600 hover:underline">+ ุฅุถุงูุฉ ุญุตุฉ</button>
                            </div>
                        `;
                    }


                    opinionBlock.innerHTML = `
                        <label for="${opinionId}" class="block text-sm font-semibold text-gray-800">${parseInt(index) + 1}- ${genderedObjectiveText}</label>
                        ${specialInputsHTML}
                        ${standardButtonsHTML}
                        <textarea id="${opinionId}" name="${opinionId}" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 mt-2" placeholder="..."></textarea>
                    `;

                    opinionsContainer.appendChild(opinionBlock);
                });
                
                previouslySavedOpinions.forEach((value, id) => {
                    const textarea = document.getElementById(id);
                    if (textarea) textarea.value = value;
                });
            }

            // --- ATTACHMENTS HANDLING ---
            function renderAttachmentsList() {
                attachmentsList.innerHTML = '';
                if (currentAttachments.length === 0) return;
                currentAttachments.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-md text-sm';
                    item.innerHTML = `
                        <span class="text-gray-700 truncate">${file.name}</span>
                        <button type="button" data-index="${index}" class="remove-attachment-btn text-red-500 hover:text-red-700">&times;</button>
                    `;
                    attachmentsList.appendChild(item);
                });
            }

            attachmentsInput.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        currentAttachments.push({ name: file.name, data: event.target.result });
                        renderAttachmentsList();
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = '';
            });

            attachmentsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-attachment-btn')) {
                    currentAttachments.splice(e.target.dataset.index, 1);
                    renderAttachmentsList();
                }
            });


            // --- REPORT PREVIEW ---
            function renderReportPreview(data) {
                const reportContent = document.getElementById('reportContent');
                const visitDate = new Date(data.visitDate).toLocaleDateString('ar-OM');
                let reportHTML = `<h2 class="text-2xl font-bold mb-4 text-center">ุชูุฑูุฑ ุฒูุงุฑุฉ ุฅุดุฑุงููุฉ</h2>`;
                reportHTML += `<div class="grid grid-cols-2 gap-4 mb-6 border-b pb-4">
                                <p><strong>ุงุณู ุงููุฏุฑุณุฉ:</strong> ${data.schoolName}</p>
                                <p><strong>ุชุงุฑูุฎ ุงูุฒูุงุฑุฉ:</strong> ${visitDate}</p>
                                <p class="col-span-2"><strong>ููุน ุงูุฒูุงุฑุฉ:</strong> ${data.visitTypeName}</p>
                               </div>`;
                
                reportHTML += `<div id="reportObjectives"><h3 class="text-xl font-semibold mt-6 mb-3">ุฃูุฏุงู ุงูุฒูุงุฑุฉ:</h3><ol class="list-decimal list-inside space-y-2">`;
                data.checkedObjectives.forEach(obj => { reportHTML += `<li>${obj}</li>`; });
                reportHTML += `</ol></div>`;
                
                reportHTML += `<div id="reportOpinions"><h3 class="text-xl font-semibold mt-6 mb-3">ุฑุฃู ุงูุฒุงุฆุฑ:</h3><ol class="list-decimal list-inside space-y-2">`;
                data.opinions.sort((a,b) => a.index - b.index).forEach(op => { reportHTML += `<li class="text-gray-700">${op.text.replace(/\n/g, '<br>')}</li>`; });
                reportHTML += `</ol></div>`;

                if(data.recommendations) {
                    reportHTML += `<div id="reportRecommendations"><h3 class="text-xl font-semibold mt-6 mb-3">ุงูุชูุตูุงุช:</h3><p class="text-gray-700">${data.recommendations.replace(/\n/g, '<br>')}</p></div>`;
                }

                if(data.attachments && data.attachments.length > 0) {
                     reportHTML += `<div id="reportAttachments"><h3 class="text-xl font-semibold mt-6 mb-3">ุงููุฑููุงุช:</h3><ul class="list-disc list-inside space-y-1">`;
                     data.attachments.forEach(file => {
                         reportHTML += `<li class="text-gray-700">${file.name}</li>`;
                     });
                     reportHTML += `</ul></div>`;
                }
                
                reportContent.innerHTML = reportHTML;
            }

            // --- EVENT LISTENERS ---
            addNewReportBtn.addEventListener('click', () => showFormView());
            backToDashboardBtn.addEventListener('click', showDashboardView);
            
            reportForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const reportId = reportIdInput.value;
                const checkedObjectives = Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => cb.dataset.genderedValue);
                const opinions = Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => {
                    return { index: cb.dataset.index, text: document.getElementById(`opinion-${cb.dataset.index}`).value };
                });

                const reportData = {
                    id: reportId ? reportId : `report_${Date.now()}`,
                    schoolName: document.getElementById('schoolName').value,
                    visitDate: document.getElementById('visitDate').value,
                    visitTypeKey: currentVisitTypeKey,
                    visitTypeName: visitTypesData[currentVisitTypeKey].name,
                    checkedObjectives, opinions,
                    recommendations: recommendationsTextarea.value,
                    attachments: currentAttachments
                };

                if (reportId) {
                    const index = savedReports.findIndex(r => r.id === reportId);
                    savedReports[index] = reportData;
                } else {
                    savedReports.push(reportData);
                }
                saveReports();
                showDashboardView();
            });
            
            prepareReportBtn.addEventListener('click', function() {
                if (!reportForm.checkValidity()) {
                    reportForm.reportValidity();
                    return;
                }
                previewSource = 'form';
                const checkedObjectives = Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => cb.dataset.genderedValue);
                 const opinions = Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => {
                    return { index: cb.dataset.index, text: document.getElementById(`opinion-${cb.dataset.index}`).value };
                });
                const reportData = {
                    schoolName: document.getElementById('schoolName').value,
                    visitDate: document.getElementById('visitDate').value,
                    visitTypeName: visitTypesData[currentVisitTypeKey].name,
                    checkedObjectives, opinions,
                    recommendations: recommendationsTextarea.value,
                    attachments: currentAttachments
                };
                showPreviewView(reportData);
            });

            backToBtn.addEventListener('click', () => {
                if (previewSource === 'dashboard') {
                    showDashboardView();
                } else {
                    showFormView(reportIdInput.value || null);
                }
            });
            
            copyAllBtn.addEventListener('click', () => {
                const reportObjectives = document.getElementById('reportObjectives');
                const reportOpinions = document.getElementById('reportOpinions');
                const reportRecommendations = document.getElementById('reportRecommendations');

                let textToCopy = "";

                if (reportObjectives) {
                    textToCopy += "ุฃูุฏุงู ุงูุฒูุงุฑุฉ:\n";
                    reportObjectives.querySelectorAll('li').forEach((li, index) => {
                        textToCopy += `${index + 1}- ${li.textContent.trim()}\n`;
                    });
                    textToCopy += "\n";
                }

                if (reportOpinions) {
                    textToCopy += "ุฑุฃู ุงูุฒุงุฆุฑ:\n";
                    reportOpinions.querySelectorAll('li').forEach((li, index) => {
                        textToCopy += `${index + 1}- ${li.innerText.trim()}\n`;
                    });
                    textToCopy += "\n";
                }

                if (reportRecommendations && reportRecommendations.querySelector('p')) {
                    textToCopy += "ุงูุชูุตูุงุช:\n";
                    textToCopy += reportRecommendations.querySelector('p').innerText.trim();
                }

                const textArea = document.createElement("textarea");
                textArea.value = textToCopy.trim();
                textArea.style.position = "fixed";
                textArea.style.top = 0;
                textArea.style.left = 0;
                textArea.style.opacity = 0;

                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                    copyAllBtn.textContent = 'ุชู ุงููุณุฎ!';
                    copyAllBtn.classList.replace('bg-blue-700', 'bg-green-600');
                    copyAllBtn.classList.replace('hover:bg-blue-800', 'hover:bg-green-700');
                    setTimeout(() => {
                        copyAllBtn.textContent = 'ูุณุฎ ุงููู';
                        copyAllBtn.classList.replace('bg-green-600', 'bg-blue-700');
                        copyAllBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-800');
                    }, 2000);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('ูุดู ุงููุณุฎ!');
                }

                document.body.removeChild(textArea);
            });

            reportsListContainer.addEventListener('click', (e) => {
                const target = e.target;
                const reportId = target.dataset.id;
                if (!reportId) return;
                if (target.classList.contains('view-btn')) {
                    previewSource = 'dashboard';
                    const report = savedReports.find(r => r.id === reportId);
                    showPreviewView(report);
                }
                if (target.classList.contains('edit-btn')) {
                    showFormView(reportId);
                }
                if (target.classList.contains('delete-btn')) {
                    const report = savedReports.find(r => r.id === reportId);
                    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุชูุฑูุฑ ูุฏุฑุณุฉ "${report.schoolName}"ุ`)) {
                        savedReports = savedReports.filter(r => r.id !== reportId);
                        saveReports();
                        renderDashboard();
                    }
                }
            });
            
            schoolNameSelect.addEventListener('change', renderObjectivesForCurrentType);
            visitTypeSelect.addEventListener('change', (e) => {
                currentVisitTypeKey = e.target.value;
                renderObjectivesForCurrentType();
            });

            objectivesContainer.addEventListener('change', (e) => {
                updateOpinionsSection();
                updateSelectAllButtonState();
            });

            selectAllObjectivesBtn.addEventListener('click', () => {
                const checkboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]');
                if (checkboxes.length === 0) return;
                const allSelected = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => { cb.checked = !allSelected; });
                updateOpinionsSection();
                updateSelectAllButtonState();
            });

            opinionsContainer.addEventListener('click', (e) => {
                 if (e.target.matches('.add-teacher-btn, .remove-teacher-btn, .add-session-btn, .remove-session-btn')) {
                    const opinionBlock = e.target.closest('.opinion-block');
                    if(e.target.matches('.add-teacher-btn')) {
                        const container = opinionBlock.querySelector('[id^="teacher-rows-container"]');
                        const newRow = document.createElement('div');
                        newRow.className = 'grid grid-cols-4 gap-2 items-center teacher-timetable-row';
                        newRow.innerHTML = `
                            <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md teacher-name-input" placeholder="ุงุณู ุงููุนูู">
                            <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md teacher-load-input" placeholder="ูุตุงุจ ุงูุญุตุต">
                            <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md teacher-classes-input" placeholder="ุงูุตููู ุงูุชู ูุฏุฑุณูุง">
                            <button type="button" class="remove-teacher-btn text-red-500 hover:text-red-700 text-lg font-bold">ร</button>
                        `;
                        container.appendChild(newRow);
                    } else if (e.target.matches('.remove-teacher-btn')) {
                         e.target.closest('.teacher-timetable-row').remove();
                    } else if (e.target.matches('.add-session-btn')) {
                        const container = opinionBlock.querySelector('[id^="session-rows-container"]');
                        const newRow = document.createElement('div');
                        newRow.className = 'grid grid-cols-6 gap-2 items-center session-row mt-2';
                        newRow.innerHTML = `
                            <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md lesson-number-input" placeholder="ุฑูู ุงูุญุตุฉ">
                            <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md lesson-name-input" placeholder="ุงูุฏุฑุณ">
                            <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md class-name-input" placeholder="ุงูุตู/ุงูุดุนุจุฉ">
                            <input type="text" class="w-full text-sm p-1.5 border-gray-300 rounded-md teacher-name-input" placeholder="ุงุณู ุงููุนูู">
                            <select class="w-full text-sm p-1.5 border-gray-300 rounded-md performance-level-select bg-white">
                                <option value="ููุชุงุฒ">ููุชุงุฒ</option>
                                <option value="ุฌูุฏ ุฌุฏุง">ุฌูุฏ ุฌุฏุง</option>
                                <option value="ุฌูุฏ">ุฌูุฏ</option>
                                <option value="ููุจูู">ููุจูู</option>
                                <option value="ุถุนูู">ุถุนูู</option>
                            </select>
                            <button type="button" class="remove-session-btn text-red-500 hover:text-red-700 text-lg font-bold">ร</button>
                        `;
                        container.appendChild(newRow);
                    } else if (e.target.matches('.remove-session-btn')) {
                         e.target.closest('.session-row').remove();
                    }
                    return; // Prevent opinion text generation on these button clicks
                }

                if(e.target.matches('button[data-opinion]')) {
                    const opinionType = e.target.dataset.opinion;
                    const index = e.target.dataset.index;
                    const opinionBlock = e.target.closest('.opinion-block');
                    const textarea = opinionBlock.querySelector('textarea');
                    const existingText = textarea.value.trim();
                    const schoolName = schoolNameSelect.value;
                    const context = getTeacherContext(schoolName);
                    
                    let generatedText = '';

                    if (opinionType === 'incomplete') {
                        let baseOpinionText = visitTypesData[currentVisitTypeKey].incompleteOpinions[index];
                        generatedText = applyGender(baseOpinionText, context);
                    } else { // opinionType === 'completed'
                        const baseObjectiveText = visitTypesData[currentVisitTypeKey].objectives_list[index];
                        const timetableObjectiveText = "ูุชุงุจุนุฉ ุชูุฒูุน ุงูุฌุฏูู ููุตุงุจ ุงูุญุตุต ูููุนููุฉ.";
                        const classSessionObjectiveText = "ุญุถูุฑ ุญุตุฉ ูููุนููุฉ ูุงููุฏุงููุฉ ุงูุงุดุฑุงููุฉ.";
                        let baseOpinionText = visitTypesData[currentVisitTypeKey].completedOpinions[index];
                        generatedText = applyGender(baseOpinionText, context);

                        if (e.target.dataset.special === 'approval') {
                            const dropdown = opinionBlock.querySelector('.approval-status-select');
                            if (dropdown) dropdown.value = '';
                        } else if (baseObjectiveText === timetableObjectiveText) {
                            let summary = "ุชูุช ูุชุงุจุนุฉ ุชูุฒูุน ุงูุฌุฏูู ุงููุฏุฑุณูุ ููุงูุช ุงูุฃูุตุจุฉ ูุงูุชุงูู:\n";
                            const teacherRows = opinionBlock.querySelectorAll('.teacher-timetable-row');
                            let detailsFound = false;
                            teacherRows.forEach(row => {
                                const teacherName = row.querySelector('.teacher-name-input').value;
                                const load = row.querySelector('.teacher-load-input').value;
                                const classes = row.querySelector('.teacher-classes-input').value;
                                if (teacherName || load || classes) {
                                    detailsFound = true;
                                    summary += `- ${teacherName || 'ูุนูู ุบูุฑ ูุณูู'}: ูุตุงุจู (${load || 'ุบูุฑ ูุญุฏุฏ'}) ุญุตุฉุ ููุฏุฑุณ ุงูุตููู (${classes || 'ุบูุฑ ูุญุฏุฏุฉ'}).\n`;
                                }
                            });
                            if(detailsFound) generatedText = summary.trim();
                        } else if (baseObjectiveText === classSessionObjectiveText) {
                             let summary = "";
                            const sessionRows = opinionBlock.querySelectorAll('.session-row');
                            let detailsFound = false;
                            sessionRows.forEach(row => {
                                const lessonNumber = row.querySelector('.lesson-number-input').value;
                                const lessonName = row.querySelector('.lesson-name-input').value;
                                const className = row.querySelector('.class-name-input').value;
                                const teacherName = row.querySelector('.teacher-name-input').value;
                                const performance = row.querySelector('.performance-level-select').value;
                                if (lessonNumber || lessonName || className || teacherName) {
                                    detailsFound = true;
                                    summary += `ุชู ุญุถูุฑ ูููู ุตูู ูููุนููุฉ ุงูุญุตุฉ (${lessonNumber || 'ุบูุฑ ูุญุฏุฏุฉ'}) ุฏุฑุณ (${lessonName || 'ุบูุฑ ูุญุฏุฏ'}) ููุตู ${className || 'ุบูุฑ ูุญุฏุฏ'} ูุน ุง.${teacherName || 'ุบูุฑ ูุญุฏุฏ'} ููุงู ูุณุชูู ุงูุงุฏุงุก ${performance}.\n`;
                                }
                            });
                            if(detailsFound) generatedText = summary.trim();
                        }
                    }
                    
                    textarea.value = generatedText + (existingText ? ' ' + existingText : '');
                }
            });
            
            opinionsContainer.addEventListener('change', (e) => {
                if (e.target.matches('select.approval-status-select')) {
                    const index = e.target.dataset.index;
                    const textarea = document.getElementById(`opinion-${index}`);
                    const schoolName = schoolNameSelect.value;
                    const context = getTeacherContext(schoolName);
                    const selectedValue = e.target.value;

                    if (selectedValue && textarea) {
                         let text = '';
                        switch(selectedValue) {
                            case 'in_progress':
                                text = "ุชู ูุชุงุจุนุฉ ููุงููุงุช ุงูุชุนููู ููู ูู ุงุฌุฑุงุกุงุช ุงูุชุนููู.";
                                break;
                            case 'no_approval':
                                text = "ุชู ูุชุงุจุนุฉ ููุงููุงุช ุงูุชุนููู ูููุณ ูุฏููุง ููุงููุฉ ุชุนููู.";
                                break;
                            case 'expired':
                                text = "ุชู ูุชุงุจุนุฉ ููุงููุงุช ุงูุชุนููู ูุงูููุงููุฉ ุงููุจุฏุฆูุฉ ููุชููุฉ ุงูุตูุงุญูุฉ.";
                                break;
                        }
                        textarea.value = applyGender(text, context);
                    }
                }
            });

            generateRecsBtn.addEventListener('click', () => {
                const checkedCheckboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]:checked');
                if (checkedCheckboxes.length === 0) {
                    alert("ุงูุฑุฌุงุก ุชุญุฏูุฏ ูุฏู ูุงุญุฏ ุนูู ุงูุฃูู.");
                    return;
                }
                const currentTypeData = visitTypesData[currentVisitTypeKey];
                const schoolName = schoolNameSelect.value;
                const context = getTeacherContext(schoolName);
                let generatedRecommendations = [];

                checkedCheckboxes.forEach(checkbox => {
                    const index = checkbox.dataset.index;
                    const opinionTextarea = document.getElementById(`opinion-${index}`);
                    let baseIncompleteOpinion = currentTypeData.incompleteOpinions[index];
                    let genderedIncompleteOpinion = applyGender(baseIncompleteOpinion, context);

                    if (opinionTextarea && opinionTextarea.value.trim().length > 0 && opinionTextarea.value.trim() === genderedIncompleteOpinion.trim()) {
                         let baseRecommendation = currentTypeData.recommendations[index];
                         let genderedRecommendation = applyGender(baseRecommendation, context);
                         generatedRecommendations.push(genderedRecommendation);
                    }
                });

                if (generatedRecommendations.length > 0) {
                    recommendationsTextarea.value = "ููุตู ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ ุจุงูุงุชู:\n- " + generatedRecommendations.join('\n- ') + "\n\nูุงููู ุงููููู.";
                } else {
                    recommendationsTextarea.value = "ุณูุฑ ุงูุนูู ููุชุงุฒ ููุง ุชูุฌุฏ ุญุงุฌุฉ ูุชูุตูุงุช ุญุงููุฉ.";
                }
            });

            // --- MODAL LOGIC ---
            manageVisitTypesBtn.addEventListener('click', () => {
                renderManagerModal();
                manageTypesModal.classList.remove('hidden');
            });
            closeManageModalBtn.addEventListener('click', () => manageTypesModal.classList.add('hidden'));
            addNewTypeBtn.addEventListener('click', () => {
                editTypeKeyInput.value = '';
                addEditModalTitle.textContent = 'ุฅุถุงูุฉ ููุน ุฒูุงุฑุฉ ุฌุฏูุฏ';
                addEditTypeForm.reset();
                addEditTypeModal.classList.remove('hidden');
            });
            visitTypesList.addEventListener('click', (e) => {
                const key = e.target.dataset.key;
                if (!key) return;
                if (e.target.classList.contains('edit-btn')) {
                    editTypeKeyInput.value = key;
                    addEditModalTitle.textContent = 'ุชุนุฏูู ููุน ุงูุฒูุงุฑุฉ';
                    typeNameInput.value = visitTypesData[key].name;
                    typeObjectivesTextarea.value = visitTypesData[key].objectives_list.join('\n');
                    addEditTypeModal.classList.remove('hidden');
                }
                if (e.target.classList.contains('delete-btn')) {
                    if (Object.keys(visitTypesData).length <= 1) { return alert("ูุฌุจ ุฃู ูููู ููุงู ููุน ุฒูุงุฑุฉ ูุงุญุฏ ุนูู ุงูุฃูู."); }
                    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู "${visitTypesData[key].name}"ุ`)) {
                        delete visitTypesData[key];
                        saveVisitTypes();
                        loadData();
                        populateVisitTypeDropdown();
                        renderObjectivesForCurrentType();
                        renderManagerModal();
                    }
                }
            });
            cancelEditBtn.addEventListener('click', () => addEditTypeModal.classList.add('hidden'));
            addEditTypeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const key = editTypeKeyInput.value;
                const name = typeNameInput.value.trim();
                const objectives = typeObjectivesTextarea.value.trim().split('\n').filter(line => line.trim() !== '');
                if (!name || objectives.length === 0) { return alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูููุน ููุฏู ูุงุญุฏ ุนูู ุงูุฃูู."); }
                
                const newKey = key || `type_${Date.now()}`;
                
                visitTypesData[newKey] = { 
                    name, 
                    objectives_list: objectives,
                    completedOpinions: objectives.map(o => `ุชู ${o.replace(/\.$/, "")} ุจูุฌุงุญ.`),
                    incompleteOpinions: objectives.map(o => `ููุฌุฏ ููุงุญุธุงุช ุจุฎุตูุต ${o.replace(/\.$/, "")}`),
                    recommendations: objectives.map(o => `ูุชุงุจุนุฉ ${o.replace(/\.$/, "")}.`)
                };
                saveVisitTypes();
                currentVisitTypeKey = newKey;
                populateVisitTypeDropdown();
                renderObjectivesForCurrentType();
                renderManagerModal();
                addEditTypeModal.classList.add('hidden');
            });

            function renderManagerModal() {
                visitTypesList.innerHTML = '';
                 Object.keys(visitTypesData).forEach(key => {
                    const type = visitTypesData[key];
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
                    item.innerHTML = `
                        <span class="font-medium">${type.name}</span>
                        <div class="flex gap-2">
                            <button data-key="${key}" class="edit-btn text-sm text-blue-600 hover:underline">ุชุนุฏูู</button>
                            <button data-key="${key}" class="delete-btn text-sm text-red-600 hover:underline">ุญุฐู</button>
                        </div>
                    `;
                    visitTypesList.appendChild(item);
                });
            }

            // --- INITIALIZE APP ---
            function initializeApp() {
                loadData();
                populateVisitTypeDropdown();
                renderObjectivesForCurrentType();
                showDashboardView();
            }
            initializeApp();
        });
    </script>

</body>
</html>

