<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التقارير الإشرافية المدمج</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- Global Styles --- */
        body {
            font-family: 'Cairo', sans-serif;
        }

        /* --- Supervisory Visits App Styles --- */
        #supervisoryVisitsApp {
            font-family: 'Tajawal', sans-serif; 
        }

        #supervisoryVisitsApp :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-gray: #f8f9fa;
            --medium-gray: #dee2e6;
            --dark-gray: #6c757d;
            --text-color: #333;
            --bg-color: #f0f2f5;
            --white-color: #ffffff;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        #supervisoryVisitsApp body { 
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        #supervisoryVisitsApp .main-container {
            max-width: 900px;
            margin: auto;
            background-color: var(--white-color);
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        #supervisoryVisitsApp #form-view, #supervisoryVisitsApp #dashboard-view, #supervisoryVisitsApp #saved-reports-view { display: none; }
        #supervisoryVisitsApp #form-view.active, #supervisoryVisitsApp #dashboard-view.active, #supervisoryVisitsApp #saved-reports-view.active { display: block; }

        #supervisoryVisitsApp .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        #supervisoryVisitsApp .nav-tabs {
            display: flex;
            border-bottom: 2px solid var(--medium-gray);
            flex-grow: 1;
        }
        #supervisoryVisitsApp .nav-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--dark-gray);
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        #supervisoryVisitsApp .nav-tab:hover { color: var(--primary-dark); }
        #supervisoryVisitsApp .nav-tab.active {
            color: var(--primary-dark);
            font-weight: 700;
            border-bottom-color: var(--primary-color);
        }
        
        #supervisoryVisitsApp .page-header h1 { color: var(--primary-dark); margin: 0; text-align: center;}
        #supervisoryVisitsApp .page-header p { margin: 5px 0 25px; color: #666; font-size: 1.1rem; text-align: center;}
        #supervisoryVisitsApp h2 { color: var(--primary-dark); border-right: 4px solid var(--primary-color); padding-right: 10px; margin-top: 30px; }
        #supervisoryVisitsApp details { border: 1px solid #e0e0e0; border-radius: var(--border-radius); padding: 10px 15px; margin-bottom: 20px; background-color: var(--light-gray); }
        #supervisoryVisitsApp summary { cursor: pointer; font-weight: 700; font-size: 1.2rem; color: var(--primary-dark); list-style: none; display: flex; align-items: center; }
        #supervisoryVisitsApp summary::-webkit-details-marker { display: none; }
        #supervisoryVisitsApp summary::before { content: '◀'; margin-left: 10px; font-size: 0.8em; transition: transform 0.2s; }
        #supervisoryVisitsApp details[open] > summary::before { transform: rotate(-90deg); }
        #supervisoryVisitsApp .item-card { border: 1px solid #ccc; border-radius: var(--border-radius); padding: 15px; margin: 15px 0; background-color: #fdfdfd; transition: box-shadow 0.3s; }
        #supervisoryVisitsApp .item-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        #supervisoryVisitsApp .item-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        #supervisoryVisitsApp .item-header h4 { margin: 0; font-size: 1.1rem; color: var(--text-color); flex-grow: 1; }
        #supervisoryVisitsApp .item-header h4 small { color: #555; font-weight: 400; font-size: 0.9rem;}
        #supervisoryVisitsApp .score { font-size: 2rem; font-weight: bold; color: var(--text-color); background-color: var(--bg-color); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; transition: color 0.3s, background-color 0.3s; }
        
        #supervisoryVisitsApp .rating-selector { display: flex; justify-content: space-around; padding: 10px 0; margin-top: 10px; border-top: 1px solid #eee;}
        #supervisoryVisitsApp .rating-btn { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; background-color: var(--light-gray); cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        #supervisoryVisitsApp .rating-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #supervisoryVisitsApp .rating-btn.active { font-weight: bold; color: white; border-color: transparent; }
        #supervisoryVisitsApp .rating-btn.active.score-1 { background-color: #155724; }
        #supervisoryVisitsApp .rating-btn.active.score-2 { background-color: #004085; }
        #supervisoryVisitsApp .rating-btn.active.score-3 { background-color: #856404; }
        #supervisoryVisitsApp .rating-btn.active.score-4 { background-color: #721c24; }
        #supervisoryVisitsApp .rating-btn.active.score-5 { background-color: #dc3545; }

        #supervisoryVisitsApp .notes-wrapper { position: relative; }
        #supervisoryVisitsApp .item-notes { width: 100%; box-sizing: border-box; margin-top: 15px; padding: 8px; padding-left: 35px; border: 1px solid #ddd; border-radius: 4px; background-color: var(--light-gray); font-size: 0.95rem; min-height: 80px; }
        #supervisoryVisitsApp .item-notes .highlight { color: var(--danger-color); font-weight: bold; }

        #supervisoryVisitsApp .mic-btn { position: absolute; left: 8px; top: 25px; background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--dark-gray); transition: color 0.2s;}
        #supervisoryVisitsApp .mic-btn:hover { color: var(--primary-color); }
        #supervisoryVisitsApp .mic-btn.recording { color: var(--danger-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        #supervisoryVisitsApp .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; align-items: center;}
        #supervisoryVisitsApp .info-grid input, #supervisoryVisitsApp .info-grid select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-family: 'Tajawal', sans-serif; font-size: 1rem; }
        #supervisoryVisitsApp .info-grid .dropdown-wrapper { display: flex; flex-direction: column; gap: 5px; }
        
        #supervisoryVisitsApp .controls { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        #supervisoryVisitsApp .controls button { padding: 10px 20px; font-size: 1rem; font-family: 'Tajawal', sans-serif; font-weight: 700; cursor: pointer; border: none; border-radius: 5px; color: white; transition: background-color 0.2s, transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #supervisoryVisitsApp .controls button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        #supervisoryVisitsApp .print-btn { background-color: var(--success-color); }
        #supervisoryVisitsApp .reset-btn { background-color: var(--danger-color); }
        #supervisoryVisitsApp .generate-btn { background-color: var(--primary-color); }
        #supervisoryVisitsApp .archive-btn { background-color: #3f51b5; }
        #supervisoryVisitsApp .export-btn { background-color: var(--info-color); }
        #supervisoryVisitsApp #status-message { text-align: center; color: green; margin-top: 15px; font-weight: 500; height: 20px; transition: opacity 0.5s; }
        #supervisoryVisitsApp .report-section { margin-top: 40px; border-top: 2px solid var(--primary-color); padding-top: 20px; }
        #supervisoryVisitsApp .report-box h3 { color: var(--primary-dark); margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        #supervisoryVisitsApp .report-content-area { width: 100%; box-sizing: border-box; border: 1px solid var(--medium-gray); border-radius: 4px; background-color: var(--light-gray); font-family: inherit; font-size: 1rem; line-height: 1.7; resize: vertical; min-height: 120px; padding: 8px; margin-top: 10px; }

        #supervisoryVisitsApp .report-box-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        #supervisoryVisitsApp .report-box-header h3 { margin: 0; border-bottom: none; padding-bottom: 0; }
        #supervisoryVisitsApp .copy-btn { background-color: var(--dark-gray); color: white; border: none; border-radius: 5px; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.2s; }
        #supervisoryVisitsApp .copy-btn:hover { background-color: var(--primary-dark); }

        #supervisoryVisitsApp .template-section { margin-top: 20px; padding: 15px; border: 1px dashed var(--primary-color); border-radius: var(--border-radius); background-color: var(--light-gray);}
        #supervisoryVisitsApp .template-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
        #supervisoryVisitsApp .template-controls select { flex-grow: 1; }
        #supervisoryVisitsApp .template-controls button { padding: 8px 12px; font-size: 0.9rem; border-radius: 5px; border:none; color: white; cursor: pointer; }
        #supervisoryVisitsApp .template-controls .load-tpl-btn { background-color: var(--primary-color); }
        #supervisoryVisitsApp .template-controls .save-tpl-btn { background-color: var(--success-color); }

        #supervisoryVisitsApp .dashboard-controls, #supervisoryVisitsApp .saved-reports-controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap; }
        #supervisoryVisitsApp .dashboard-controls .control-group, #supervisoryVisitsApp .saved-reports-controls .control-group { flex-grow: 1; }
        #supervisoryVisitsApp .dashboard-controls label, #supervisoryVisitsApp .saved-reports-controls label { display: block; margin-bottom: 5px; font-weight: 500; }
        #supervisoryVisitsApp .dashboard-controls input, #supervisoryVisitsApp .dashboard-controls select, #supervisoryVisitsApp .saved-reports-controls input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Tajawal', sans-serif; font-size: 1rem;}
        #supervisoryVisitsApp .dashboard-controls button, #supervisoryVisitsApp .saved-reports-controls button { padding: 10px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; height: 45px; }
        #supervisoryVisitsApp #chart-container { margin-top: 20px; height: 450px; }
        #supervisoryVisitsApp .no-data-message { text-align: center; color: var(--dark-gray); font-size: 1.2rem; padding: 40px; background-color: var(--light-gray); border-radius: var(--border-radius); }
        #supervisoryVisitsApp .saved-report-card { background-color: var(--light-gray); border: 1px solid var(--medium-gray); border-right: 5px solid var(--primary-color); border-radius: var(--border-radius); padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; transition: box-shadow 0.2s; }
        #supervisoryVisitsApp .saved-report-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #supervisoryVisitsApp .saved-report-info { font-size: 1.1rem; }
        #supervisoryVisitsApp .saved-report-info strong { color: var(--primary-dark); }
        #supervisoryVisitsApp .saved-report-actions button { padding: 8px 12px; margin-right: 5px; border:none; color:white; font-weight:500; border-radius:5px; cursor:pointer;}
        #supervisoryVisitsApp .saved-report-actions .load-btn { background-color: var(--primary-color); }
        #supervisoryVisitsApp .saved-report-actions .delete-btn { background-color: var(--danger-color); }

        #supervisoryVisitsApp .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        #supervisoryVisitsApp .modal-content { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 90%; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        #supervisoryVisitsApp .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        #supervisoryVisitsApp .modal-buttons button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: 700; }
        #supervisoryVisitsApp .modal-confirm-btn { background-color: var(--danger-color); color: white; }
        #supervisoryVisitsApp .modal-cancel-btn { background-color: var(--dark-gray); color: white; }

        #supervisoryVisitsApp .print-view { display: none; }

        /* --- School Visits App Styles --- */
        #schoolVisitsApp .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #schoolVisitsApp .modal-content {
            transition: transform 0.3s ease-in-out;
        }


        /* --- Print Styles --- */
        @media print {
            .no-print { display: none !important; }

            /* Supervisory App Print */
            #supervisoryVisitsApp body { background-color: #fff; padding: 0; margin: 0; font-family: 'Times New Roman', Times, serif; }
            #supervisoryVisitsApp .main-container, #supervisoryVisitsApp .modal-overlay { display: none; }
            #supervisoryVisitsApp .print-view { display: block; }
            #supervisoryVisitsApp .print-logo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 10px; }
            #supervisoryVisitsApp .print-logo-header img { max-height: 70px; }
            #supervisoryVisitsApp .print-header-text, .print-title { text-align: center; font-weight: bold; margin-bottom: 15px; }
            #supervisoryVisitsApp .print-main-table, .print-info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
            #supervisoryVisitsApp .print-main-table th, #supervisoryVisitsApp .print-main-table td, #supervisoryVisitsApp .print-info-table td { border: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle; }
            #supervisoryVisitsApp .print-main-table th { background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            #supervisoryVisitsApp .print-info-table .label { font-weight: bold; background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; color-adjust: exact; width: 15%; }
            #supervisoryVisitsApp .item-cell { text-align: right !important; }
            #supervisoryVisitsApp .category-cell { font-weight: bold; }
            #supervisoryVisitsApp .report-section-print { margin-top: 20px; border: 2px solid #000; padding: 10px; page-break-inside: avoid; }
            #supervisoryVisitsApp .report-section-print h3 { margin: 0 0 10px 0; font-size: 1.2rem; background-color: #f2f2f2 !important; padding: 5px; text-align: center; -webkit-print-color-adjust: exact; color-adjust: exact; border-bottom: 1px solid #000; }
            #supervisoryVisitsApp .print-report-box { white-space: pre-wrap; text-align: right; min-height: 80px; }
            #supervisoryVisitsApp .signature-section { margin-top: 40px; page-break-inside: avoid; }
            #supervisoryVisitsApp .evaluation-standard { text-align: center; font-size: 0.9em; margin-top: 20px; border-top: 1px solid #000; padding-top: 5px;}
            
            /* School App Print */
            #schoolVisitsApp body * { visibility: hidden; }
            #schoolVisitsApp #reportPreviewContainer, #schoolVisitsApp #reportPreviewContainer * { visibility: visible; }
            #schoolVisitsApp #reportPreviewContainer { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; margin: 0; padding: 0; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Welcome View -->
    <div id="welcomeView" class="flex flex-col items-center justify-center min-h-screen p-6">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">نظام التقارير الإشرافية</h1>
            <p class="mt-4 text-lg text-gray-600">اختر نوع التقرير الذي تود العمل عليه</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12 w-full max-w-4xl">
            <!-- Supervisory Visits Card -->
            <div id="showSupervisoryAppBtn" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-shadow cursor-pointer border-t-4 border-blue-500">
                <h2 class="text-2xl font-bold text-gray-800">الزيارات الإشرافية</h2>
                <p class="mt-2 text-gray-600">نموذج تقييم أداء المعلمين في مادة الرياضة المدرسية مع لوحة متابعة تحليلية.</p>
            </div>
            <!-- School Visits Card -->
            <div id="showSchoolAppBtn" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-shadow cursor-pointer border-t-4 border-green-500">
                <h2 class="text-2xl font-bold text-gray-800">الزيارات المدرسية</h2>
                <p class="mt-2 text-gray-600">نظام لتوثيق الزيارات المدرسية وتحديد الأهداف والملاحظات، مع حفظ سحابي للبيانات.</p>
            </div>
        </div>
    </div>


    <!-- Supervisory Visits App Container -->
    <div id="supervisoryVisitsApp" class="hidden">
        <div class="main-container">
            <header class="top-header">
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-view="form-view">نموذج التقييم</button>
                    <button class="nav-tab" data-view="dashboard-view">لوحة المتابعة</button>
                    <button class="nav-tab" data-view="saved-reports-view">التقارير المحفوظة</button>
                </nav>
                 <button id="backToWelcomeFromSupervisory" class="text-gray-700 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg text-sm px-4 py-2 whitespace-nowrap transition-colors mt-2 sm:mt-0">
                    العودة للقائمة الرئيسية
                </button>
            </header>
    
            <div id="form-view" class="active">
                <div class="page-header">
                    <h1>استمارة زيارة إشرافية إلكترونية</h1>
                    <p>نظام التقييم الإشرافي الرقمي المطور (الرياضة المدرسية)</p>
                </div>
                <main>
                    <section class="visit-info">
                        <h2>معلومات الزيارة</h2>
                        <div class="info-grid">
                            <div class="dropdown-wrapper">
                                <label for="school">المدرسة:</label>
                                <select id="school"></select>
                                <input id="school-other" type="text" placeholder="أو أدخل اسم المدرسة يدويًا" style="display: none; margin-top: 5px;">
                            </div>
                            <div class="dropdown-wrapper">
                                <label for="teacherName">اسم المعلم:</label>
                                <select id="teacherName"></select>
                                 <input id="teacherName-other" type="text" placeholder="أو أدخل اسم المعلم يدويًا" style="display: none; margin-top: 5px;">
                            </div>
                            <input id="fileNumber" type="text" placeholder="رقم الملف">
                            <input id="subject" type="text" placeholder="المادة" value="الرياضة المدرسية">
                            <input id="visitNumber" type="text" placeholder="رقم الزيارة">
                            <input id="visitDate" type="date" placeholder="التاريخ">
                            <input id="class" type="text" placeholder="الصف">
                            <input id="lesson" type="text" placeholder="الحصة">
                            <input id="topic" type="text" placeholder="الموضوع">
                        </div>
                    </section>
        
                    <section class="template-section">
                         <div class="template-controls">
                            <select id="template-select" class="info-grid-input"></select>
                            <button id="loadTemplateBtn" class="load-tpl-btn">تحميل قالب</button>
                            <button id="saveTemplateBtn" class="save-tpl-btn">حفظ كقالب</button>
                        </div>
                    </section>
                    
                    <details>
                        <summary>اضغط هنا لعرض معيار التقييم</summary>
                        <div style="padding: 10px;">
                            <ul>
                                <li><b>1 - متميز</b></li>
                                <li><b>2 - جيد</b></li>
                                <li><b>3 - ملائم</b></li>
                                <li><b>4 - غير ملائم</b></li>
                                <li><b>5 - يحتاج إلى تدخل سريع</b></li>
                            </ul>
                        </div>
                    </details>
        
                    <form id="evaluationForm">
                        <!-- Item Cards will be generated by JS -->
                    </form>
                    
                    <section id="reportSection" class="report-section" style="display: none;">
                        <h2>التقرير النهائي</h2>
                        <div class="report-box">
                            <div class="report-box-header">
                                <h3>جوانب الإجادة</h3>
                                <button class="copy-btn" data-target="strengthsContent">نسخ</button>
                            </div>
                            <textarea id="strengthsContent" class="report-content-area" placeholder="..."></textarea>
                        </div>
                        <div class="report-box">
                            <div class="report-box-header">
                                <h3>الجوانب التي تحتاج إلى تطوير</h3>
                                 <button class="copy-btn" data-target="developmentContent">نسخ</button>
                            </div>
                            <textarea id="developmentContent" class="report-content-area" placeholder="..."></textarea>
                        </div>
                        <div class="report-box">
                            <div class="report-box-header">
                                <h3>التوصيات</h3>
                                <button class="copy-btn" data-target="recommendationsContent">نسخ</button>
                            </div>
                            <textarea id="recommendationsContent" class="report-content-area" placeholder="..."></textarea>
                        </div>
                    </section>
        
                    <section class="visitor-info">
                        <h2>معلومات الزائر</h2>
                        <div class="info-grid">
                            <input id="visitorName" type="text" placeholder="اسم الزائر">
                            <input id="visitorPosition" type="text" placeholder="الوظيفة (مثال: مشرف تربوي)">
                        </div>
                    </section>
                    
                    <p id="status-message"></p>
        
                    <section class="controls">
                        <button type="button" class="archive-btn" id="savePermanentReportBtn">حفظ التقرير</button>
                        <button type="button" class="generate-btn" id="generateReportBtn">توليد تقرير</button>
                        <button class="print-btn" id="printOfficialReportBtn">طباعة</button>
                        <button type="button" class="export-btn" id="exportToWordBtn">تصدير Word</button>
                        <button type="button" class="reset-btn" id="showResetConfirmationBtn">إعادة تعيين</button>
                    </section>
                </main>
            </div>
    
            <div id="dashboard-view">
                <h2>لوحة المتابعة التحليلية</h2>
                 <div class="dashboard-controls">
                    <div class="control-group">
                        <label for="teacher-dashboard-select">اختر المعلم:</label>
                        <select id="teacher-dashboard-select"></select>
                    </div>
                    <div class="control-group">
                         <label for="chartTypeSelect">نوع التحليل:</label>
                         <select id="chartTypeSelect">
                            <option value="radar">تحليل زيارة واحدة (راداري)</option>
                            <option value="line">تطور الأداء عبر الزيارات (خطي)</option>
                            <option value="bar">متوسط الأداء العام (شريطي)</option>
                        </select>
                    </div>
                     <div class="control-group" id="visitDateGroup" style="display: none;">
                        <label for="visitDateSelect">اختر الزيارة:</label>
                        <select id="visitDateSelect"></select>
                    </div>
                    <button id="updateDashboardViewBtn">عرض التحليل</button>
                </div>
                <div id="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div id="no-data-message" class="no-data-message" style="display: none;">
                    <p>لا توجد بيانات محفوظة لهذا المعلم حتى الآن.</p>
                </div>
            </div>
    
            <div id="saved-reports-view">
                <h2>التقارير المحفوظة</h2>
                 <div class="saved-reports-controls">
                    <div class="control-group">
                        <label for="filter-reports-input">بحث بالاسم أو المدرسة:</label>
                        <input type="text" id="filter-reports-input" placeholder="ابحث...">
                    </div>
                     <button id="triggerImportBtn">استيراد بيانات</button>
                     <button class="export-btn" id="exportAllDataBtn">تصدير كل البيانات</button>
                     <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
                <div id="saved-reports-list">
                    <!-- Reports will be injected here -->
                </div>
                <div id="no-saved-reports-message" class="no-data-message" style="display: none;">
                    <p>لا توجد تقارير محفوظة حتى الآن.</p>
                </div>
            </div>
        </div>
        
        <div id="supervisoryConfirmationModal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="supervisory-modal-title"></h3>
                <p id="supervisory-modal-message"></p>
                <div class="modal-buttons">
                    <button id="supervisory-modal-confirm-btn" class="modal-confirm-btn">تأكيد</button>
                    <button id="supervisory-modal-cancel-btn" class="modal-cancel-btn">إلغاء</button>
                </div>
            </div>
        </div>
    
        <div class="print-view" id="printView">
            <div class="print-container">
                 <div class="print-logo-header">
                    <img src="https://i.ibb.co/567f2Pb/oman-vision-2040-logo.png" alt="شعار رؤية عمان 2040" onerror="this.style.display='none'">
                    <img src="https://i.ibb.co/VMy4bJg/Oman-Ministry-of-Education-Logo-svg.png" alt="شعار وزارة التربية" onerror="this.style.display='none'">
                    <img src="https://i.ibb.co/hK0yMGH/quality-logo.png" alt="شعار الجودة" onerror="this.style.display='none'">
                </div>
                <div class="print-header-text">نموذج رقم (5) استمارة زيارة إشرافية لمعلم مادة - مجال</div>
                <div class="print-title"><h2>استمارة زيارة إشرافية لمعلم مادة/مجال</h2></div>
                
                <table class="print-info-table">
                    <tbody>
                        <tr><td class="label">اسم المعلم:</td><td class="value" id="print-teacherName"></td><td class="label">المدرسة:</td><td class="value" id="print-school"></td></tr>
                        <tr><td class="label">المادة/المجال:</td><td class="value" id="print-subject"></td><td class="label">رقم الملف:</td><td class="value" id="print-fileNumber"></td></tr>
                        <tr><td class="label">التاريخ:</td><td class="value" id="print-visitDate"></td><td class="label">رقم الزيارة:</td><td class="value" id="print-visitNumber"></td></tr>
                        <tr><td class="label">الحصة:</td><td class="value" id="print-lesson"></td><td class="label">الصف:</td><td class="value" id="print-class"></td></tr>
                        <tr><td class="label">الموضوع:</td><td colspan="3" class="value" id="print-topic"></td></tr>
                    </tbody>
                </table>
                
                <table class="print-main-table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">المجال</th>
                            <th style="width: 15%;">المعيار</th>
                            <th style="width: 3%;">م</th>
                            <th>البند</th>
                            <th style="width: 7%;">التقدير</th>
                        </tr>
                    </thead>
                    <tbody id="print-main-tbody">
                    </tbody>
                </table>
    
                <div class="report-section-print">
                    <h3>جوانب الإجادة في الأداء وأدلتها:</h3>
                    <div id="print-strengthsContent" class="print-report-box"></div>
                </div>
                <div class="report-section-print">
                    <h3>الجوانب التي تحتاج إلى تطوير في الأداء وأدلتها:</h3>
                    <div id="print-developmentContent" class="print-report-box"></div>
                </div>
                <div class="report-section-print">
                    <h3>التوصيات:</h3>
                    <div id="print-recommendationsContent" class="print-report-box"></div>
                </div>
    
                <div class="signature-section">
                    اسم الزائر: <span id="print-visitorName" class="line"></span><br><br>
                    الوظيفة: <span id="print-visitorPosition" class="line"></span>
                </div>
                <div class="evaluation-standard">
                    ● معيار التقييم: 1- متميز، 2- جيد، 3- ملائم، 4- غير ملائم، 5- يحتاج إلى تدخل سريع
                </div>
            </div>
        </div>
    </div>


    <!-- School Visits App Container -->
    <div id="schoolVisitsApp" class="hidden">
        <!-- Auth View -->
        <div id="authView" class="container mx-auto max-w-md p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg">
            <button id="backToWelcomeFromSchoolAuth" class="absolute top-4 left-4 text-gray-700 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg text-sm px-4 py-2 whitespace-nowrap transition-colors no-print">
                &larr; العودة
            </button>
            <div id="authContainer">
                <h1 id="authTitle" class="text-3xl font-bold text-gray-800 text-center mb-6">تسجيل الدخول</h1>
                <p id="authMessage" class="text-center mb-4 p-2 rounded-md"></p>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block mb-2 text-sm font-medium text-gray-900">البريد الإلكتروني</label>
                        <input type="email" id="loginEmail" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block mb-2 text-sm font-medium text-gray-900">كلمة المرور</label>
                        <input type="password" id="loginPassword" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div class="text-left text-sm">
                        <button type="button" id="showReset" class="font-medium text-blue-600 hover:underline">نسيت كلمة المرور؟</button>
                    </div>
                    <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">دخول</button>
                    <p class="text-sm text-center text-gray-500">
                        ليس لديك حساب؟ <button type="button" id="showRegister" class="font-medium text-blue-600 hover:underline">أنشئ حساباً جديداً</button>
                    </p>
                </form>
                <form id="registerForm" class="space-y-6 hidden">
                    <div>
                        <label for="registerEmail" class="block mb-2 text-sm font-medium text-gray-900">البريد الإلكتروني</label>
                        <input type="email" id="registerEmail" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="registerPassword" class="block mb-2 text-sm font-medium text-gray-900">كلمة المرور</label>
                        <input type="password" id="registerPassword" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <button type="submit" class="w-full text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">إنشاء حساب</button>
                    <p class="text-sm text-center text-gray-500">
                        لديك حساب بالفعل؟ <button type="button" id="showLoginFromRegister" class="font-medium text-blue-600 hover:underline">سجل دخولك</button>
                    </p>
                </form>
                <form id="resetPasswordForm" class="space-y-6 hidden">
                    <p class="text-sm text-gray-600">أدخل بريدك الإلكتروني المسجل وسنرسل لك رابطًا لإعادة تعيين كلمة المرور.</p>
                    <div>
                        <label for="resetEmail" class="block mb-2 text-sm font-medium text-gray-900">البريد الإلكتروني</label>
                        <input type="email" id="resetEmail" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <button type="submit" class="w-full text-white bg-orange-600 hover:bg-orange-700 focus:ring-4 focus:ring-orange-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">إرسال رابط إعادة التعيين</button>
                    <p class="text-sm text-center text-gray-500">
                        <button type="button" id="backToLogin" class="font-medium text-blue-600 hover:underline">العودة لتسجيل الدخول</button>
                    </p>
                </form>
            </div>
        </div>
        <div id="schoolDashboardView" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg hidden">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-4 border-b pb-4 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">سجل التقارير</h1>
                    <p id="userEmailDisplay" class="text-gray-500 mt-2"></p>
                </div>
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <button id="backToWelcomeFromSchool" class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 font-medium rounded-lg text-sm px-6 py-3 whitespace-nowrap transition-colors">
                        القائمة الرئيسية
                    </button>
                    <button id="logoutBtn" class="text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 font-medium rounded-lg text-sm px-6 py-3 whitespace-nowrap transition-colors">
                        تسجيل الخروج
                    </button>
                    <button id="addNewReportBtn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-6 py-3 whitespace-nowrap transition-colors">
                        + تقرير جديد
                    </button>
                </div>
            </header>
            <div id="reportsListContainer"></div>
        </div>
        <div id="schoolFormView" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg hidden no-print">
            <header class="text-center mb-8">
                <h1 id="formTitle" class="text-3xl font-bold text-gray-800">إنشاء تقرير زيارة إشرافية</h1>
                <p class="text-gray-500 mt-2">نموذج لتوثيق الزيارات الإشرافية للمعلمين</p>
            </header>
            <form id="reportForm" class="space-y-8">
                <input type="hidden" id="reportId" value="">
                <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                    <legend class="text-lg font-semibold text-gray-700 px-2">معلومات أساسية</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label for="schoolName" class="block mb-2 text-sm font-medium text-gray-900">اسم المدرسة</label>
                            <select id="schoolName" name="schoolName" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                 <option value="" selected disabled>اختر المدرسة</option>
                                 <option value="أبو القاسم الزهراوي">أبو القاسم الزهراوي</option>
                                 <option value="أبو أيوب الحضرمي">أبو أيوب الحضرمي</option>
                                 <option value="أبو تمام">أبو تمام</option>
                                 <option value="أحمد بن النعمان">أحمد بن النعمان</option>
                                 <option value="الشيخ سالم السيابي">الشيخ سالم السيابي</option>
                                 <option value="الشيخ سعيد الكندي مسائي">الشيخ سعيد الكندي مسائي</option>
                                 <option value="الشيخ ناصر الخروصي">الشيخ ناصر الخروصي</option>
                                 <option value="جنادة الازدى (موسى سابقا)">جنادة الازدى (موسى سابقا)</option>
                                 <option value="حفص بن راشد">حفص بن راشد</option>
                                 <option value="خريس الحبوس">خريس الحبوس</option>
                                 <option value="سهيل بن عمرو العامري">سهيل بن عمرو العامري</option>
                                 <option value="كعب بن زيد">كعب بن زيد</option>
                                 <option value="يزيد الطائي">يزيد الطائي</option>
                                 <option value="اجيال الثقافة">اجيال الثقافة</option>
                                 <option value="اجيال الفردوس - الحيل">اجيال الفردوس - الحيل</option>
                                 <option value="البيان">البيان</option>
                                 <option value="الجيل المبدع">الجيل المبدع</option>
                                 <option value="الريادة">الريادة</option>
                                 <option value="السراج">السراج</option>
                                 <option value="الصفوة المعبيلة">الصفوة المعبيلة</option>
                                 <option value="المجد">المجد</option>
                                 <option value="انس بن مالك (المنار سابقا)">انس بن مالك (المنار سابقا)</option>
                                 <option value="جيفر بن الجلندي">جيفر بن الجلندي</option>
                                 <option value="ضياء المستقبل">ضياء المستقبل</option>
                                 <option value="مشاعل مسقط سور الحديد">مشاعل مسقط سور الحديد</option>
                                 <option value="منابع التفوق">منابع التفوق</option>
                            </select>
                        </div>
                        <div>
                            <label for="visitDate" class="block mb-2 text-sm font-medium text-gray-900">تاريخ الزيارة</label>
                            <input type="date" id="visitDate" name="visitDate" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                    <legend class="text-lg font-semibold text-gray-700 px-2">نوع الزيارة</legend>
                    <div class="flex items-center gap-4 mt-2">
                        <select id="visitTypeSelect" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                        <button type="button" id="manageVisitTypesBtn" class="p-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg border hover:bg-gray-200 transition-colors whitespace-nowrap">
                            ⚙️ إدارة الأنواع
                        </button>
                    </div>
                </fieldset>
                <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                    <div class="flex justify-between items-center mb-4">
                        <legend class="text-lg font-semibold text-gray-700 px-2">أهداف الزيارة</legend>
                        <button type="button" id="selectAllObjectivesBtn" class="text-sm font-medium text-blue-600 hover:underline">اختيار الكل</button>
                    </div>
                    <div id="objectivesContainer" class="space-y-4"></div>
                </fieldset>
                <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                    <legend class="text-lg font-semibold text-gray-700 px-2">رأي الزائر</legend>
                    <p class="text-sm text-gray-500 mb-4">اكتب ملاحظاتك لكل هدف من الأهداف المحددة أعلاه.</p>
                    <div id="opinionsContainer" class="space-y-6"></div>
                </fieldset>
                <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                    <legend class="text-lg font-semibold text-gray-700 px-2">التوصيات</legend>
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-2 gap-4 flex-wrap">
                            <label for="recommendations" class="block text-sm font-medium text-gray-900 sr-only">التوصيات</label>
                            <div class="flex gap-4">
                                <button type="button" id="generate-recommendations-btn" class="flex items-center text-sm text-blue-600 font-semibold hover:text-blue-800 transition-colors">
                                    📋 توليد التوصيات
                                </button>
                            </div>
                        </div>
                        <textarea id="recommendations" name="recommendations" rows="5" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="اكتب التوصيات والملاحظات النهائية هنا أو استخدم زر التوليد التلقائي..."></textarea>
                    </div>
                </fieldset>
                <fieldset class="border p-6 rounded-lg bg-gray-50/50">
                    <legend class="text-lg font-semibold text-gray-700 px-2">المرفقات (اختياري)</legend>
                    <p class="text-sm text-gray-500 mb-4">ملاحظة: المرفقات يتم حفظها محلياً في المتصفح فقط ولا يتم رفعها للسحابة حالياً.</p>
                    <div class="mt-4">
                        <label for="attachmentsInput" class="block mb-2 text-sm font-medium text-gray-900">اختر ملفات (صور، مستندات...)</label>
                        <input type="file" id="attachmentsInput" multiple class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                        <div id="attachmentsList" class="mt-4 space-y-2"></div>
                    </div>
                </fieldset>
                <div class="flex justify-end pt-4 gap-4">
                    <button type="button" id="backToDashboardBtn" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">إلغاء</button>
                    <button type="button" id="prepareReportBtn" class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">معاينة التقرير</button>
                    <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-8 py-3 text-center transition-colors">حفظ التقرير</button>
                </div>
            </form>
        </div>
        <div id="reportPreviewContainer" class="container mx-auto max-w-4xl p-6 md:p-8 my-10 bg-white rounded-2xl shadow-lg hidden">
            <div id="reportContent" class="prose max-w-none prose-p:my-1 prose-ol:my-1 prose-h3:my-3"></div>
            <div class="flex justify-end pt-6 mt-6 border-t no-print gap-4 flex-wrap">
                <button id="backToBtn" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">رجوع</button>
                <button id="copyAllBtn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">نسخ الكل</button>
                <button onclick="window.print()" class="text-white bg-gray-800 hover:bg-gray-900 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-8 py-3 text-center transition-colors">طباعة</button>
            </div>
        </div>
        <div id="manageTypesModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-backdrop">
            <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white modal-content">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">إدارة أنواع الزيارات</h3>
                    <button id="closeManageModalBtn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                <div class="mt-4">
                    <div id="visitTypesList" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                    <div class="mt-6 pt-4 border-t">
                        <button id="addNewTypeBtn" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">إضافة نوع زيارة جديد</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="addEditTypeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-backdrop">
            <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white modal-content">
                <h3 id="addEditModalTitle" class="text-lg leading-6 font-medium text-gray-900 mb-4"></h3>
                <form id="addEditTypeForm">
                    <input type="hidden" id="editTypeKey" value="">
                    <div>
                        <label for="typeName" class="block mb-2 text-sm font-medium text-gray-900">اسم نوع الزيارة</label>
                        <input type="text" id="typeName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div class="mt-4">
                        <label for="typeObjectives" class="block mb-2 text-sm font-medium text-gray-900">الأهداف (كل هدف في سطر)</label>
                        <textarea id="typeObjectives" rows="8" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                    </div>
                    <div class="items-center px-4 py-3 gap-3 flex justify-end mt-4 border-t pt-4">
                        <button id="saveTypeBtn" type="submit" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-700">حفظ</button>
                        <button id="cancelEditBtn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-backdrop">
            <div class="relative top-1/2 -translate-y-1/2 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white modal-content">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirmationModalTitle">هل أنت متأكد؟</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="confirmationModalMessage"></p>
                    </div>
                    <div class="items-center px-4 py-3 gap-3 flex justify-center">
                        <button id="confirmActionBtn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700">
                            نعم, حذف
                        </button>
                        <button id="cancelActionBtn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300">
                            إلغاء
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- VIEW MANAGEMENT ---
        const welcomeView = document.getElementById('welcomeView');
        const supervisoryApp = document.getElementById('supervisoryVisitsApp');
        const schoolApp = document.getElementById('schoolVisitsApp');

        function showView(view) {
            welcomeView.classList.add('hidden');
            supervisoryApp.classList.add('hidden');
            schoolApp.classList.add('hidden');
            view.classList.remove('hidden');
        }

        document.getElementById('showSupervisoryAppBtn').addEventListener('click', () => showView(supervisoryApp));
        document.getElementById('showSchoolAppBtn').addEventListener('click', () => showView(schoolApp));
        document.getElementById('backToWelcomeFromSupervisory').addEventListener('click', () => showView(welcomeView));
        
        // Corrected the ID for the back button in the school app dashboard
        const backToWelcomeFromSchoolDashboard = schoolApp.querySelector('#schoolDashboardView #backToWelcomeFromSchool');
        if(backToWelcomeFromSchoolDashboard) {
            backToWelcomeFromSchoolDashboard.addEventListener('click', () => showView(welcomeView));
        }

        const backToWelcomeFromAuth = schoolApp.querySelector('#backToWelcomeFromSchoolAuth');
         if(backToWelcomeFromAuth) {
            backToWelcomeFromAuth.addEventListener('click', () => showView(welcomeView));
        }


        // --- SUPERVISORY VISITS APP CODE ---
        function initializeSupervisoryApp() {
            let performanceChartInstance;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = SpeechRecognition ? new SpeechRecognition() : null;
            if (recognition) {
                recognition.continuous = false;
                recognition.lang = 'ar-SA';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            }

            const schoolsList = [ "أبو القاسم الزهراوي", "أبو أيوب الحضرمي", "أبو تمام", "أحمد بن النعمان", "الشيخ سالم السيابي", "الشيخ سعيد الكندي", "الشيخ ناصر الخروصي", "جنادة الازدي", "حفص بن راشد", "خريس الحبوس", "سهيل بن عمرو العامري", "كعب بن زيد", "يزيد الطائي", "أجيال الثقافة", "أجيال الفردوس – الحيل", "البيان", "الجيل المبدع", "الريادة", "الصفوة -المعبيلة", "المجد", "جيفر بن الجلندى", "السراج", "ضياء المستقبل", "مشاعل مسقط سور ال حديد", "منابع التفوق" ];
            const teachersBySchool = { "أحمد بن النعمان": ["طارق بن يوسف بن يسند البلوشي", "عمر بن سعيد بن عبيد الشحي", "سليمان بن سالم بن مبارك الرزيقي"], "أبو القاسم الزهراوي": ["أيوب بن سلطان بن ناصر الوردي"], "أبو الفضل الزهراوي": ["يحيى بن عبدالله بن سيف اليوسفي"], "حفص بن راشد": ["سعود بن سيف بن ناصر الراسبي", "سليمان بن سيف بن سالم الوهيبي", "عبدالحميد بن محمد بن عبدالرسول الزدجالي", "محمد بن أحمد بن خالد الخطوري", "حميد بن حمد بن هديب السعدي"], "الشيخ سالم السيابي": ["إبراهيم بن ناصر بن خميس البوسعيدي", "فهد بن محمد بن سعيد الخروصي"], "أبو أيوب الحضرمي": ["عبدالله بن سعيد بن عامر القلذي"], "خريس الحبوس": ["فيصل بن عبدالله بن راشد الحربي", "عبدالله بن فرج بن عبيد الحجري", "عمر سالم شدوم الهنائي", "هاشم بن راشد بن سيف الهاشمي"], "أبو تمام": ["المعتصم بن عبدالله بن علي القطيطي"], "الشيخ ناصر الخروصي": ["سعيد بن محمد بن راشد الغاوي المخمري", "عدنان بن حسن بن تبوك", "سيف بن سليمان بن سيف الفهدي"], "كعب بن زيد": ["أحمد بن سليمان بن سالم الحسيني", "يوسف بن عبدالله بن سيف اليوسفي", "علاء بن علي بن حمد الشبلي"], "جنادة الازدي": ["إبراهيم بن محمد بن حمود الراسبي", "سالم بن سعيد بن سعيد البوسعيدي", "أسامة بن سليمان الدهماني", "محمود بن محمد بن خلفان المحروقي", "منصور بن محمد بن جمعه الفارسي"], "سهيل بن عمرو العامري": ["السعد بن خليفة بن عبدالله السعدي", "محمد بن قاسم بن حمدان النبهاني", "راشد بن سالم بن خالد الرشيدي"], "الشيخ سعيد الكندي": ["محمد بن سعيد بن مجاد العمري", "راشد بن سالم بن خلفان المشيفري"], "الصفوة -المعبيلة": ["رحمة محمد شلقامي"], "جيفر بن الجلندى": ["إيهاب محسن محمد"], "أجيال الثقافة": ["اسماء حسن احمد"], "البيان": ["جيهان علي محمد"], "المجد": ["ايه رضا عبد الفتاح العليمي حلاوه"], "الريادة": ["اسماء سعد سعد ابراهيم سعد", "حسام محمد زايد"], "أجيال الفردوس – الحيل": ["رحاب عبد الحكم عبد الحليم"], "السراج": ["عذراء بنت محمد بن حمود المالكي"], "ضياء المستقبل": ["علاء احمد وزيري"], "مشاعل مسقط سور ال حديد": ["دينا اشرف حبيب"], "منابع التفوق": ["مها محمد السيد"], "الجيل المبدع": ["ايمان رمضان علي محمد هلال"] };
            const evaluationItems = [ { id: 1, domain: 'الإنجاز الدراسي', standard: 'التحصيل الدراسي', title: 'تحصيل الطلبة في الأعمال الصفية وغير الصفية', desc: '(اكتساب المهارات الحركية والمعارف المرتبطة بها)' }, { id: 2, domain: 'الإنجاز الدراسي', standard: 'التقدم الدراسي', title: 'التقدم الدراسي للطلبة بما فيهم الطلبة ذوي الإعاقة/الاحتياجات التعليمية', desc: '(تطور الأداء المهاري والخططي)' }, { id: 3, domain: 'الإنجاز الدراسي', standard: 'مهارات التعلم', title: 'تطبيق مهارات التعلم (الذاتي- التعاوني - الرقمي - التفكير العليا) وربطها بالواقع', desc: '(القيادة، التعاون، التفكير الخططي في مواقف اللعب)' }, { id: 4, domain: 'النمو الشخصي', standard: 'القيم والسلوك', title: 'تمسك الطلبة بالهوية العمانية والقيم الإنسانية', desc: '(الروح الرياضية وأخلاقيات اللعب)' }, { id: 5, domain: 'مناخ المدرسة وبيئة التعلم', standard: 'جودة بيئة التعلم', title: 'متابعة جوانب الأمن والسلامة والنظافة في بيئة التعلم', desc: '(سلامة الأدوات والمرافق الرياضية)' }, { id: 6, domain: 'التدريس والتقويم', standard: 'تخطيط المنهاج الدراسي', title: 'تخطيط المنهاج الدراسي لتحقيق نواتج التعلم', desc: '(التخطيط لتنمية المهارات الحركية واللياقة البدنية)' }, { id: 7, domain: 'التدريس والتقويم', standard: 'إدارة الصف', title: 'فاعلية الإدارة الصفية', desc: '(إدارة وتنظيم النشاط البدني)' }, { id: 8, domain: 'التدريس والتقويم', standard: 'فاعلية التدريس', title: 'توظيف استراتيجيات التدريس الفعالة', desc: '(استراتيجيات التدريس المناسبة للنشاط البدني)' }, { id: 9, domain: 'التدريس والتقويم', standard: 'فاعلية التدريس', title: 'تفعيل المصادر والموارد التعليمية', desc: '(الأدوات والأجهزة والمرافق الرياضية)' }, { id: 10, domain: 'التدريس والتقويم', standard: 'التقويم ومساندة التقدم', title: 'توظيف أساليب تقويم متنوعة', desc: '(تقويم الأداء الحركي والمهاري للطلبة)' }, { id: 11, domain: 'القيادة والإدارة والحوكمة', standard: 'قيادة التغيير', title: 'توظيف التقويم الذاتي والتطوير المهني في تحسين الأداء', desc: '(التأمل في الممارسات التدريسية وتطويرها)' }, { id: 12, domain: 'القيادة والإدارة والحوكمة', standard: 'الحوكمة', title: 'تطبيق السياسات والأنظمة واللوائح المنظمة للعمل', desc: '(الالتزام بأخلاقيات المهنة واللوائح)' }, { id: 13, domain: 'القيادة والإدارة والحوكمة', standard: 'الحوكمة', title: 'تنفيذ مبادرات وأنشطة تربوية في المجتمع المدرسي', desc: '(تنظيم الفعاليات والمسابقات الرياضية)' } ];
            const detailedDescriptions = { '1': { '1': "يتقن <span class='highlight'>جميع</span> الطلبة المهارات الحركية الأساسية والمعارف المرتبطة بها، ويطبقونها بفاعلية في مواقف اللعب.", '2': "يتقن <span class='highlight'>معظم</span> الطلبة المهارات الحركية الأساسية والمعارف المرتبطة بها، ويطبقونها بصورة جيدة في مواقف اللعب.", '3': "يكتسب <span class='highlight'>أغلب</span> الطلبة المهارات الحركية الأساسية والمعارف المرتبطة بها بمستوى ملائم.", '4': "يكتسب <span class='highlight'>قليل من</span> الطلبة المهارات الحركية الأساسية بصورة محدودة، مع صعوبة في تطبيقها.", '5': "يظهر <span class='highlight'>عدد نادر من</span> الطلبة اكتسابًا محدودًا جدًا للمهارات الحركية الأساسية." }, '2': { '1': "يُظهر <span class='highlight'>جميع</span> الطلبة، بمن فيهم ذوو الاحتياجات، تطورًا متميزًا ومستمرًا في أدائهم المهاري والخططي واللياقي.", '2': "يُظهر <span class='highlight'>معظم</span> الطلبة تطورًا جيدًا في أدائهم المهاري والخططي واللياقي.", '3': "يُظهر <span class='highlight'>أغلب</span> الطلبة تطورًا ملائمًا في أدائهم المهاري والخططي.", '4': "يُظهر <span class='highlight'>قليل من</span> الطلبة تطورًا محدودًا في أدائهم المهاري والخططي.", '5': "يُظهر <span class='highlight'>عدد نادر من</span> الطلبة تطورًا محدودًا جدًا أو معدومًا في الأداء." }, '3': { '1': "يوظف <span class='highlight'>جميع</span> الطلبة مهارات القيادة والتعاون والتفكير الخططي بفاعلية متميزة في مواقف اللعب المختلفة.", '2': "يوظف <span class='highlight'>معظم</span> الطلبة مهارات التعاون والتفكير الخططي بصورة جيدة في مواقف اللعب.", '3': "يوظف <span class='highlight'>أغلب</span> الطلبة مهارات التعاون والتفكير الخططي بمستوى ملائم.", '4': "يظهر لدى <span class='highlight'>قليل من</span> الطلبة توظيف محدود لمهارات التعاون والتفكير الخططي.", '5': "يظهر لدى <span class='highlight'>عدد نادر من</span> الطلبة توظيف محدود جدًا لمهارات التعاون والتفكير الخططي." }, '4': { '1': "يلتزم <span class='highlight'>جميع</span> الطلبة بقيم الروح الرياضية والاحترام المتبادل واللعب النظيف بمستوى متميز.", '2': "يلتزم <span class='highlight'>معظم</span> الطلبة بقيم الروح الرياضية والاحترام المتبادل واللعب النظيف.", '3': "يلتزم <span class='highlight'>أغلب</span> الطلبة بقيم الروح الرياضية والاحترام المتبادل.", '4': "يظهر <span class='highlight'>قليل من</span> الطلبة التزامًا محدودًا بقيم الروح الرياضية والاحترام.", '5': "يظهر <span class='highlight'>عدد نادر من</span> الطلبة سلوكيات تتنافى مع قيم الروح الرياضية." }, '5': { '1': "يضمن المعلم سلامة الأدوات والمرافق الرياضية، ويوفر بيئة تعلم آمنة ومحفزة <span class='highlight'>بشكل متميز</span>.", '2': "يحرص المعلم على سلامة الأدوات والمرافق الرياضية، ويوفر بيئة تعلم آمنة <span class='highlight'>بشكل جيد</span>.", '3': "يتابع المعلم سلامة الأدوات والمرافق الرياضية بصورة <span class='highlight'>ملائمة</span>.", '4': "متابعة المعلم لسلامة الأدوات والمرافق الرياضية <span class='highlight'>محدودة</span>.", '5': "إهمال واضح لسلامة الأدوات والمرافق الرياضية مما قد يعرض الطلبة للخطر." }, '6': { '1': "تخطيط: تتوافر خططه الفصلية وسجلاته منظمة بشكل متميز، ويدرج تحضيره اليومي لـ<span class='highlight'>جميع</span> أنشطته العملية في منصة نور، ويتميز تخطيطه بتسلسل وتنوع الأهداف وارتباطه بالخطة الفصلية ومحققًا لنواتج التعلم الحركي بصورة متميزة.", '2': "تخطيط: تتوافر خططه الفصلية وسجلاته منظمة بشكل جيد، ويدرج تحضيره اليومي لـ<span class='highlight'>معظم</span> أنشطته العملية في منصة نور، ويتميز تخطيطه بتسلسل وتنوع الأهداف وارتباطه بالخطة الفصلية ومحققًا لنواتج التعلم الحركي بصورة جيدة.", '3': "تخطيط: تتوافر خططه الفصلية وسجلاته منظمة، ويدرج تحضيره اليومي لـ<span class='highlight'>أغلب</span> أنشطته العملية في منصة نور، ويتميز تخطيطه بالارتباط المناسب بالخطة الفصلية.", '4': "تخطيط: تتوافر خططه الفصلية وسجلاته بشكل جزئي أو غير منظم، ويدرج تحضيره اليومي لـ<span class='highlight'>قليل من</span> أنشطته العملية في منصة نور، ويكون تخطيطه محدود الارتباط بنواتج التعلم الحركي.", '5': "تخطيط: تفتقر خططه الفصلية وسجلاته للتنظيم والتوفر، و<span class='highlight'>نادرًا</span> ما يدرج تحضيره اليومي في منصة نور، كما أن تخطيطه للأنشطة نادر أو غير مرتبط بنواتج التعلم." }, '7': { '1': "يدير المعلم وينظم النشاط البدني <span class='highlight'>بفاعلية متميزة</span>، ويضمن أقصى استغلال لوقت الحصة ومشاركة جميع الطلبة.", '2': "يدير المعلم وينظم النشاط البدني <span class='highlight'>بفاعلية جيدة</span>، مع استثمار جيد لوقت الحصة.", '3': "يدير المعلم وينظم النشاط البدني بصورة <span class='highlight'>ملائمة</span>.", '4': "إدارة المعلم للنشاط البدني <span class='highlight'>محدودة</span>، مع وجود فترات هدر في الوقت.", '5': "ضعف واضح في إدارة وتنظيم النشاط البدني، مما يؤثر سلبًا على تعلم الطلبة." }, '8': { '1': "يوظف استراتيجيات تدريس <span class='highlight'>متنوعة ومبتكرة</span> (كاللعب والأقران) ومناسبة للنشاط البدني، يستفيد منها جميع الطلبة.", '2': "يوظف استراتيجيات تدريس <span class='highlight'>فعالة</span> ومناسبة للنشاط البدني يستفيد منها معظم الطلبة.", '3': "يوظف استراتيجيات تدريس <span class='highlight'>ملائمة</span> للنشاط البدني.", '4': "توظيف المعلم لاستراتيجيات التدريس <span class='highlight'>محدود</span> وغير متنوع.", '5': "يعتمد المعلم على استراتيجية واحدة غير فعالة أو غير مناسبة للنشاط البدني." }, '9': { '1': "أدوات: يفعل ويستخدم المعلم الأدوات الرياضية في الحصة بفاعلية يستفيد منها <span class='highlight'>جميع</span> الطلبة في تعميق تعلمهم المهاري بمستوى متميز.", '2': "أدوات: يفعل ويستخدم المعلم الأدوات الرياضية في الحصة بفاعلية يستفيد منها <span class='highlight'>معظم</span> الطلبة في تعميق تعلمهم المهاري بمستوى جيد.", '3': "أدوات: يفعل ويستخدم المعلم الأدوات الرياضية في الحصة بفاعلية يستفيد منها <span class='highlight'>أغلب</span> الطلبة في تعميق تعلمهم المهاري بمستوى ملائم.", '4': "أدوات: يفعل ويستخدم المعلم الأدوات الرياضية في الحصة بفاعلية محدودة ويستفيد منها <span class='highlight'>قليل من</span> الطلبة.", '5': "أدوات: يفعل ويستخدم المعلم الأدوات الرياضية في الحصة بفاعلية نادرة أو يستفيد منها <span class='highlight'>عدد قليل جدًا</span> من الطلبة." }, '10': { '1': "يوظف أساليب تقويم متنوعة (ملاحظة، تقويم أقران) <span class='highlight'>بفاعلية متميزة</span> لتقويم الأداء الحركي والمهاري وتقديم تغذية راجعة فورية.", '2': "يوظف أساليب تقويم متنوعة <span class='highlight'>بفاعلية جيدة</span> لتقويم الأداء الحركي والمهاري.", '3': "يوظف أساليب تقويم <span class='highlight'>ملائمة</span> لتقويم الأداء الحركي والمهاري.", '4': "توظيف المعلم لأساليب التقويم <span class='highlight'>محدود</span> أو يقتصر على نوع واحد.", '5': "غياب شبه تام لأساليب التقويم المنظمة للأداء الحركي والمهاري." }, '11': { '1': "يتأمل المعلم في ممارساته التدريسية ويوظفها في تطوير أدائه <span class='highlight'>بصورة مستمرة ومتميزة</span>، مما ينعكس إيجابًا على تعلم الطلبة.", '2': "يتأمل المعلم في ممارساته التدريسية ويوظفها في تطوير أدائه <span class='highlight'>بصورة جيدة</span>.", '3': "يتأمل المعلم في ممارساته التدريسية ويوظفها في تطوير أدائه بصورة <span class='highlight'>ملائمة</span>.", '4': "تأمل المعلم في ممارساته التدريسية <span class='highlight'>محدود</span> ونادرًا ما يطور أداءه.", '5': "لا يظهر المعلم أي تأمل في ممارساته التدريسية أو اهتمام بتطوير أدائه." }, '12': { '1': "يلتزم المعلم بأخلاقيات المهنة واللوائح المنظمة للعمل (الأمن والسلامة، الزي الرياضي) <span class='highlight'>بشكل نموذجي ومتميز</span>.", '2': "يلتزم المعلم بأخلاقيات المهنة واللوائح المنظمة للعمل <span class='highlight'>بشكل جيد</span>.", '3': "يلتزم المعلم بأخلاقيات المهنة واللوائح المنظمة للعمل بصورة <span class='highlight'>ملائمة</span>.", '4': "التزام المعلم بأخلاقيات المهنة واللوائح المنظمة للعمل <span class='highlight'>محدود</span>.", '5': "يظهر المعلم عدم التزام واضح بأخلاقيات المهنة واللوائح المنظمة للعمل." }, '13': { '1': "يبادر بتنظيم فعاليات ومسابقات رياضية <span class='highlight'>متميزة وفعالة</span>، ويعزز المشاركة الإيجابية في الأنشطة على مستوى المدرسة والمجتمع.", '2': "يساهم <span class='highlight'>بفاعلية جيدة</span> في تنظيم فعاليات ومسابقات رياضية ويعزز المشاركة فيها.", '3': "يساهم بصورة <span class='highlight'>ملائمة</span> في تنظيم الفعاليات والمسابقات الرياضية.", '4': "مساهمة المعلم في تنظيم الفعاليات والمسابقات الرياضية <span class='highlight'>محدودة</span>.", '5': "<span class='highlight'>نادراً</span> ما يساهم المعلم في تنظيم أي فعاليات أو مسابقات رياضية." } };
            const instructionalRecommendations = { '1': "احرص على تنويع الأنشطة والتدريبات العملية لضمان إتقان جميع الطلبة للمهارات الحركية المستهدفة وتطبيقها في مواقف لعب حقيقية.", '2': "اعمل على متابعة التقدم الفردي للطلبة في الجوانب المهارية والبدنية، وقدم لهم تحديات مناسبة لمستوياتهم لضمان تطورهم المستمر.", '3': "شجع الطلبة على اتخاذ القرارات التكتيكية أثناء اللعب، وقم بتصميم أنشطة تعزز العمل الجماعي وتوزيع الأدوار القيادية بينهم.", '4': "عزز قيم الروح الرياضية واللعب النظيف من خلال الممارسة العملية، وكن قدوة لهم في احترام المنافسين والزملاء والحكام.", '5': "قم بفحص دوري للملعب والأدوات الرياضية قبل كل درس، وعلم الطلبة قواعد الأمن والسلامة أثناء ممارسة الأنشطة البدنية.", '6': "استمر في التخطيط المنهجي للدروس بما يضمن التدرج في المهارات وتنمية عناصر اللياقة البدنية المرتبطة بالصحة بشكل متوازن.", '7': "وظف استراتيجيات فعالة لإدارة المجموعات وتوزيع الأدوات بسرعة، لزيادة وقت النشاط الفعلي للطلبة خلال الحصة.", '8': "نوّع في استخدام استراتيجيات التدريس كالتعلم باللعب والتدريس بالأقران، لزيادة الدافعية ومراعاة الفروق الفردية بين الطلبة.", '9': "استغل الموارد المتاحة من أدوات ومساحات بشكل إبداعي، وقم بتكييف الأنشطة لتتناسب مع الإمكانيات المتاحة في المدرسة.", '10': "استخدم قوائم الملاحظة وبطاقات تقويم الأداء لتقديم تغذية راجعة بناءة وفورية للطلبة، وساعدهم على تقييم أدائهم وأداء زملائهم.", '11': "استمر في التأمل في ممارساتك بعد كل درس، وابحث عن أفكار جديدة لتطوير أساليبك في تدريس التربية البدنية بما يتناسب مع احتياجات طلبتك.", '12': "التزم دائماً باللوائح الخاصة بالأمن والسلامة في حصص الرياضة المدرسية، وكن نموذجاً في الالتزام بالزي الرياضي والسلوك المهني.", '13': "بادر بتنظيم يوم رياضي أو دوري داخلي بين الفصول، وشجع على تكوين الفرق المدرسية للمشاركة في المسابقات الخارجية." };

            function toggleView(viewId) {
                supervisoryApp.querySelectorAll('#form-view, #dashboard-view, #saved-reports-view').forEach(view => view.classList.remove('active'));
                supervisoryApp.querySelector(`#${viewId}`).classList.add('active');
                supervisoryApp.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                supervisoryApp.querySelector(`.nav-tab[data-view="${viewId}"]`).classList.add('active');
                if (viewId === 'saved-reports-view') renderSavedReports();
                else if (viewId === 'dashboard-view') { populateTeacherDashboardDropdown(); updateDashboardView(); }
            }
            
            function updateScore(itemId, score) {
                const mainScoreDisplay = supervisoryApp.querySelector(`#score-${itemId}`);
                mainScoreDisplay.textContent = score;
                updateScoreColor(mainScoreDisplay, score);
                const ratingContainer = supervisoryApp.querySelector(`#item-${itemId} .rating-selector`);
                ratingContainer.querySelectorAll('.rating-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.score == score));
                const notesDiv = supervisoryApp.querySelector(`#notes-${itemId}`);
                notesDiv.innerHTML = (detailedDescriptions[itemId] && detailedDescriptions[itemId][score]) ? detailedDescriptions[itemId][score] : '';
            }
            
            function updateScoreColor(element, score) {
                element.style.backgroundColor = '#f0f2f5';
                element.style.color = '#333';
                if (score == 1) { element.style.backgroundColor = '#d4edda'; element.style.color = '#155724'; }
                else if (score == 2) { element.style.backgroundColor = '#cce5ff'; element.style.color = '#004085'; }
                else if (score == 3) { element.style.backgroundColor = '#fff3cd'; element.style.color = '#856404'; }
                else if (score == 4) { element.style.backgroundColor = '#f8d7da'; element.style.color = '#721c24'; }
                else if (score == 5) { element.style.backgroundColor = '#dc3545'; element.style.color = '#fff'; }
            }
            
            function generateEvaluationForm() {
                const formContainer = supervisoryApp.querySelector('#evaluationForm');
                formContainer.innerHTML = '';
                let currentDomain = '';
                let detailsElement;
                evaluationItems.forEach(item => {
                    if (item.domain !== currentDomain) {
                        currentDomain = item.domain;
                        detailsElement = document.createElement('details');
                        detailsElement.open = true;
                        const summary = document.createElement('summary');
                        summary.textContent = currentDomain;
                        detailsElement.appendChild(summary);
                        formContainer.appendChild(detailsElement);
                    }
                    detailsElement.innerHTML += `
                        <div class="item-card" id="item-${item.id}">
                            <div class="item-header">
                                <h4>${item.id}. ${item.title} <br><small>${item.desc}</small></h4>
                                <div class="score" id="score-${item.id}">3</div>
                            </div>
                            <div class="rating-selector">
                               <button type="button" class="rating-btn score-1" data-score="1">متميز</button>
                               <button type="button" class="rating-btn score-2" data-score="2">جيد</button>
                               <button type="button" class="rating-btn score-3 active" data-score="3">ملائم</button>
                               <button type="button" class="rating-btn score-4" data-score="4">غير ملائم</button>
                               <button type="button" class="rating-btn score-5" data-score="5">تدخل سريع</button>
                            </div>
                            <div class="notes-wrapper">
                                <div id="notes-${item.id}" class="item-notes" contenteditable="true"></div>
                                ${recognition ? `<button type="button" class="mic-btn">🎤</button>` : ''}
                            </div>
                        </div>`;
                });
                evaluationItems.forEach(item => updateScore(item.id, 3));
            }
            
            function getSchoolName() { return supervisoryApp.querySelector('#school').value === 'other' ? supervisoryApp.querySelector('#school-other').value.trim() : supervisoryApp.querySelector('#school').value; }
            function getTeacherName() { return supervisoryApp.querySelector('#teacherName').value === 'other' ? supervisoryApp.querySelector('#teacherName-other').value.trim() : supervisoryApp.querySelector('#teacherName').value; }
            function populateDropdown(selectElement, dataArray, placeholderText) { selectElement.innerHTML = `<option value="">${placeholderText}</option>`; dataArray.forEach(item => { const option = document.createElement('option'); option.value = item; option.textContent = item; selectElement.appendChild(option); }); selectElement.innerHTML += `<option value="other">أخرى...</option>`; }
            function handleOtherOption(selectElement, otherInputElement) { otherInputElement.style.display = (selectElement.value === 'other') ? 'block' : 'none'; if (selectElement.value !== 'other') otherInputElement.value = ''; }
            function populateTeacherDropdown(schoolName) { populateDropdown(supervisoryApp.querySelector('#teacherName'), teachersBySchool[schoolName] || [], 'اختر المعلم...'); }

            function prepareOfficialPrint() {
                const printTbody = supervisoryApp.querySelector('#print-main-tbody');
                printTbody.innerHTML = '';
                ['school', 'teacherName', 'fileNumber', 'subject', 'visitNumber', 'visitDate', 'class', 'lesson', 'topic', 'visitorName', 'visitorPosition'].forEach(id => {
                    supervisoryApp.querySelector(`#print-${id}`).textContent = (id === 'school') ? getSchoolName() : (id === 'teacherName') ? getTeacherName() : supervisoryApp.querySelector(`#${id}`).value;
                });
                ['strengthsContent', 'developmentContent', 'recommendationsContent'].forEach(id => { supervisoryApp.querySelector(`#print-${id}`).innerText = supervisoryApp.querySelector(`#${id}`).value; });
                const groupedItems = evaluationItems.reduce((acc, item) => { acc[item.domain] = acc[item.domain] || {}; (acc[item.domain][item.standard] = acc[item.domain][item.standard] || []).push(item); return acc; }, {});
                for (const domain in groupedItems) {
                    const standards = groupedItems[domain];
                    const domainItemCount = Object.values(standards).flat().length;
                    let isFirstRowOfDomain = true;
                    for (const standard in standards) {
                        const items = standards[standard];
                        const standardItemCount = items.length;
                        items.forEach((item, itemIndex) => {
                            const row = document.createElement('tr');
                            const score = supervisoryApp.querySelector(`#score-${item.id}`).textContent;
                            let domainCell = (isFirstRowOfDomain && itemIndex === 0) ? `<td rowspan="${domainItemCount}" class="category-cell">${domain}</td>` : '';
                            let standardCell = (itemIndex === 0) ? `<td rowspan="${standardItemCount}" class="category-cell">${standard}</td>` : '';
                            row.innerHTML = `${domainCell}${standardCell}<td>${item.id}</td><td class="item-cell">${item.title}</td><td>${score}</td>`;
                            printTbody.appendChild(row);
                        });
                        isFirstRowOfDomain = false;
                    }
                }
            }

            function printOfficialReport() { prepareOfficialPrint(); window.print(); }
            
            function exportToWord() {
                prepareOfficialPrint();
                const fileName = `${supervisoryApp.querySelector('#visitNumber').value.trim() || 'زيارة'} - ${getSchoolName() || 'مدرسة'} - ${getTeacherName() || 'معلم'}.docx`;
                
                // Define print styles as a string to avoid cross-origin issues from reading external stylesheets
                const printStyles = `
                    .print-view { display: block !important; }
                    .print-logo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                    .print-logo-header img { max-height: 70px; }
                    .print-header-text, .print-title { text-align: center; font-weight: bold; margin-bottom: 15px; }
                    .print-main-table, .print-info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                    .print-main-table th, .print-main-table td, .print-info-table td { border: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle; }
                    .print-main-table th { background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
                    .print-info-table .label { font-weight: bold; background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; color-adjust: exact; width: 15%; }
                    .item-cell { text-align: right !important; }
                    .category-cell { font-weight: bold; }
                    .report-section-print { margin-top: 20px; border: 2px solid #000; padding: 10px; page-break-inside: avoid; }
                    .report-section-print h3 { margin: 0 0 10px 0; font-size: 1.2rem; background-color: #f2f2f2 !important; padding: 5px; text-align: center; -webkit-print-color-adjust: exact; color-adjust: exact; border-bottom: 1px solid #000; }
                    .print-report-box { white-space: pre-wrap; text-align: right; min-height: 80px; }
                    .signature-section { margin-top: 40px; page-break-inside: avoid; }
                    .evaluation-standard { text-align: center; font-size: 0.9em; margin-top: 20px; border-top: 1px solid #000; padding-top: 5px;}
                `;

                const content = `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>body { font-family: 'Times New Roman', Times, serif; direction: rtl; } ${printStyles} </style></head><body>${supervisoryApp.querySelector("#printView").innerHTML}</body></html>`;
                
                const converted = htmlDocx.asBlob(content, { orientation: 'portrait', margins: { top: 720, right: 720, bottom: 720, left: 720 } });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(converted);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function generateReport() {
                let itemsByScore = { 1: [], 2: [], 3: [], 4: [], 5: [] };
                evaluationItems.forEach(item => {
                    const score = parseInt(supervisoryApp.querySelector(`#score-${item.id}`).textContent);
                    itemsByScore[score].push({ id: item.id, title: item.title, standard: item.standard, notes: supervisoryApp.querySelector(`#notes-${item.id}`).innerHTML });
                });

                const strengths = [...itemsByScore[1], ...itemsByScore[2]].slice(0, 4);
                const developments = [...itemsByScore[5], ...itemsByScore[4]].slice(0, 4);
                
                let recommendationsList = [...developments];
                const extraRecs = itemsByScore[3].sort(() => 0.5 - Math.random()).slice(0, 2);
                extraRecs.forEach(rec => { if (!recommendationsList.find(item => item.id === rec.id)) recommendationsList.push(rec); });

                supervisoryApp.querySelector('#strengthsContent').value = strengths.map(s => `${s.standard}: ${s.notes.replace(/<[^>]*>?/gm, '')}`).join('\n\n');
                supervisoryApp.querySelector('#developmentContent').value = developments.map(d => `${d.standard}: ${d.notes.replace(/<[^>]*>?/gm, '')}`).join('\n\n');
                let recommendationsText = "نوصي المعلم بالآتي:\n\n";
                recommendationsList.forEach(rec => { if (instructionalRecommendations[rec.id]) recommendationsText += `• ${rec.standard} - ${rec.title}: ${instructionalRecommendations[rec.id]}\n\n`; });
                supervisoryApp.querySelector('#recommendationsContent').value = recommendationsText + "والله ولي التوفيق.";

                supervisoryApp.querySelector('#reportSection').style.display = 'block';
                supervisoryApp.querySelector('#reportSection').scrollIntoView({ behavior: 'smooth' });
            }
            
            function startDictation(textareaId, button) {
                if (!recognition) { displayStatusMessage('عذراً، متصفحك لا يدعم خاصية الإملاء الصوتي.', 'red'); return; }
                button.classList.add('recording'); button.textContent = '🔴';
                recognition.start();
                recognition.onresult = (event) => { supervisoryApp.querySelector(`#${textareaId}`).innerHTML += (supervisoryApp.querySelector(`#${textareaId}`).textContent.length > 0 ? ' ' : '') + event.results[0][0].transcript; };
                recognition.onspeechend = () => recognition.stop();
                recognition.onerror = (event) => console.error('Speech recognition error:', event.error);
                recognition.onend = () => { button.classList.remove('recording'); button.textContent = '🎤'; };
            }

            function copyReportContent(textareaId, buttonElement) {
                const textareaToCopy = supervisoryApp.querySelector(`#${textareaId}`);
                if (!textareaToCopy || !textareaToCopy.value) { displayStatusMessage('لا يوجد محتوى لنسخه.', 'orange'); return; }
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = textareaToCopy.value;
                tempTextarea.style.position = 'absolute'; tempTextarea.style.left = '-9999px';
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        const originalText = buttonElement.textContent;
                        buttonElement.textContent = 'تم النسخ!';
                        buttonElement.style.backgroundColor = 'var(--success-color)';
                        displayStatusMessage(`تم نسخ المحتوى بنجاح.`, 'green');
                        setTimeout(() => { buttonElement.textContent = originalText; buttonElement.style.backgroundColor = 'var(--dark-gray)'; }, 2000);
                    } else { displayStatusMessage('فشل النسخ.', 'red'); }
                } catch (err) { console.error('Failed to copy: ', err); displayStatusMessage('فشل النسخ.', 'red'); }
                document.body.removeChild(tempTextarea);
            }

            function showConfirmationModal(title, message, onConfirm) {
                supervisoryApp.querySelector('#supervisory-modal-title').textContent = title;
                supervisoryApp.querySelector('#supervisory-modal-message').textContent = message;
                const modal = supervisoryApp.querySelector('#supervisoryConfirmationModal');
                modal.style.display = 'flex';
                const confirmBtn = supervisoryApp.querySelector('#supervisory-modal-confirm-btn');
                const cancelBtn = supervisoryApp.querySelector('#supervisory-modal-cancel-btn');
                const confirmHandler = () => { onConfirm(); hideConfirmationModal(); cleanup(); };
                const cancelHandler = () => { hideConfirmationModal(); cleanup(); };
                const cleanup = () => { confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); };
                confirmBtn.addEventListener('click', confirmHandler, { once: true });
                cancelBtn.addEventListener('click', cancelHandler, { once: true });
            }

            function hideConfirmationModal() { supervisoryApp.querySelector('#supervisoryConfirmationModal').style.display = 'none'; }
            function showResetConfirmation() { showConfirmationModal('تأكيد إعادة التعيين', 'هل أنت متأكد؟ سيتم فقدان جميع البيانات المدخلة.', performReset); }
            function performReset() { clearForm(); displayStatusMessage('تم مسح النموذج الحالي بنجاح.', 'green'); }
            
            function clearForm() {
                supervisoryApp.querySelector('#evaluationForm').reset();
                const schoolSelect = supervisoryApp.querySelector('#school');
                schoolSelect.selectedIndex = 0;
                schoolSelect.dispatchEvent(new Event('change'));
                supervisoryApp.querySelector('#teacherName').innerHTML = '<option value="">اختر المعلم...</option>';
                supervisoryApp.querySelectorAll('.info-grid input, .report-content-area').forEach(input => { if (input.id !== 'visitorName' && input.id !== 'visitorPosition') input.value = ''; });
                supervisoryApp.querySelector('#subject').value = 'الرياضة المدرسية';
                supervisoryApp.querySelector('#visitDate').value = new Date().toISOString().split('T')[0];
                evaluationItems.forEach(item => updateScore(item.id, 3));
                supervisoryApp.querySelector('#reportSection').style.display = 'none';
            }

            function displayStatusMessage(message, color) {
                const statusElement = supervisoryApp.querySelector('#status-message');
                statusElement.textContent = message;
                statusElement.style.color = color;
                statusElement.style.opacity = 1;
                setTimeout(() => { statusElement.style.opacity = 0; }, 3000);
            }
            
            function savePermanentReport() {
                const teacherName = getTeacherName();
                const visitDate = supervisoryApp.querySelector('#visitDate').value;
                if (!teacherName || !visitDate) { displayStatusMessage('الرجاء إدخال اسم المعلم وتاريخ الزيارة.', 'red'); return; }
                const reportId = `visit_v5_${Date.now()}`;
                const reportData = { id: reportId, teacherName, visitDate, school: getSchoolName(), formData: {} };
                supervisoryApp.querySelectorAll('input, select, textarea').forEach(el => { if (el.id) reportData.formData[el.id] = el.value; });
                evaluationItems.forEach(item => { reportData.formData[`score-${item.id}`] = supervisoryApp.querySelector(`#score-${item.id}`).textContent; reportData.formData[`notes-${item.id}`] = supervisoryApp.querySelector(`#notes-${item.id}`).innerHTML; });
                localStorage.setItem(reportId, JSON.stringify(reportData));
                const visitDataForDashboard = { date: visitDate, scores: {} };
                evaluationItems.forEach(item => visitDataForDashboard.scores[`item-${item.id}`] = parseInt(supervisoryApp.querySelector(`#score-${item.id}`).textContent) || 3);
                const teacherArchiveKey = `teacher_archive_v5_${teacherName}`;
                let archive = JSON.parse(localStorage.getItem(teacherArchiveKey)) || [];
                const existingVisitIndex = archive.findIndex(v => v.date === visitDate);
                if (existingVisitIndex > -1) archive[existingVisitIndex] = visitDataForDashboard; else archive.push(visitDataForDashboard);
                archive.sort((a, b) => new Date(a.date) - new Date(b.date));
                localStorage.setItem(teacherArchiveKey, JSON.stringify(archive));
                displayStatusMessage(`تم حفظ التقرير للمعلم: ${teacherName} بنجاح!`, '#3f51b5');
            }

            function loadPermanentReport(reportKey) {
                const data = JSON.parse(localStorage.getItem(reportKey));
                if (data && data.formData) {
                    clearForm();
                    Object.keys(data.formData).forEach(key => {
                        const el = supervisoryApp.querySelector(`#${key}`);
                        if (el) {
                            if (el.classList.contains('item-notes')) el.innerHTML = data.formData[key];
                            else if (el.classList.contains('score')) el.textContent = data.formData[key];
                            else el.value = data.formData[key];
                            if (el.id === 'school') {
                                el.dispatchEvent(new Event('change'));
                                setTimeout(() => { const teacherEl = supervisoryApp.querySelector('#teacherName'); if (teacherEl) { teacherEl.value = data.formData['teacherName']; teacherEl.dispatchEvent(new Event('change')); } }, 100);
                            } else if (el.id === 'teacherName') { el.dispatchEvent(new Event('change')); }
                        }
                    });
                    evaluationItems.forEach(item => updateScore(item.id, parseInt(data.formData[`score-${item.id}`] || 3)));
                    toggleView('form-view');
                    displayStatusMessage(`تم تحميل التقرير المحفوظ.`, '#007bff');
                }
            }

            function deletePermanentReport(reportKey) {
                const data = JSON.parse(localStorage.getItem(reportKey));
                if (!data) return;
                showConfirmationModal('تأكيد الحذف', `هل أنت متأكد من حذف تقرير المعلم ${data.teacherName}؟`, () => {
                    localStorage.removeItem(reportKey);
                    const teacherArchiveKey = `teacher_archive_v5_${data.teacherName}`;
                    let archive = (JSON.parse(localStorage.getItem(teacherArchiveKey)) || []).filter(visit => visit.date !== data.visitDate);
                    if (archive.length > 0) localStorage.setItem(teacherArchiveKey, JSON.stringify(archive)); else localStorage.removeItem(teacherArchiveKey);
                    renderSavedReports();
                    displayStatusMessage(`تم حذف التقرير بنجاح.`, 'red');
                });
            }

            function saveVisitorData() { localStorage.setItem('visitorData_v5', JSON.stringify({ name: supervisoryApp.querySelector('#visitorName').value, position: supervisoryApp.querySelector('#visitorPosition').value })); }
            function loadVisitorData() { const d = JSON.parse(localStorage.getItem('visitorData_v5')); supervisoryApp.querySelector('#visitorName').value = (d && d.name) || 'أسعد بن محفوظ الخصيبي'; supervisoryApp.querySelector('#visitorPosition').value = (d && d.position) || 'مشرف رياضة مدرسية'; }
            function saveTemplate() { const name = prompt("الرجاء إدخال اسم للقالب:"); if (!name) return; const data = {}; supervisoryApp.querySelectorAll('input, select').forEach(el => { if (el.id) data[el.id] = el.value; }); evaluationItems.forEach(item => { data[`score-${item.id}`] = supervisoryApp.querySelector(`#score-${item.id}`).textContent; data[`notes-${item.id}`] = supervisoryApp.querySelector(`#notes-${item.id}`).innerHTML; }); let templates = JSON.parse(localStorage.getItem('evaluationTemplates_v5')) || {}; templates[name] = data; localStorage.setItem('evaluationTemplates_v5', JSON.stringify(templates)); populateTemplateDropdown(); displayStatusMessage(`تم حفظ القالب "${name}".`, 'green'); }
            function loadTemplate() {
                const templateName = supervisoryApp.querySelector('#template-select').value;
                if (!templateName) return;
                const data = (JSON.parse(localStorage.getItem('evaluationTemplates_v5')) || {})[templateName];
                if (data) {
                    Object.keys(data).forEach(key => {
                        const el = supervisoryApp.querySelector(`#${key}`);
                        if (el) {
                            if (el.classList.contains('item-notes')) el.innerHTML = data[key];
                            else if (el.classList.contains('score')) el.textContent = data[key];
                            else el.value = data[key];
                            if (el.id === 'school') {
                                el.dispatchEvent(new Event('change'));
                                setTimeout(() => { const teacherEl = supervisoryApp.querySelector('#teacherName'); if (teacherEl) { teacherEl.value = data['teacherName']; teacherEl.dispatchEvent(new Event('change')); } }, 100);
                            }
                        }
                    });
                    evaluationItems.forEach(item => updateScore(item.id, parseInt(supervisoryApp.querySelector(`#score-${item.id}`).textContent)));
                    displayStatusMessage(`تم تحميل القالب "${templateName}".`, '#007bff');
                }
            }
            function populateTemplateDropdown() { const select = supervisoryApp.querySelector('#template-select'); const templates = JSON.parse(localStorage.getItem('evaluationTemplates_v5')) || {}; select.innerHTML = '<option value="">اختر قالبًا...</option>'; for (const name in templates) select.innerHTML += `<option value="${name}">${name}</option>`; }
            function exportAllData() {
                let allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('visit_v5_') || key.startsWith('teacher_archive_v5_') || key === 'visitorData_v5' || key === 'evaluationTemplates_v5') {
                        allData[key] = localStorage.getItem(key);
                    }
                }
                if (Object.keys(allData).length === 0) { displayStatusMessage('لا توجد بيانات لتصديرها.', 'orange'); return; }
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" }));
                link.download = `evaluation_backup_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
                URL.revokeObjectURL(link.href);
                displayStatusMessage('تم تصدير جميع البيانات بنجاح.', 'green');
            }
            function triggerImport() { supervisoryApp.querySelector('#import-file-input').click(); }
            function importData(event) {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { try { const data = JSON.parse(e.target.result); showConfirmationModal('تأكيد الاستيراد', 'سيتم استبدال جميع البيانات الحالية.', () => { Object.keys(data).forEach(key => localStorage.setItem(key, data[key])); renderSavedReports(); displayStatusMessage('تم استيراد البيانات بنجاح!', 'green'); }); } catch (error) { displayStatusMessage('ملف غير صالح.', 'red'); } };
                reader.readAsText(file);
                event.target.value = null;
            }

            function renderSavedReports() {
                const listContainer = supervisoryApp.querySelector('#saved-reports-list');
                const noReportsMessage = supervisoryApp.querySelector('#no-saved-reports-message');
                const filterText = supervisoryApp.querySelector('#filter-reports-input').value.toLowerCase();
                listContainer.innerHTML = '';
                let reports = [];
                for (let i = 0; i < localStorage.length; i++) { if (localStorage.key(i).startsWith('visit_v5_')) reports.push({ key: localStorage.key(i), data: JSON.parse(localStorage.getItem(localStorage.key(i))) }); }
                reports.sort((a, b) => new Date(b.data.visitDate) - new Date(a.data.visitDate));
                let reportsFound = false;
                reports.forEach(({ key, data }) => {
                    const schoolName = data.school === 'other' ? data.formData['school-other'] : data.school;
                    if (data.teacherName.toLowerCase().includes(filterText) || (schoolName && schoolName.toLowerCase().includes(filterText))) {
                        reportsFound = true;
                        const card = document.createElement('div');
                        card.className = 'saved-report-card';
                        card.innerHTML = `<div class="saved-report-info"><strong>المعلم:</strong> ${data.teacherName}<br><strong>المدرسة:</strong> ${schoolName || 'غير محدد'}<br><strong>التاريخ:</strong> ${data.visitDate}</div><div class="saved-report-actions"><button class="load-btn" data-key="${key}">تحميل</button><button class="delete-btn" data-key="${key}">حذف</button></div>`;
                        listContainer.appendChild(card);
                    }
                });
                noReportsMessage.style.display = reportsFound ? 'none' : 'block';
            }

            function populateTeacherDashboardDropdown() {
                const teacherSelect = supervisoryApp.querySelector('#teacher-dashboard-select');
                const teacherNames = new Set();
                for (let i = 0; i < localStorage.length; i++) if (localStorage.key(i).startsWith('teacher_archive_v5_')) teacherNames.add(localStorage.key(i).replace('teacher_archive_v5_', ''));
                teacherSelect.innerHTML = '<option value="">اختر معلمًا...</option>';
                teacherNames.forEach(name => teacherSelect.innerHTML += `<option value="${name}">${name}</option>`);
            }

            function updateDashboardView() {
                if (performanceChartInstance) performanceChartInstance.destroy();
                const teacherName = supervisoryApp.querySelector('#teacher-dashboard-select').value;
                const chartContainer = supervisoryApp.querySelector('#chart-container');
                const noDataMessage = supervisoryApp.querySelector('#no-data-message');
                const chartType = supervisoryApp.querySelector('#chartTypeSelect').value;
                supervisoryApp.querySelector('#visitDateGroup').style.display = (chartType === 'radar') ? 'block' : 'none';

                if (!teacherName) { chartContainer.style.display = 'none'; noDataMessage.style.display = 'block'; return; }
                const archive = JSON.parse(localStorage.getItem(`teacher_archive_v5_${teacherName}`));
                if (!archive || archive.length === 0) { chartContainer.style.display = 'none'; noDataMessage.style.display = 'block'; return; }
                
                chartContainer.style.display = 'block';
                noDataMessage.style.display = 'none';
                const visitDateSelect = supervisoryApp.querySelector('#visitDateSelect');
                visitDateSelect.innerHTML = '';
                archive.forEach(visit => visitDateSelect.innerHTML += `<option value="${visit.date}">${visit.date}</option>`);
                if (archive.length > 0) visitDateSelect.value = archive[archive.length - 1].date;

                const ctx = supervisoryApp.querySelector('#performanceChart').getContext('2d');
                const labels = evaluationItems.map(item => `${item.id}. ${item.standard}`);
                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8D6E63', '#EC407A', '#7E57C2', '#26A69A', '#D4E157', '#FF7043', '#78909C', '#5C6BC0'];
                let chartConfig;

                if (chartType === 'line') {
                    chartConfig = { type: 'line', data: { labels: archive.map(v => v.date), datasets: evaluationItems.map((item, index) => ({ label: item.title, data: archive.map(visit => visit.scores[`item-${item.id}`] || 0), borderColor: colors[index % colors.length], fill: false, tension: 0.1 })) } };
                } else if (chartType === 'radar') {
                    const visitData = archive.find(v => v.date === visitDateSelect.value);
                    const data = visitData ? evaluationItems.map(item => visitData.scores[`item-${item.id}`] || 0) : [];
                    chartConfig = { type: 'radar', data: { labels, datasets: [{ label: `أداء زيارة ${visitDateSelect.value}`, data, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgb(54, 162, 235)' }] } };
                } else { // bar
                    const avgScores = evaluationItems.map(item => { const scores = archive.map(visit => visit.scores[`item-${item.id}`] || 0); return scores.reduce((a, b) => a + b, 0) / scores.length || 0; });
                    chartConfig = { type: 'bar', data: { labels, datasets: [{ label: 'متوسط الأداء العام', data: avgScores, backgroundColor: colors }] } };
                }
                chartConfig.options = { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `تحليل أداء المعلم: ${teacherName}`, font: { size: 18, family: 'Tajawal' } }, legend: { display: chartType !== 'bar' } }, scales: { y: { reverse: true, min: 1, max: 5, ticks: { stepSize: 1, callback: (v) => ['متميز', 'جيد', 'ملائم', 'غير ملائم', 'تدخل سريع'][v-1] || '' } }, r: { reverse: true, min: 1, max: 5, pointLabels: { font: { size: 12, family: 'Tajawal' } }, ticks: { stepSize: 1, backdropColor: 'transparent', callback: (v) => ['متميز', 'جيد', 'ملائم', 'غير ملائم', ''][v - 1] || '' } } } };
                performanceChartInstance = new Chart(ctx, chartConfig);
            }
            
            // --- EVENT LISTENERS ---
            supervisoryApp.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => toggleView(tab.dataset.view)));
            supervisoryApp.querySelector('#evaluationForm').addEventListener('click', e => {
                if (e.target.matches('.rating-btn')) updateScore(e.target.closest('.item-card').id.split('-')[1], e.target.dataset.score);
                if (e.target.matches('.mic-btn')) startDictation(e.target.previousElementSibling.id, e.target);
            });
            supervisoryApp.querySelector('#school').addEventListener('change', e => { handleOtherOption(e.target, supervisoryApp.querySelector('#school-other')); populateTeacherDropdown(e.target.value); });
            supervisoryApp.querySelector('#teacherName').addEventListener('change', e => handleOtherOption(e.target, supervisoryApp.querySelector('#teacherName-other')));
            ['visitorName', 'visitorPosition'].forEach(id => supervisoryApp.querySelector(`#${id}`).addEventListener('input', saveVisitorData));
            ['loadTemplateBtn', 'saveTemplateBtn', 'savePermanentReportBtn', 'generateReportBtn', 'printOfficialReportBtn', 'exportToWordBtn', 'showResetConfirmationBtn', 'updateDashboardViewBtn', 'triggerImportBtn', 'exportAllDataBtn'].forEach(id => {
                supervisoryApp.querySelector(`#${id}`).addEventListener('click', { loadTemplate, saveTemplate, savePermanentReport, generateReport, printOfficialReport, exportToWord, showResetConfirmation, updateDashboardView, triggerImport, exportAllData }[id.replace('Btn', '')]);
            });
            ['teacher-dashboard-select', 'chartTypeSelect', 'visitDateSelect'].forEach(id => supervisoryApp.querySelector(`#${id}`).addEventListener('change', updateDashboardView));
            supervisoryApp.querySelector('#filter-reports-input').addEventListener('input', renderSavedReports);
            supervisoryApp.querySelector('#import-file-input').addEventListener('change', importData);
            supervisoryApp.querySelector('#reportSection').addEventListener('click', e => { if(e.target.matches('.copy-btn')) copyReportContent(e.target.dataset.target, e.target); });
            supervisoryApp.querySelector('#saved-reports-list').addEventListener('click', e => {
                if (e.target.matches('.load-btn')) loadPermanentReport(e.target.dataset.key);
                if (e.target.matches('.delete-btn')) deletePermanentReport(e.target.dataset.key);
            });

            // --- INITIALIZATION ---
            generateEvaluationForm();
            populateDropdown(supervisoryApp.querySelector('#school'), schoolsList.sort((a, b) => a.localeCompare(b, 'ar')), 'اختر المدرسة...');
            populateTemplateDropdown();
            loadVisitorData();
            supervisoryApp.querySelector('#visitDate').value = new Date().toISOString().split('T')[0];
            toggleView('form-view');
        }


        // --- SCHOOL VISITS APP CODE ---
        function initializeSchoolApp() {
            let app, db, auth, userId, unsubscribeReports = null, unsubscribeVisitTypes = null, confirmationCallback = null;
            let visitTypesData = {}, savedReports = [], currentAttachments = [], currentVisitTypeKey = '', previewSource = 'form';
            const defaultVisitTypesData = { 'custom_exploratory': { name: 'زيارة استطلاعية', objectives_list: ["مقابلة مديرة المدرسة معلمةالرياضة المدرسية.", "حضور الطابور المدرسي.", "تحديث قاعدة بيانات المعلمة.", "متابعة موافقات التعيين.", "متابعة توفر الأدلة وكتاب الطالب وتحديثها.", "متابعة توزيع الجدول ونصاب الحصص للمعلمة.", "متابعة الملاعب وتخطيطها والأدوات الرياضية.", "متابعة النشرات ووثائق التقويم ومناقشة مستجداتها.", "متابعة المنهاج وسجلات المعلمة.", "حضور حصة للمعلمة والمداولة الاشرافية."], completedOpinions: ["تم مقابلة الفاضلة مديرة المدرسة ومعلمة الرياضة المدرسية.", "تم حضور الطابور المدرسي وكان الهتاف بصوت عالي والانصراف منظم ومراسم رفع العلم صحيحة.", "تم تحديث قاعدة بيانات المعلمة عبر الرابط.", "تم متابعة موافقات التعيين والمعلمة على اقامة المدرسة.", "تم متابعة توفر الأدلة وتحديثها وكانت محدثة.", "تم متابعة توزيع الجدول المدرسي وكان متوافقًا مع الأنظمة.", "تم متابعة الملاعب وتخطيطها والأدوات الرياضية وكانت متوفرة.", "تم متابعة النشرات ووثائق التقويم ومناقشة مستجداتها.", "تم متابعة المنهاج وسجلات المعلمة وكانت مكتملة وتم اعتماد خطط المعلمة الفصلية.", "تم حضور موقف صفي للمعلمة وكان الأداء جيد جدا."], incompleteOpinions: ["تم مقابلة الفاضلة مديرة المدرسة وبغياب معلمة الرياضة المدرسية.", "تم حضور الطابور المدرسي وكان الهتاف بصوت منخفض والانصراف غير منظم وتلاحظ اخطاء في مراسم رفع العلم وتم توجيه المعلم المسؤول عن الكشافة بتدريب الكشافة على المراسم الصحيحة.", "قاعدة بيانات المعلمة بحاجة إلى تحديث، وتم التنبيه على ضرورة استكمالها عبر الرابط.", "", "تم متابعة توفر الأدلة وتحديثها وكانت محدثة بصيغة (PDF).", "تم متابعة توزيع الجدول المدرسي وتلاحظ وجود حصص موزعة في الجدول السابعة والثامنة وكذلك تفريغ المعلمة يوم الثلاثاء بدون عذر مقبول وتم توجيه ادارة المدرسة بتعديل ذلك والابتعاد عن الحصص الأخيرة.", "تم متابعة الملاعب وتخطيطها والأدوات الرياضية وتلاحظ عدم وجود أدوات رياضية في المدرسة وتم توجيه إدارة المدرسة بتوفير الأدوات وتجديد تخطيط الملعب.", "تم متابعة النشرات ووثائق التقويم ومناقشة مستجداتها ولوحظ عدم وصول النشرات الى المعلمين وتم ارسال النشرات والوثائق مرة اخرى الى المعلمين عبر الوتساب.", "تم متابعة المنهاج وسجلات المعلمة وكانت غير مكتملة، وتم توجيه المعلمة لاستكمالها.", "تعذر حضور حصة مع المعلمة."], recommendations: ["متابعة التزام الهيئة التدريسية بالحضور.", "متابعة تدريب الكشافة على مراسم رفع العلم الصحيحة وتحسين تنظيم انصراف الطلبة.", "التأكيد على تحديث قاعدة بيانات المعلمة بشكل دوري.", "ضرورة الإسراع في استكمال موافقات التعيين الرسمية.", "التواصل مع الجهات المعنية لتوفير الكتب المدرسية الناقصة.", "تغيير جدول المعلمة ليكون لديها حصة رياضة كل يوم، وتوزيع الحصص بحيث يتم الابتعاد عن الحصص السابعة والثامنة.", "توفير الأدوات الرياضية حسب الكشف المرفق ونخص بالذكر (جهاز الوثب العالي مع المرتبة الخاصة به، الصندوق المقسم، المقعد السويدي، مرمى لكرة اليد عدد (2)، قوائم للسلة عدد (2)، شبك لكرة الطائرة) بالإضافة لباقي الأدوات في الكشف، وتجديد تخطيط الملعب.", "التأكيد على وصول جميع النشرات والوثائق للمعلمين وتوثيق استلامهم لها.", "متابعة استكمال سجلات المعلمة (التحضير+الزي والملاحظة+الخطة).", "التنسيق المسبق مع المعلمة لحضور حصة دراسية."] }, 'supervisory_october': { name: 'زيارة اشرافية (أكتوبر)', objectives_list: ["الالتقاء بالفاضلة مديرة المدرسة ومعلمةالرياضة المدرسية.", "حضور الطابور المدرسي.", "متابعة تنفيذ خطة المنهاج والاطلاع على سجلات المتابعة (الزي والمشاركة).", "حضور موقف صفي مع المعلمة والمداولة الاشرافية.", "شرح اليه تنفيذ الحصة كتطبيقات تنافسية.", "حث المعلمة على الاطلاع على زياراته الاشرافية والحرص على الالتزام بتنفيذ النشرات الخاصة بالمادة.", "متابعة تنفيذ التوصيات السابقة."], completedOpinions: ["تم الالتقاء بالفاضلة مديرة المدرسة ومعلمة الرياضة المدرسية.", "تم حضور الطابور المدرسي وكان منظماً.", "تم متابعة تنفيذ خطة المنهاج وسجلات المتابعة وكانت مكتملة.", "تم حضور موقف صفي مع المعلمة وكانت المداولة مثمرة.", "تم شرح اليه تنفيذ الحصة كتطبيقات تنافسية.", "تم حث المعلمة على الاطلاع على الزيارات الاشرافية والالتزام بالنشرات.", "تمت متابعة تنفيذ التوصيات السابقة وكانت مكتملة."], incompleteOpinions: ["تم الالتقاء بالفاضلة مديرة المدرسة وبغياب معلمة الرياضة المدرسية.", "لوحظ وجود بعض الملاحظات في تنظيم الطابور المدرسي.", "سجلات المتابعة (الزي والمشاركة) غير مكتملة، وتم توجيه المعلمة لاستكمالها.", "تعذر حضور موقف صفي مع المعلمة.", "لوحظ ضعف في تطبيق الحصة كتطبيقات تنافسية، وتم إعادة شرح الآلية للمعلمة.", "لوحظ عدم اطلاع المعلمة على الزيارات السابقة، وتم التأكيد عليها بضرورة المتابعة.", "بعض التوصيات السابقة لم يتم تنفيذها، وتم مناقشة الأسباب مع المعلمة والإدارة."], recommendations: ["متابعة التزام الهيئة التدريسية بالحضور.", "تحسين تنظيم الطابور الصباحي.", "ضرورة استكمال سجلات المتابعة (الزي والمشاركة) بشكل دوري.", "التنسيق المسبق لحضور موقف صفي.", "التأكيد على تنفيذ الحصص كتطبيقات تنافسية لزيادة تفاعل الطلبة.", "حث المعلمة على المتابعة الدورية للزيارات الإشرافية والنشرات.", "متابعة تنفيذ التوصيات السابقة وتقديم الدعم اللازم."] } };

            const authView = schoolApp.querySelector('#authView'), schoolDashboardView = schoolApp.querySelector('#schoolDashboardView'), schoolFormView = schoolApp.querySelector('#schoolFormView'), reportPreviewContainer = schoolApp.querySelector('#reportPreviewContainer');
            const authTitle = schoolApp.querySelector('#authTitle'), authMessage = schoolApp.querySelector('#authMessage'), loginForm = schoolApp.querySelector('#loginForm'), registerForm = schoolApp.querySelector('#registerForm'), resetPasswordForm = schoolApp.querySelector('#resetPasswordForm'), showRegisterBtn = schoolApp.querySelector('#showRegister'), showLoginFromRegisterBtn = schoolApp.querySelector('#showLoginFromRegister'), showResetBtn = schoolApp.querySelector('#showReset'), backToLoginBtn = schoolApp.querySelector('#backToLogin'), userEmailDisplay = schoolApp.querySelector('#userEmailDisplay'), logoutBtn = schoolApp.querySelector('#logoutBtn');
            const reportForm = schoolApp.querySelector('#reportForm'), reportIdInput = schoolApp.querySelector('#reportId'), formTitle = schoolApp.querySelector('#formTitle'), schoolNameSelect = schoolApp.querySelector('#schoolName'), visitTypeSelect = schoolApp.querySelector('#visitTypeSelect'), objectivesContainer = schoolApp.querySelector('#objectivesContainer'), opinionsContainer = schoolApp.querySelector('#opinionsContainer'), recommendationsTextarea = schoolApp.querySelector('#recommendations'), attachmentsInput = schoolApp.querySelector('#attachmentsInput'), attachmentsList = schoolApp.querySelector('#attachmentsList');
            const addNewReportBtn = schoolApp.querySelector('#addNewReportBtn'), backToDashboardBtn = schoolApp.querySelector('#backToDashboardBtn'), prepareReportBtn = schoolApp.querySelector('#prepareReportBtn'), backToBtn = schoolApp.querySelector('#backToBtn'), selectAllObjectivesBtn = schoolApp.querySelector('#selectAllObjectivesBtn'), copyAllBtn = schoolApp.querySelector('#copyAllBtn'), generateRecsBtn = schoolApp.querySelector('#generate-recommendations-btn');
            const reportsListContainer = schoolApp.querySelector('#reportsListContainer');
            const manageVisitTypesBtn = schoolApp.querySelector('#manageVisitTypesBtn'), manageTypesModal = schoolApp.querySelector('#manageTypesModal'), closeManageModalBtn = schoolApp.querySelector('#closeManageModalBtn'), visitTypesList = schoolApp.querySelector('#visitTypesList'), addNewTypeBtn = schoolApp.querySelector('#addNewTypeBtn'), addEditTypeModal = schoolApp.querySelector('#addEditTypeModal'), addEditModalTitle = schoolApp.querySelector('#addEditModalTitle'), addEditTypeForm = schoolApp.querySelector('#addEditTypeForm'), editTypeKeyInput = schoolApp.querySelector('#editTypeKey'), typeNameInput = schoolApp.querySelector('#typeName'), typeObjectivesTextarea = schoolApp.querySelector('#typeObjectives'), cancelEditBtn = schoolApp.querySelector('#cancelEditBtn');
            const confirmationModal = schoolApp.querySelector('#confirmationModal'), confirmationModalTitle = schoolApp.querySelector('#confirmationModalTitle'), confirmationModalMessage = schoolApp.querySelector('#confirmationModalMessage'), confirmActionBtn = schoolApp.querySelector('#confirmActionBtn'), cancelActionBtn = schoolApp.querySelector('#cancelActionBtn');
            
            // --- FIX 1: Use injected firebase config if available, otherwise fallback to hardcoded. ---
            const firebaseConfig = typeof __firebase_config !== 'undefined'
                ? JSON.parse(__firebase_config)
                : { apiKey: "AIzaSyAEQsh6E351S1isxL4CFFGIpGSU2pVP5sc", authDomain: "my-report-9b33f.firebaseapp.com", projectId: "my-report-9b33f", storageBucket: "my-report-9b33f.appspot.com", messagingSenderId: "176527739587", appId: "1:176527739587:web:7a524a73a2355b5a503076" };
            
            try { 
                app = initializeApp(firebaseConfig, "schoolVisits"); 
                db = getFirestore(app); 
                auth = getAuth(app); 
            } catch (error) { 
                if (error.code !== 'duplicate-app') { 
                    console.error("Firebase initialization failed:", error); 
                    alert("فشل تهيئة قاعدة البيانات."); 
                    return; 
                } else {
                    // FIX: If app is already initialized, just get the existing instance.
                    // This is a safer way to handle potential re-initialization than creating a new app with a timestamp.
                    app = initializeApp(firebaseConfig, "schoolVisits" + Date.now()); // Using a unique name to avoid conflicts in some environments
                    db = getFirestore(app); 
                    auth = getAuth(app);
                }
            }
            
            // Automatic sign-in handler
            const handleInitialAuth = async () => {
                // The onAuthStateChanged listener below will handle the UI update after sign-in.
                try {
                    // If a custom token is provided by the environment, use it to sign in.
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } 
                    // If no user is currently signed in and no token is available, sign in anonymously.
                    else if (!auth.currentUser) {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Automatic sign-in failed:", error);
                    // If automatic sign-in fails, the app will default to the manual login form.
                }
            };

            // Attempt automatic sign-in when the app initializes.
            handleInitialAuth();
            
            onAuthStateChanged(auth, user => {
                if (user) { 
                    userId = user.uid; 
                    userEmailDisplay.textContent = user.isAnonymous ? `مستخدم زائر (ID: ${user.uid})` : user.email; 
                    setupFirestoreListeners(userId); 
                    showDashboardView(); 
                } 
                else { 
                    userId = null; 
                    if (unsubscribeReports) unsubscribeReports(); 
                    if (unsubscribeVisitTypes) unsubscribeVisitTypes(); 
                    savedReports = []; 
                    visitTypesData = {}; 
                    showAuthView(); 
                }
            });

            function setupFirestoreListeners(uid) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const reportsCollectionRef = collection(db, "artifacts", appId, "users", uid, "userReports");
                const visitTypesCollectionRef = collection(db, "artifacts", appId, "users", uid, "userVisitTypes");

                if (unsubscribeReports) unsubscribeReports();
                unsubscribeReports = onSnapshot(query(reportsCollectionRef), (snap) => { 
                    savedReports = []; 
                    snap.forEach((doc) => savedReports.push({ id: doc.id, ...doc.data() })); 
                    renderDashboard(); 
                }, (error) => console.error("Error fetching reports:", error));

                if (unsubscribeVisitTypes) unsubscribeVisitTypes();
                unsubscribeVisitTypes = onSnapshot(query(visitTypesCollectionRef), (snap) => {
                    if (snap.empty) { 
                        Object.keys(defaultVisitTypesData).forEach(key => addDoc(visitTypesCollectionRef, defaultVisitTypesData[key])); 
                    } 
                    else { 
                        visitTypesData = {}; 
                        snap.forEach((doc) => visitTypesData[doc.id] = doc.data()); 
                    }
                    populateVisitTypeDropdown(); 
                    renderObjectivesForCurrentType();
                }, (error) => console.error("Error fetching visit types:", error));
            }
            
            function showAuthForm(formToShow) { loginForm.classList.add('hidden'); registerForm.classList.add('hidden'); resetPasswordForm.classList.add('hidden'); formToShow.classList.remove('hidden'); authMessage.textContent = ''; authMessage.className = 'text-center mb-4 p-2 rounded-md'; if (formToShow === loginForm) authTitle.textContent = 'تسجيل الدخول'; if (formToShow === registerForm) authTitle.textContent = 'إنشاء حساب جديد'; if (formToShow === resetPasswordForm) authTitle.textContent = 'إعادة تعيين كلمة المرور'; }
            function setAuthMessage(message, isError = true) { authMessage.textContent = message; authMessage.className = `text-center mb-4 p-2 rounded-md ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`; }

            [showRegisterBtn, showLoginFromRegisterBtn, showResetBtn, backToLoginBtn].forEach(btn => btn.addEventListener('click', () => showAuthForm({ showRegister: registerForm, showLoginFromRegister: loginForm, showReset: resetPasswordForm, backToLogin: loginForm }[btn.id])));
            loginForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const email = loginForm.querySelector('#loginEmail').value;
                const password = loginForm.querySelector('#loginPassword').value;
                signInWithEmailAndPassword(auth, email, password)
                    .catch((error) => {
                        console.error("Login failed:", error.code);
                        switch (error.code) {
                            case 'auth/user-not-found':
                            case 'auth/wrong-password':
                            case 'auth/invalid-credential':
                                setAuthMessage("البريد الإلكتروني أو كلمة المرور غير صحيحة.");
                                break;
                            case 'auth/invalid-email':
                                setAuthMessage("صيغة البريد الإلكتروني غير صحيحة.");
                                break;
                            case 'auth/operation-not-allowed':
                                setAuthMessage("تسجيل الدخول بالبريد وكلمة المرور معطل. يتم الدخول تلقائيًا في البيئة المخصصة.");
                                break;
                            default:
                                setAuthMessage("حدث خطأ أثناء محاولة تسجيل الدخول.");
                        }
                    }); 
            });
            registerForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const email = registerForm.querySelector('#registerEmail').value;
                const password = registerForm.querySelector('#registerPassword').value;
                createUserWithEmailAndPassword(auth, email, password)
                    .then(() => {
                        setAuthMessage("تم إنشاء الحساب بنجاح! سيتم تسجيل دخولك.", false);
                    })
                    .catch(err => {
                        console.error("Registration failed:", err.code);
                        switch (err.code) {
                            case 'auth/email-already-in-use':
                                setAuthMessage("هذا البريد الإلكتروني مسجل بالفعل.");
                                break;
                            case 'auth/invalid-email':
                                setAuthMessage("صيغة البريد الإلكتروني غير صحيحة.");
                                break;
                            case 'auth/weak-password':
                                setAuthMessage("كلمة المرور ضعيفة جدًا. يجب أن تتكون من 6 أحرف على الأقل.");
                                break;
                            case 'auth/operation-not-allowed':
                                setAuthMessage("إنشاء حسابات جديدة معطل حاليًا.");
                                break;
                            default:
                                setAuthMessage("حدث خطأ أثناء محاولة إنشاء الحساب.");
                        }
                    }); 
            });
            resetPasswordForm.addEventListener('submit', (e) => { e.preventDefault(); sendPasswordResetEmail(auth, resetPasswordForm.querySelector('#resetEmail').value).then(() => setAuthMessage("تم إرسال الرابط.", false)).catch(() => setAuthMessage("لم يتم العثور على الحساب.")); });
            logoutBtn.addEventListener('click', () => signOut(auth));

            function showConfirmationModal(message, callback) { confirmationModalMessage.textContent = message; confirmationCallback = callback; confirmationModal.classList.remove('hidden'); }
            confirmActionBtn.addEventListener('click', () => { if (confirmationCallback) confirmationCallback(); confirmationModal.classList.add('hidden'); });
            cancelActionBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));

            function showDashboardView() { renderDashboard(); schoolDashboardView.classList.remove('hidden'); authView.classList.add('hidden'); schoolFormView.classList.add('hidden'); reportPreviewContainer.classList.add('hidden'); }
            function showAuthView() { authView.classList.remove('hidden'); schoolDashboardView.classList.add('hidden'); schoolFormView.classList.add('hidden'); reportPreviewContainer.classList.add('hidden'); showAuthForm(loginForm); }
            function showFormView(reportToEdit = null) { schoolFormView.classList.remove('hidden'); authView.classList.add('hidden'); schoolDashboardView.classList.add('hidden'); reportPreviewContainer.classList.add('hidden'); if (reportToEdit) { populateForm(reportToEdit); formTitle.textContent = 'تعديل تقرير زيارة'; } else { resetForm(); formTitle.textContent = 'إنشاء تقرير زيارة إشرافية'; } }
            function showPreviewView(reportData) { renderReportPreview(reportData); reportPreviewContainer.classList.remove('hidden'); schoolDashboardView.classList.add('hidden'); authView.classList.add('hidden'); schoolFormView.classList.add('hidden'); }
            
            function renderDashboard() { reportsListContainer.innerHTML = ''; if (!savedReports || savedReports.length === 0) { reportsListContainer.innerHTML = `<div class="text-center py-10 px-6 bg-gray-50 rounded-lg"><h3 class="text-lg font-semibold text-gray-700">لا توجد تقارير</h3><p class="text-gray-500 mt-2">ابدأ بإضافة تقريرك الأول.</p></div>`; return; } const list = document.createElement('div'); list.className = 'space-y-4'; savedReports.sort((a, b) => b.visitDate - a.visitDate).forEach(report => { const item = document.createElement('div'); item.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-white border rounded-lg shadow-sm hover:shadow-md transition-shadow gap-4'; const reportDate = new Date(report.visitDate).toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric' }); const attachmentIcon = (report.attachments && report.attachments.length > 0) ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a3 3 0 006 0V7a1 1 0 112 0v4a5 5 0 01-10 0V7a5 5 0 0110 0v4a1 1 0 11-2 0V7a3 3 0 00-3-3z" clip-rule="evenodd" /></svg>` : ''; item.innerHTML = `<div class="flex items-center">${attachmentIcon}<div><p class="font-bold text-gray-800">${report.schoolName}</p><p class="text-sm text-gray-500">${reportDate} - ${report.visitTypeName}</p></div></div><div class="flex gap-3 self-end sm:self-center"><button data-id="${report.id}" class="view-btn text-sm text-green-600 hover:underline">عرض</button><button data-id="${report.id}" class="edit-btn text-sm text-blue-600 hover:underline">تعديل</button><button data-id="${report.id}" class="delete-btn text-sm text-red-600 hover:underline">حذف</button></div>`; list.appendChild(item); }); reportsListContainer.appendChild(list); }
            
            function resetForm() { reportForm.reset(); reportIdInput.value = ''; schoolFormView.querySelector('#visitDate').valueAsDate = new Date(); const keys = Object.keys(visitTypesData); if (keys.length > 0) { currentVisitTypeKey = keys[0]; visitTypeSelect.value = currentVisitTypeKey; } currentAttachments = []; renderAttachmentsList(); renderObjectivesForCurrentType(); }
            function populateForm(report) { resetForm(); reportIdInput.value = report.id; schoolNameSelect.value = report.schoolName; schoolFormView.querySelector('#visitDate').value = new Date(report.visitDate).toISOString().split('T')[0]; recommendationsTextarea.value = report.recommendations; currentVisitTypeKey = report.visitTypeKey; visitTypeSelect.value = currentVisitTypeKey; currentAttachments = [] /* FIX: Do not load attachments, as they are not saved */; renderAttachmentsList(); renderObjectivesForCurrentType(); const checkboxes = objectivesContainer.querySelectorAll('input[type="checkbox"]'); checkboxes.forEach(cb => { if (report.checkedObjectives.includes(cb.dataset.genderedValue)) cb.checked = true; }); updateOpinionsSection(); setTimeout(() => { if (report.opinions) { report.opinions.forEach(op => { const textarea = schoolApp.querySelector(`#opinion-${op.index}`); if (textarea) textarea.value = op.text; }); } }, 0); }
            function populateVisitTypeDropdown() { visitTypeSelect.innerHTML = ''; const keys = Object.keys(visitTypesData); if (keys.length === 0) return; keys.forEach(key => { const option = document.createElement('option'); option.value = key; option.textContent = visitTypesData[key].name; visitTypeSelect.appendChild(option); }); currentVisitTypeKey = visitTypeSelect.value || keys[0]; if (currentVisitTypeKey) visitTypeSelect.value = currentVisitTypeKey; }
            function renderObjectivesForCurrentType() { if (!currentVisitTypeKey || !visitTypesData[currentVisitTypeKey]) { objectivesContainer.innerHTML = ''; return; } const data = visitTypesData[currentVisitTypeKey]; objectivesContainer.innerHTML = ''; data.objectives_list.forEach((objective, index) => { objectivesContainer.innerHTML += `<div class="flex items-start"><input id="objective-${index}" type="checkbox" value="${objective}" data-gendered-value="${objective}" data-index="${index}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mt-1"><label for="objective-${index}" class="mr-2 text-sm font-medium text-gray-900">${index + 1}- ${objective}</label></div>`; }); updateOpinionsSection(); updateSelectAllButtonState(); }
            
            function updateOpinionsSection() { const savedOpinions = new Map(); opinionsContainer.querySelectorAll('.opinion-block textarea').forEach(t => savedOpinions.set(t.id, t.value)); opinionsContainer.innerHTML = ''; const checked = objectivesContainer.querySelectorAll('input:checked'); if (checked.length === 0) { opinionsContainer.innerHTML = '<p class="text-center text-gray-500">لم يتم تحديد هدف.</p>'; return; } checked.forEach(cb => { const index = cb.dataset.index; opinionsContainer.innerHTML += `<div class="opinion-block space-y-2"><label for="opinion-${index}" class="block text-sm font-semibold text-gray-800">${parseInt(index) + 1}- ${cb.dataset.genderedValue}</label><div class="flex gap-2 flex-wrap"><button type="button" data-opinion="completed" data-index="${index}" class="px-3 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full hover:bg-green-200">✅ مكتمل</button><button type="button" data-opinion="incomplete" data-index="${index}" class="px-3 py-1 text-xs font-medium text-red-800 bg-red-100 rounded-full hover:bg-red-200">❌ غير مكتمل</button></div><textarea id="opinion-${index}" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300"></textarea></div>`; }); savedOpinions.forEach((val, id) => { const ta = schoolApp.querySelector(`#${id}`); if (ta) ta.value = val; }); }
            
            function renderAttachmentsList() { attachmentsList.innerHTML = ''; if (currentAttachments.length === 0) return; currentAttachments.forEach((file, index) => { attachmentsList.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-100 rounded-md text-sm"><span class="truncate">${file.name}</span><button type="button" data-index="${index}" class="remove-attachment-btn text-red-500">&times;</button></div>`; }); }
            attachmentsInput.addEventListener('change', (e) => { Array.from(e.target.files).forEach(file => { const reader = new FileReader(); reader.onload = (event) => { currentAttachments.push({ name: file.name, data: event.target.result }); renderAttachmentsList(); }; reader.readAsDataURL(file); }); e.target.value = ''; });
            attachmentsList.addEventListener('click', (e) => { if (e.target.classList.contains('remove-attachment-btn')) { currentAttachments.splice(e.target.dataset.index, 1); renderAttachmentsList(); } });

            function renderReportPreview(data) { const d = new Date(data.visitDate).toLocaleDateString('ar-OM'); let html = `<h2 class="text-2xl font-bold mb-4 text-center">تقرير زيارة إشرافية</h2><div class="grid grid-cols-2 gap-4 mb-6 border-b pb-4"><p><strong>المدرسة:</strong> ${data.schoolName}</p><p><strong>التاريخ:</strong> ${d}</p><p><strong>النوع:</strong> ${data.visitTypeName}</p></div>`; html += `<div id="reportObjectives"><div class="flex justify-between items-center mt-6 mb-3"><h3 class="text-xl font-semibold">الأهداف:</h3><button data-target="reportObjectives" class="copy-section-btn text-xs no-print">نسخ</button></div><ol class="list-decimal list-inside space-y-2">${data.checkedObjectives.map(o => `<li>${o}</li>`).join('')}</ol></div>`; html += `<div id="reportOpinions"><div class="flex justify-between items-center mt-6 mb-3"><h3 class="text-xl font-semibold">الرأي:</h3><button data-target="reportOpinions" class="copy-section-btn text-xs no-print">نسخ</button></div><ol class="list-decimal list-inside space-y-2">${(data.opinions || []).sort((a, b) => a.index - b.index).map(o => `<li class="text-gray-700">${o.text.replace(/\n/g, '<br>')}</li>`).join('')}</ol></div>`; if (data.recommendations) html += `<div id="reportRecommendations"><div class="flex justify-between items-center mt-6 mb-3"><h3 class="text-xl font-semibold">التوصيات:</h3><button data-target="reportRecommendations" class="copy-section-btn text-xs no-print">نسخ</button></div><p class="text-gray-700">${data.recommendations.replace(/\n/g, '<br>')}</p></div>`; schoolApp.querySelector('#reportContent').innerHTML = html; }
            function copyToClipboard(text, button) { const ta = document.createElement("textarea"); ta.value = text; ta.style.position = "fixed"; ta.style.opacity = 0; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); const original = button.textContent; button.textContent = 'تم النسخ!'; setTimeout(() => { button.textContent = original; }, 2000); } catch (err) { console.error('Copy failed', err); } document.body.removeChild(ta); }
            copyAllBtn.addEventListener('click', (e) => { let text = ""; ['reportObjectives', 'reportOpinions', 'reportRecommendations'].forEach(id => { const el = schoolApp.querySelector(`#${id}`); if (el) { text += el.querySelector('h3').innerText + "\n"; if (id === 'reportRecommendations') text += el.querySelector('p').innerText.trim() + "\n\n"; else el.querySelectorAll('li').forEach((li, i) => text += `${i + 1}- ${li.textContent.trim()}\n`); text += "\n"; } }); copyToClipboard(text.trim(), e.target); });
            reportPreviewContainer.addEventListener('click', (e) => { if (e.target.classList.contains('copy-section-btn')) { const target = schoolApp.querySelector(`#${e.target.dataset.target}`); if (!target) return; let text = ""; if (e.target.dataset.target === 'reportRecommendations') text = target.querySelector('p').innerText.trim(); else target.querySelectorAll('li').forEach((li, i) => text += `${i + 1}- ${li.textContent.trim()}\n`); copyToClipboard(text.trim(), e.target); } });
            
            addNewReportBtn.addEventListener('click', () => showFormView());
            backToDashboardBtn.addEventListener('click', showDashboardView);
            
            reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const reportId = reportIdInput.value;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // --- FIX 2: Removed `attachments` from the data object. ---
                // Saving file data directly to Firestore is not recommended due to the 1MB document size limit.
                // The UI correctly states that attachments are only saved locally in the browser for the current session.
                const data = { 
                    schoolName: schoolNameSelect.value, 
                    visitDate: new Date(schoolFormView.querySelector('#visitDate').value).getTime(), 
                    visitTypeKey: currentVisitTypeKey, 
                    visitTypeName: visitTypesData[currentVisitTypeKey].name, 
                    checkedObjectives: Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => cb.dataset.genderedValue), 
                    opinions: Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => ({ index: cb.dataset.index, text: schoolApp.querySelector(`#opinion-${cb.dataset.index}`).value })), 
                    recommendations: recommendationsTextarea.value, 
                    updatedAt: serverTimestamp() 
                };
                
                try { 
                    const reportsCollectionRef = collection(db, "artifacts", appId, "users", userId, "userReports");
                    if (reportId) {
                        await updateDoc(doc(reportsCollectionRef, reportId), data);
                    } else {
                        await addDoc(reportsCollectionRef, data);
                    }
                    showDashboardView(); 
                } catch (err) { 
                    console.error("Error saving report:", err); 
                    alert("خطأ في حفظ التقرير. قد يكون حجم البيانات كبيراً جداً."); 
                }
            });
            
            prepareReportBtn.addEventListener('click', () => { if (!reportForm.checkValidity()) { reportForm.reportValidity(); return; } previewSource = 'form'; showPreviewView({ schoolName: schoolNameSelect.value, visitDate: new Date(schoolFormView.querySelector('#visitDate').value), visitTypeName: visitTypesData[currentVisitTypeKey].name, checkedObjectives: Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => cb.dataset.genderedValue), opinions: Array.from(objectivesContainer.querySelectorAll('input:checked')).map(cb => ({ index: cb.dataset.index, text: schoolApp.querySelector(`#opinion-${cb.dataset.index}`).value })), recommendations: recommendationsTextarea.value }); });
            backToBtn.addEventListener('click', () => { if (previewSource === 'dashboard') showDashboardView(); else showFormView(savedReports.find(r => r.id === reportIdInput.value) || null); });
            
            reportsListContainer.addEventListener('click', async (e) => {
                const id = e.target.dataset.id; if (!id) return;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const report = savedReports.find(r => r.id === id);
                if (e.target.classList.contains('view-btn')) { previewSource = 'dashboard'; showPreviewView(report); } 
                else if (e.target.classList.contains('edit-btn')) { showFormView(report); } 
                else if (e.target.classList.contains('delete-btn')) { showConfirmationModal(`هل أنت متأكد من حذف تقرير "${report.schoolName}"؟`, async () => { try { await deleteDoc(doc(db, "artifacts", appId, "users", userId, "userReports", id)); renderDashboard(); } catch (err) { alert("خطأ في الحذف."); } }); }
            });
            
            schoolNameSelect.addEventListener('change', renderObjectivesForCurrentType);
            visitTypeSelect.addEventListener('change', (e) => { currentVisitTypeKey = e.target.value; renderObjectivesForCurrentType(); });
            objectivesContainer.addEventListener('change', () => { updateOpinionsSection(); updateSelectAllButtonState(); });
            selectAllObjectivesBtn.addEventListener('click', () => { const all = objectivesContainer.querySelectorAll('input'); if(all.length === 0) return; const allSelected = Array.from(all).every(cb => cb.checked); all.forEach(cb => cb.checked = !allSelected); updateOpinionsSection(); updateSelectAllButtonState(); });
            opinionsContainer.addEventListener('click', (e) => { if (e.target.matches('button[data-opinion]')) { const ta = schoolApp.querySelector(`#opinion-${e.target.dataset.index}`); ta.value = (e.target.dataset.opinion === 'completed') ? visitTypesData[currentVisitTypeKey].completedOpinions[e.target.dataset.index] : visitTypesData[currentVisitTypeKey].incompleteOpinions[e.target.dataset.index]; } });
            generateRecsBtn.addEventListener('click', () => { if (objectivesContainer.querySelectorAll('input:checked').length === 0) { alert("حدد هدفًا."); return; } const recs = []; objectivesContainer.querySelectorAll('input:checked').forEach(cb => { const index = cb.dataset.index; if (schoolApp.querySelector(`#opinion-${index}`).value.trim() === visitTypesData[currentVisitTypeKey].incompleteOpinions[index].trim()) recs.push(visitTypesData[currentVisitTypeKey].recommendations[index]); }); recommendationsTextarea.value = (recs.length > 0) ? "نوصي بالآتي:\n- " + recs.join('\n- ') + "\n\nوالله الموفق." : "سير العمل ممتاز."; });

            manageVisitTypesBtn.addEventListener('click', () => { renderManagerModal(); manageTypesModal.classList.remove('hidden'); });
            closeManageModalBtn.addEventListener('click', () => manageTypesModal.classList.add('hidden'));
            addNewTypeBtn.addEventListener('click', () => { editTypeKeyInput.value = ''; addEditModalTitle.textContent = 'إضافة نوع'; addEditTypeForm.reset(); addEditTypeModal.classList.remove('hidden'); });
            visitTypesList.addEventListener('click', (e) => { const key = e.target.dataset.key; if (!key) return; const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; if (e.target.classList.contains('edit-btn')) { editTypeKeyInput.value = key; addEditModalTitle.textContent = 'تعديل نوع'; typeNameInput.value = visitTypesData[key].name; typeObjectivesTextarea.value = visitTypesData[key].objectives_list.join('\n'); addEditTypeModal.classList.remove('hidden'); } if (e.target.classList.contains('delete-btn')) { if (Object.keys(visitTypesData).length <= 1) { alert("يجب وجود نوع واحد."); return; } showConfirmationModal(`هل تريد حذف "${visitTypesData[key].name}"؟`, async () => { await deleteDoc(doc(db, "artifacts", appId, "users", userId, "userVisitTypes", key)); }); } });
            cancelEditBtn.addEventListener('click', () => addEditTypeModal.classList.add('hidden'));
            addEditTypeForm.addEventListener('submit', async (e) => { e.preventDefault(); const key = editTypeKeyInput.value; const name = typeNameInput.value.trim(); const objectives = typeObjectivesTextarea.value.trim().split('\n').filter(Boolean); if (!name || objectives.length === 0) { alert("أدخل اسمًا وهدفًا."); return; } const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const data = { name, objectives_list: objectives, completedOpinions: objectives.map(o => `تم ${o} بنجاح.`), incompleteOpinions: objectives.map(o => `ملاحظات حول ${o}`), recommendations: objectives.map(o => `متابعة ${o}.`) }; const visitTypesCollectionRef = collection(db, "artifacts", appId, "users", userId, "userVisitTypes"); if (key) await updateDoc(doc(visitTypesCollectionRef, key), data); else currentVisitTypeKey = (await addDoc(visitTypesCollectionRef, data)).id; addEditTypeModal.classList.add('hidden'); });
            function renderManagerModal() { visitTypesList.innerHTML = ''; Object.keys(visitTypesData).forEach(key => visitTypesList.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg"><span class="font-medium">${visitTypesData[key].name}</span><div class="flex gap-2"><button data-key="${key}" class="edit-btn text-sm text-blue-600">تعديل</button><button data-key="${key}" class="delete-btn text-sm text-red-600">حذف</button></div></div>`); }
            function updateSelectAllButtonState() { const all = objectivesContainer.querySelectorAll('input'); selectAllObjectivesBtn.textContent = (all.length > 0 && Array.from(all).every(cb => cb.checked)) ? 'إلغاء الكل' : 'اختيار الكل'; }
        }

        // --- GLOBAL INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeSupervisoryApp();
            initializeSchoolApp();
            showView(welcomeView); // Start with the welcome view
        });

    </script>
</body>
</html>

