<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Ø®Ø·Ø© Ø³ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: ØªØ¹Ø±ÙŠÙ Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <style>
        /* Ø£Ù†Ù…Ø§Ø· Ù…Ø®ØµØµØ© */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            @page { size: A4; margin: 10mm; }
            body, html, #root { width: 100%; margin: 0; padding: 0; background-color: white !important; }
            body * { visibility: hidden; }
            .printable-content, .printable-content * { visibility: visible; }
            .printable-content { position: absolute; left: 0; top: 0; width: 100%; direction: rtl; }
            .no-print { display: none !important; }
            .only-print { display: block !important; visibility: visible !important; }
            table { width: 100% !important; border-collapse: collapse; font-size: 12px; direction: rtl; }
            th, td { border: 1px solid #000 !important; padding: 6px; text-align: right; color: black !important; }
            thead th { background-color: #f0f0f0 !important; font-weight: bold; -webkit-print-color-adjust: exact; }
            input { border: none !important; background: transparent !important; width: 100%; color: black !important; font-family: inherit; font-size: 12px; }
            .shadow-sm, .shadow-md, .shadow-lg { box-shadow: none !important; }
            .border-gray-200 { border-color: #000 !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ÙƒÙˆØ¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAnalytics } from 'firebase/analytics';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken
        } from 'firebase/auth';
        import { 
            getFirestore,
            initializeFirestore, 
            collection, 
            doc, 
            setDoc, 
            onSnapshot, 
            query, 
            serverTimestamp,
            updateDoc,
            deleteField,
            getDoc
        } from 'firebase/firestore';
        import { 
            Calendar, FileSpreadsheet, User, Lock, Unlock, Save, LogOut, CheckCircle, 
            Users, ChevronRight, ChevronLeft, Search, AlertCircle, AlertTriangle, 
            CalendarDays, Trash2, Plus, Edit, X, RefreshCw, Copyright, FileDown, 
            History, Download, KeyRound, Settings 
        } from 'lucide-react';

        // -----------------------------------------------------------
        // âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ (ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAUknGaMIWzeYLWlp-EUZtFzshNaewjwDc",
            authDomain: "supervisor-plan.firebaseapp.com",
            projectId: "supervisor-plan",
            storageBucket: "supervisor-plan.firebasestorage.app",
            messagingSenderId: "584751936902",
            appId: "1:584751936902:web:ab89e36c7f173e9a1c2807",
            measurementId: "G-9YSYCNSNCD"
        };
        // -----------------------------------------------------------

        let app, auth, db, analytics;
        let firebaseError = null;

        try {
            // 1. Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© (ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)
            if (typeof __firebase_config !== 'undefined') {
                const config = JSON.parse(__firebase_config);
                app = initializeApp(config);
                auth = getAuth(app);
                db = initializeFirestore(app, { experimentalForceLongPolling: true });
            } 
            // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±)
            else if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = initializeFirestore(app, { experimentalForceLongPolling: true });
                analytics = getAnalytics(app); // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
            } 
            // 3. Ø®Ø·Ø£: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            else {
                firebaseError = "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù…ÙÙ‚ÙˆØ¯Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
            firebaseError = "Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'supervisor-plan-v1'; // Ù…Ø¹Ø±Ù Ø«Ø§Ø¨Øª Ù„Ù„ØªØ·Ø¨ÙŠÙ‚

        // --- Ø§Ù„Ø«ÙˆØ§Ø¨Øª ---
        const COLLECTIONS = { PLANS: 'supervisor_plans', CONFIG: 'app_config' };
        
        // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ØªÙ‡ÙŠØ¦Ø©
        const INITIAL_SUPERVISORS = [
            { id: '1', name: 'ØµØ¨Ø§Ø­ Ø§Ù„Ù…Ù‚Ø¨Ø§Ù„ÙŠ', password: '1234' },
            { id: '2', name: 'Ù…Ø§Ø¬Ø¯ Ø§Ù„Ø£Ø®Ø²Ù…ÙŠ', password: '1234' },
            { id: '3', name: 'Ù†Ø§ØµØ± Ø§Ù„Ø±Ø²ÙŠÙ‚ÙŠ', password: '1234' },
            { id: '4', name: 'Ù‡Ø´Ø§Ù… Ø§Ù„Ø¹Ø¯ÙˆØ§Ù†ÙŠ', password: '1234' },
            { id: '5', name: 'Ù†Ø§ØµØ± Ø§Ù„Ù†Ø§Ø¹Ø¨ÙŠ', password: '1234' },
            { id: '6', name: 'Ø£Ø³Ø¹Ø¯ Ø§Ù„Ø®ØµÙŠØ¨ÙŠ', password: '1234' },
            { id: '7', name: 'Ù‡Ù†Ø¯ Ø§Ù„Ù‡Ù†Ø§Ø¦ÙŠØ©', password: '1234' },
            { id: '8', name: 'ÙŠØ³Ø±Ù‰ Ø§Ù„Ø°Ø®Ø±ÙŠØ©', password: '1234' },
            { id: '9', name: 'Ø±Ø¤Ù‰ Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙŠØ©', password: '1234' },
            { id: '10', name: 'Ø£Ù…Ù„ Ø§Ù„Ù†Ø¹Ù…Ø§Ù†ÙŠØ©', password: '1234' },
            { id: '11', name: 'Ø±ÙŠØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠÙ‚ÙŠØ©', password: '1234' },
            { id: '12', name: 'Ø¹Ø§Ø¦Ø´Ø© Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠØ©', password: '1234' },
            { id: '13', name: 'Ù…Ù‡Ø±Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠØ©', password: '1234' },
            { id: '14', name: 'Ø±Ù‚ÙŠØ© Ø§Ù„Ø¹Ù…ÙŠØ±ÙŠØ©', password: '1234' },
            { id: '15', name: 'Ø¢Ø³ÙŠØ© Ø§Ù„ÙƒÙ†Ø¯ÙŠØ©', password: '1234' }
        ];

        // --- Ù…ÙƒÙˆÙ† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø·Ø£ ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError() { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="flex h-screen items-center justify-center text-red-600 font-bold">Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.</div>;
                return this.props.children;
            }
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        const getDaysInMonth = (year, month) => {
            const date = new Date(year, month, 1);
            const days = [];
            while (date.getMonth() === month) { days.push(new Date(date)); date.setDate(date.getDate() + 1); }
            return days;
        };
        const getWorkingDaysInMonth = (year, month) => getDaysInMonth(year, month).filter(d => d.getDay() !== 5 && d.getDay() !== 6);
        const getMandatoryKey = (y, m, d) => `${y}_${m}_${d}`;

        // --- Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (Ù†Ø³Ø®Ø© Ø·Ø¨Ù‚ Ø§Ù„Ø£ØµÙ„ Ù…Ù† App.jsx) ---

        function PrintHeader({ supervisorData, month, year }) {
            return (
                <div className="hidden only-print mb-8 font-serif text-black w-full">
                <div className="flex justify-between items-start border-b-2 border-black pb-4 mb-6">
                    <div className="text-center w-1/3"><p>Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†</p><p>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…</p></div>
                    <div className="text-center w-1/3"><h1 className="text-xl font-bold border-2 border-black px-4 py-2 rounded">Ø®Ø·Ø© Ø³ÙŠØ± Ø§Ù„Ù…Ø´Ø±Ù</h1></div>
                    <div className="text-center w-1/3"><div className="border border-black p-2 text-sm">{year}/{year+1}</div></div>
                </div>
                <div className="flex justify-between border border-black p-2 mb-4">
                    <div>Ø§Ù„Ø§Ø³Ù…: {supervisorData.name}</div><div>Ø§Ù„Ø´Ù‡Ø±: {month+1}</div>
                </div>
                </div>
            );
        }

        function PrintSignatureSection() {
            return <div className="hidden only-print mt-10 pt-10 border-t border-black flex justify-between"><div>Ø§Ù„Ù…Ø´Ø±Ù</div><div>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div><div>Ø§Ù„Ù…Ø¯ÙŠØ±</div></div>;
        }

        function AppFooter({ lightMode = false }) {
            return (
                <div className={`text-center py-6 mt-4 text-xs no-print ${lightMode ? 'text-emerald-100 opacity-90' : 'text-gray-400'}`}>
                <div className="flex items-center justify-center gap-1 mb-1 font-bold">
                    <span>Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØµÙ…ÙŠÙ…: Ø£. Ø£Ø³Ø¹Ø¯ Ø§Ù„Ø®ØµÙŠØ¨ÙŠ</span>
                </div>
                <p>Ù…Ø´Ø±Ù Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</p>
                </div>
            );
        }

        function ChangePasswordModal({ isOpen, onClose, onSave, title }) {
            const [currentPass, setCurrentPass] = useState('');
            const [newPass, setNewPass] = useState('');
            const [confirmPass, setConfirmPass] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            if (!isOpen) return null;

            const handleSubmit = async () => {
                setError('');
                if (!currentPass || !newPass || !confirmPass) return setError('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©');
                if (newPass !== confirmPass) return setError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
                if (newPass.length < 4) return setError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');

                setLoading(true);
                try {
                await onSave(currentPass, newPass);
                onClose();
                alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
                } catch (e) {
                setError(e.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØºÙŠÙŠØ±');
                } finally {
                setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
                    <div className="bg-gray-800 text-white p-4 flex justify-between items-center">
                    <h3 className="font-bold flex items-center gap-2"><KeyRound size={20}/> {title || 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'}</h3>
                    <button onClick={onClose}><X size={20}/></button>
                    </div>
                    <div className="p-6 space-y-4">
                    {error && <div className="bg-red-50 text-red-600 p-3 rounded text-sm text-center">{error}</div>}
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                        <input type="password" value={currentPass} onChange={e=>setCurrentPass(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                        <input type="password" value={newPass} onChange={e=>setNewPass(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                        <input type="password" value={confirmPass} onChange={e=>setConfirmPass(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                    </div>

                    <div className="flex justify-end gap-3 mt-6">
                        <button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                        <button onClick={handleSubmit} disabled={loading} className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50">
                        {loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'}
                        </button>
                    </div>
                    </div>
                </div>
                </div>
            );
        }

        function LoginScreen({ onLogin, user }) { // Receive user prop
            const [name, setName] = useState('');
            const [jobId, setJobId] = useState('');
            const [password, setPassword] = useState('');
            const [adminCode, setAdminCode] = useState('');
            const [mode, setMode] = useState('supervisor'); 
            const [msg, setMsg] = useState('');
            const [supervisorsList, setSupervisorsList] = useState([]);
            const [isLoadingData, setIsLoadingData] = useState(true);

            useEffect(() => {
                if (!db || !user) return; // Guard against missing auth
                const checkAndInitData = async () => {
                    try {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'supervisors');
                        const docSnap = await getDoc(docRef);
                        if (!docSnap.exists()) await setDoc(docRef, { list: INITIAL_SUPERVISORS });
                    } catch (e) { console.error(e); }
                };
                checkAndInitData();
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'supervisors'), (doc) => {
                    if (doc.exists() && doc.data().list) setSupervisorsList(doc.data().list);
                    else setSupervisorsList(INITIAL_SUPERVISORS);
                    setIsLoadingData(false);
                });
                return () => unsub();
            }, [user]); // Add user to dependencies

            const handleSupervisorChange = (e) => {
                const selectedName = e.target.value;
                setName(selectedName);
                const supervisor = supervisorsList.find(s => s.name === selectedName);
                if (supervisor) setJobId(supervisor.id); else setJobId('');
            };

            const handleSupervisorLogin = () => {
                if (!name || !jobId) return setMsg('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù');
                if (!password) return setMsg('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                const supervisor = supervisorsList.find(s => s.id === jobId);
                if (supervisor && supervisor.password === password) onLogin('supervisor', { name, jobId });
                else setMsg('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            };

            const handleAdminLogin = async () => {
                if (!adminCode) return setMsg('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²');
                try {
                    const settingsSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'settings'));
                    const realAdminPass = settingsSnap.exists() && settingsSnap.data().adminPassword ? settingsSnap.data().adminPassword : '1234';
                    if (adminCode === realAdminPass) onLogin('admin');
                    else setMsg('âš ï¸ Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­');
                } catch (e) {
                    if (adminCode === '1234') onLogin('admin'); else setMsg('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                }
            };

            if (isLoadingData) return <div className="h-screen flex justify-center items-center text-emerald-600 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>;

            return (
                <div className="min-h-screen bg-emerald-600 flex flex-col items-center justify-center p-4" dir="rtl">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
                    <div className="text-center mb-6">
                    <div className="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Calendar className="w-8 h-8 text-emerald-600" /></div>
                    <h1 className="text-2xl font-bold text-gray-800">Ø®Ø·Ø© Ø³ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</h1>
                    </div>
                    <div className="flex bg-gray-100 p-1 rounded-lg mb-6">
                    <button className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${mode==='supervisor'?'bg-white shadow text-emerald-600':'text-gray-500'}`} onClick={() => {setMode('supervisor'); setMsg('')}}>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</button>
                    <button className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${mode==='admin'?'bg-white shadow text-emerald-600':'text-gray-500'}`} onClick={() => {setMode('admin'); setMsg('')}}>Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                    </div>
                    {msg && <div className="mb-4 text-center text-sm text-red-500 bg-red-50 p-2 rounded animate-pulse">{msg}</div>}
                    
                    {mode === 'supervisor' ? (
                    <div className="space-y-4">
                        <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù *</label>
                        <select value={name} onChange={handleSupervisorChange} className="w-full px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-emerald-500 outline-none">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù… --</option>
                            {supervisorsList.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                        </select>
                        </div>
                        <div className="flex gap-2">
                            <div className="w-1/3">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø±Ù‚Ù…</label>
                                <input type="text" value={jobId} readOnly className="w-full px-4 py-2 border rounded-lg bg-gray-100 text-gray-500 text-center" />
                            </div>
                            <div className="w-2/3">
                                <label className="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
                                <div className="relative">
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="****" />
                                    <KeyRound className="absolute left-3 top-2.5 text-gray-400 w-4 h-4" />
                                </div>
                            </div>
                        </div>
                        <button onClick={handleSupervisorLogin} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition shadow-lg">Ø¯Ø®ÙˆÙ„</button>
                    </div>
                    ) : (
                    <div className="space-y-4">
                        <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Ø±Ù…Ø² Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                        <input type="password" value={adminCode} onChange={e=>setAdminCode(e.target.value)} className="w-full px-4 py-2 border rounded-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²" />
                        </div>
                        <button onClick={handleAdminLogin} className="w-full bg-gray-800 text-white font-bold py-3 rounded-lg shadow-lg">Ø¯Ø®ÙˆÙ„</button>
                    </div>
                    )}
                </div>
                <AppFooter lightMode={true} />
                </div>
            );
        }

        function SupervisorDashboard({ user, supervisorData, onLogout }) {
            const [settings, setSettings] = useState({ isOpen: false });
            const [mandatoryEvents, setMandatoryEvents] = useState({});
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
            const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
            const [planData, setPlanData] = useState({});
            const [historyVisits, setHistoryVisits] = useState({}); 
            const [isSaving, setIsSaving] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [showPasswordModal, setShowPasswordModal] = useState(false);

            useEffect(() => {
                if (!db || !user) return; // Guard
                const unsub1 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'settings'), s=>s.exists()&&setSettings(s.data()));
                const unsub2 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'mandatory_events'), s=>s.exists()&&setMandatoryEvents(s.data()));
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.PLANS));
                const unsub3 = onSnapshot(q, (snapshot) => {
                    const history = {};
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        if (data.supervisorId === supervisorData.jobId && (data.month !== currentMonth || data.year !== currentYear)) {
                            if (data.visits) {
                                Object.entries(data.visits).forEach(([key, task]) => {
                                    if (!history[key]) history[key] = [];
                                    history[key].push({ task, month: data.month, year: data.year });
                                });
                            }
                        }
                    });
                    setHistoryVisits(history);
                });
                return () => { unsub1(); unsub2(); unsub3(); };
            }, [supervisorData.jobId, currentMonth, currentYear, user]); 

            useEffect(() => {
                if (!user || !db) return; // Guard
                const planId = `${supervisorData.jobId}_${currentYear}_${currentMonth}`;
                return onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.PLANS, `plan_${planId}`), s => {
                    setPlanData(s.exists() ? s.data().visits || {} : {});
                });
            }, [supervisorData.jobId, currentMonth, currentYear, user]);

            const workingDays = useMemo(() => getWorkingDaysInMonth(currentYear, currentMonth), [currentYear, currentMonth]);

            const handleInputChange = (key, value) => {
                if (!settings.isOpen) return;
                setPlanData(prev => ({ ...prev, [key]: value }));
            };

            const handlePrint = () => {
                const originalTitle = document.title;
                document.title = `Ø®Ø·Ø©_${supervisorData.name}_${currentMonth+1}`;
                window.focus(); setTimeout(() => { window.print(); setTimeout(() => document.title = originalTitle, 1000); }, 100);
            };

            const savePlan = async () => {
                if (!settings.isOpen || !db) return;
                setIsSaving(true);
                try {
                    const planId = `${supervisorData.jobId}_${currentYear}_${currentMonth}`;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.PLANS, `plan_${planId}`), {
                        supervisorName: supervisorData.name, 
                        supervisorId: supervisorData.jobId,
                        userId: user.uid,
                        month: currentMonth, 
                        year: currentYear, 
                        visits: planData, 
                        updatedAt: serverTimestamp()
                    });
                    setStatusMsg('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸'); setTimeout(() => setStatusMsg(''), 3000);
                } catch { setStatusMsg('âŒ Ø®Ø·Ø£'); } finally { setIsSaving(false); }
            };

            const handleChangePassword = async (currentPass, newPass) => {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'supervisors');
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                const currentList = docSnap.data().list;
                const supervisorIndex = currentList.findIndex(s => s.id === supervisorData.jobId);
                if (supervisorIndex === -1) throw new Error('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                if (currentList[supervisorIndex].password !== currentPass) throw new Error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                const newList = [...currentList];
                newList[supervisorIndex].password = newPass;
                await updateDoc(docRef, { list: newList });
            };

            return (
                <div className="bg-gray-50 min-h-screen flex flex-col" dir="rtl">
                <ChangePasswordModal isOpen={showPasswordModal} onClose={() => setShowPasswordModal(false)} onSave={handleChangePassword} />
                <header className="bg-emerald-600 text-white p-4 shadow-md sticky top-0 z-10 no-print flex justify-between items-center">
                    <div><h2 className="font-bold">Ø®Ø·Ø© Ø³ÙŠØ± Ø§Ù„Ù…Ø´Ø±Ù</h2><p className="text-xs">{supervisorData.name} ({supervisorData.jobId})</p></div>
                    <div className="flex gap-2">
                    <button onClick={() => setShowPasswordModal(true)} className="bg-emerald-800/50 hover:bg-emerald-800 p-2 rounded-full transition" title="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><KeyRound size={18} /></button>
                    <button onClick={handlePrint} className="bg-white/20 p-2 rounded-full hover:bg-white/30"><FileDown size={18} /></button>
                    <button onClick={onLogout} className="bg-emerald-700 p-2 rounded-full hover:bg-emerald-800"><LogOut size={18} /></button>
                    </div>
                </header>
                <div className={`p-2 text-center text-xs font-bold no-print ${settings.isOpen ? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{settings.isOpen ? 'ğŸŸ¢ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ§Ø­' : 'ğŸ”´ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ØºÙ„Ù‚'}</div>
                <div className="max-w-4xl mx-auto p-4 space-y-4 flex-grow w-full printable-content">
                    <PrintHeader supervisorData={supervisorData} month={currentMonth} year={currentYear} /> 
                    <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm no-print">
                    <button onClick={()=>{if(currentMonth===0){setCurrentMonth(11);setCurrentYear(currentYear-1)}else setCurrentMonth(currentMonth-1)}} className="p-2 bg-gray-100 rounded-full"><ChevronRight/></button>
                    <span className="font-bold">{new Date(currentYear, currentMonth).toLocaleDateString('ar-EG',{month:'long',year:'numeric'})}</span>
                    <button onClick={()=>{if(currentMonth===11){setCurrentMonth(0);setCurrentYear(currentYear+1)}else setCurrentMonth(currentMonth+1)}} className="p-2 bg-gray-100 rounded-full"><ChevronLeft/></button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                    <table className="w-full text-right">
                        <thead className="bg-gray-50 border-b"><tr><th className="p-4 w-32">Ø§Ù„ÙŠÙˆÙ…</th><th className="p-4">Ø§Ù„Ù…Ù‡Ù…Ø©</th></tr></thead>
                        <tbody className="divide-y">
                        {workingDays.map(date => {
                            const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
                            const dayNum = date.getDate();
                            const key = `d_${dayNum}`;
                            const mandKey = getMandatoryKey(currentYear, currentMonth, dayNum);
                            const mandEvt = mandatoryEvents[mandKey];
                            const currentVal = planData[key] || '';
                            let conflict = null;
                            if (currentVal.trim().length > 2 && historyVisits[key]) conflict = historyVisits[key].find(h => h.task.trim() === currentVal.trim());
                            return (
                            <tr key={key} className={mandEvt ? 'bg-orange-50' : 'bg-white'}>
                                <td className="p-4 border-l"><div className="font-bold">{dayName}</div><div className="text-xs text-gray-400">{dayNum}</div></td>
                                <td className="p-2 relative">
                                {mandEvt ? (<div className="flex items-center gap-2 text-orange-700 font-bold px-2"><Lock size={16} className="no-print"/>{mandEvt}</div>) : (
                                    <div className="relative">
                                        <input type="text" disabled={!settings.isOpen} value={currentVal} onChange={e=>handleInputChange(key, e.target.value)} placeholder={settings.isOpen?"...":""} className={`w-full p-2 border rounded outline-none focus:ring-2 focus:ring-emerald-500 bg-transparent ${conflict ? 'border-red-300 bg-red-50' : ''}`} />
                                        {conflict && (<div className="absolute top-full right-0 mt-1 z-10 bg-red-100 text-red-700 text-[10px] px-2 py-1 rounded shadow-sm border border-red-200 flex items-center gap-1 no-print animate-fade-in"><AlertCircle size={10} /><span>ØªÙƒØ±Ø§Ø±: Ø´Ù‡Ø± {conflict.month + 1}/{conflict.year}</span></div>)}
                                    </div>
                                )}
                                </td>
                            </tr>
                            );
                        })}
                        </tbody>
                    </table>
                    </div>
                    <PrintSignatureSection /> 
                </div>
                {settings.isOpen && (
                    <div className="fixed bottom-6 left-6 right-6 max-w-4xl mx-auto flex flex-col items-end gap-2 pointer-events-none no-print">
                    {statusMsg && <div className="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm mb-2">{statusMsg}</div>}
                    <button onClick={savePlan} disabled={isSaving} className="flex items-center gap-2 bg-emerald-600 text-white px-6 py-3 rounded-full shadow-lg pointer-events-auto">{isSaving ? '...' : <><Save size={20} /><span>Ø­ÙØ¸</span></>}</button>
                    </div>
                )}
                <AppFooter />
                </div>
            );
        }

        // --- Admin Dashboard ---
        function AdminDashboard({ user, onLogout }) {
            const [settings, setSettings] = useState({ isOpen: false });
            const [plans, setPlans] = useState([]);
            const [mandatoryEvents, setMandatoryEvents] = useState({});
            const [filterMonth, setFilterMonth] = useState(new Date().getMonth());
            const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
            const [editingPlan, setEditingPlan] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [newEventDay, setNewEventDay] = useState(1);
            const [newEventText, setNewEventText] = useState('');
            const [editingEventKey, setEditingEventKey] = useState(null);
            const [showPasswordModal, setShowPasswordModal] = useState(false);

            const daysInSelectedMonth = useMemo(() => {
                const days = getDaysInMonth(currentYear, filterMonth);
                return days.map(d => ({ num: d.getDate(), name: d.toLocaleDateString('ar-EG', { weekday: 'long' }), isWeekend: d.getDay() === 5 || d.getDay() === 6 }));
            }, [currentYear, filterMonth]);
            const yearsList = useMemo(() => { const current = new Date().getFullYear(); return Array.from({length: 11}, (_, i) => current - 1 + i); }, []);

            useEffect(() => {
                if (!db || !user) return; // Guard
                const unsub1 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'settings'), s=>s.exists()&&setSettings(s.data()));
                const unsub2 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'mandatory_events'), s=>s.exists()&&setMandatoryEvents(s.data()));
                const unsub3 = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.PLANS)), snap => {
                    const p = []; snap.forEach(d => { if(d.data().month === filterMonth) p.push(d.data()) }); setPlans(p);
                });
                return () => { unsub1(); unsub2(); unsub3(); };
            }, [filterMonth, user]);
                    
            const toggleSubmission = async () => setDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'settings'), { isOpen: !settings.isOpen }, { merge: true });
            const handleEventSubmit = async () => {
                if (!newEventText.trim()) return;
                const newKey = getMandatoryKey(currentYear, filterMonth, newEventDay);
                if(editingEventKey && editingEventKey !== newKey) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'mandatory_events'), { [editingEventKey]: deleteField() });
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'mandatory_events'), { [newKey]: newEventText }, { merge: true });
                setNewEventText(''); setNewEventDay(1); setEditingEventKey(null);
            };
            const deleteMandatoryEvent = async (k) => { if(confirm('Ø­Ø°ÙØŸ')) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'mandatory_events'), { [k]: deleteField() }); };
            const saveAdminEdit = async (editedVisits) => {
                if (!editingPlan) return;
                const planId = `${editingPlan.supervisorId}_${editingPlan.year}_${editingPlan.month}`;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.PLANS, `plan_${planId}`), { visits: editedVisits });
                setEditingPlan(null);
            };
            const handleChangeAdminPassword = async (currentPass, newPass) => {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTIONS.CONFIG, 'settings');
                const docSnap = await getDoc(docRef);
                const storedPass = docSnap.exists() && docSnap.data().adminPassword ? docSnap.data().adminPassword : '1234';
                if (currentPass !== storedPass) throw new Error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                await setDoc(docRef, { adminPassword: newPass }, { merge: true });
            };
            const downloadSinglePlan = (plan) => {
                const workingDaysInM = getWorkingDaysInMonth(currentYear, filterMonth);
                const dateStr = new Date(currentYear, filterMonth).toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
                let table = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40" dir="rtl"><head><meta charset="UTF-8"><style>table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; direction: rtl; } td, th { border: 1px solid #000000; text-align: center; vertical-align: middle; padding: 5px; font-size: 11pt; } .header-top { background-color: #92D050; font-weight: bold; font-size: 14pt; height: 40px; } .header-sub { background-color: #FFFF00; font-weight: bold; font-size: 12pt; } .data-row { background-color: #FFFFFF; } .gray-row { background-color: #F2F2F2; }</style></head><body><table><tr><td colspan="3" class="header-top">Ø®Ø·Ø© Ø³ÙŠØ± Ø§Ù„Ù…Ø´Ø±Ù: ${plan.supervisorName} - Ø§Ù„ÙØªØ±Ø©: ${dateStr}</td></tr><tr><td colspan="3" style="text-align:right; font-weight:bold; background-color:#f0f0f0;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ: ${plan.supervisorId}</td></tr><tr class="header-sub"><td style="width: 100px;">Ø§Ù„ÙŠÙˆÙ…</td><td style="width: 150px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</td><td style="width: 400px;">Ø§Ù„Ù…Ù‡Ù…Ø© / Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</td></tr>${workingDaysInM.map((d, index) => {
                    const dayNum = d.getDate(); const dayName = d.toLocaleDateString('ar-EG', { weekday: 'long' }); const key = 'd_' + dayNum; const mandKey = getMandatoryKey(currentYear, filterMonth, dayNum); const task = mandatoryEvents[mandKey] || plan.visits[key] || ''; const rowClass = index % 2 === 0 ? 'data-row' : 'gray-row'; return `<tr class="${rowClass}"><td>${dayName}</td><td>${dayNum}/${filterMonth + 1}</td><td>${task}</td></tr>`; }).join('')}</table></body></html>`;
                
                const blob = new Blob([table], { type: 'application/vnd.ms-excel;charset=utf-8' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Ø®Ø·Ø©_${plan.supervisorName}.xls`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };
            const exportToExcel = () => {
                if (plans.length === 0) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');
                const workingDaysInM = getWorkingDaysInMonth(currentYear, filterMonth);
                const dateStr = new Date(currentYear, filterMonth).toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
                let table = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40" dir="rtl"><head><meta charset="UTF-8"><style>table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; direction: rtl; } td, th { border: 1px solid #000000; text-align: center; vertical-align: middle; padding: 5px; font-size: 11pt; } .header-top { background-color: #92D050; font-weight: bold; font-size: 14pt; height: 40px; } .header-sub { background-color: #FFFF00; font-weight: bold; font-size: 12pt; } .data-row { background-color: #FFFFFF; } .gray-row { background-color: #F2F2F2; }</style></head><body><table><tr><td colspan="${workingDaysInM.length + 2}" class="header-top">Ø®Ø·Ø· Ø³ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† - Ø§Ù„ÙØªØ±Ø©: ${dateStr}</td></tr><tr class="header-sub"><td rowspan="2" style="width: 50px;">Ù…</td><td rowspan="2" style="width: 200px;">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù</td>${workingDaysInM.map(d => `<td>${d.toLocaleDateString('ar-EG', { weekday: 'long' })}</td>`).join('')}</tr><tr class="header-sub">${workingDaysInM.map(d => `<td>${d.getDate()}/${filterMonth + 1}</td>`).join('')}</tr>${plans.map((plan, index) => { const rowClass = index % 2 === 0 ? 'data-row' : 'gray-row'; return `<tr class="${rowClass}"><td>${index + 1}</td><td style="font-weight: bold;">${plan.supervisorName}</td>${workingDaysInM.map(d => { const dayNum = d.getDate(); const key = 'd_' + dayNum; const mandKey = getMandatoryKey(currentYear, filterMonth, dayNum); const task = mandatoryEvents[mandKey] || plan.visits[key] || ''; return `<td>${task}</td>`; }).join('')}</tr>`; }).join('')}</table></body></html>`;
                const blob = new Blob([table], { type: 'application/vnd.ms-excel;charset=utf-8' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `ØªÙ‚Ø±ÙŠØ±_${filterMonth+1}_${currentYear}.xls`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };
            const filteredPlans = plans.filter(p => { const s = searchTerm.toLowerCase(); return (p.supervisorName || '').toLowerCase().includes(s) || (p.supervisorId || '').toLowerCase().includes(s); });
            const currentMonthEvents = useMemo(() => Object.entries(mandatoryEvents).map(([k,t]) => { const [y, m, d] = k.split('_').map(Number); const eventDate = new Date(y, m, d); const dayName = eventDate.toLocaleDateString('ar-EG', { weekday: 'long' }); return {y,m,d,t,dayName,key:k}; }).filter(e => e.y === currentYear && e.m === filterMonth).sort((a,b)=>a.d-b.d), [mandatoryEvents, currentYear, filterMonth]);

            return (
                <div className="min-h-screen bg-gray-100 font-sans" dir="rtl">
                {editingPlan && <AdminPlanEditor plan={editingPlan} mandatoryEvents={mandatoryEvents} onClose={() => setEditingPlan(null)} onSave={saveAdminEdit} />}
                <ChangePasswordModal isOpen={showPasswordModal} onClose={() => setShowPasswordModal(false)} onSave={handleChangeAdminPassword} title="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" />
                <div className="bg-gray-900 text-white p-4 flex justify-between"><h1 className="font-bold flex gap-2 items-center"><Users/> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1><div className="flex gap-2"><button onClick={() => setShowPasswordModal(true)} className="flex items-center gap-1 text-gray-300 hover:text-white bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded transition"><KeyRound size={16} /> ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø²</button><button onClick={onLogout} className="flex items-center gap-2 text-gray-300 hover:text-white px-3 py-1 rounded transition"><span>Ø®Ø±ÙˆØ¬</span><LogOut size={18} /></button></div></div>
                <div className="max-w-7xl mx-auto p-6 space-y-6">
                    <div className="grid md:grid-cols-4 gap-4">
                    <div className="bg-white p-4 rounded shadow"><h3 className="font-bold text-sm mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</h3><div className="flex gap-2"><select value={filterMonth} onChange={e=>setFilterMonth(parseInt(e.target.value))} className="w-1/2 border p-2 rounded">{Array.from({length:12},(_,i)=><option key={i} value={i}>Ø´Ù‡Ø± {i+1}</option>)}</select><select value={currentYear} onChange={e=>setCurrentYear(parseInt(e.target.value))} className="w-1/2 border p-2 rounded">{yearsList.map(y => <option key={y} value={y}>{y}</option>)}</select></div></div>
                    <button onClick={toggleSubmission} className={`p-4 rounded font-bold shadow ${settings.isOpen?'bg-red-50 text-red-600':'bg-emerald-50 text-emerald-600'}`}>{settings.isOpen?'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„':'ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'}</button>
                    <div className="md:col-span-2 bg-orange-50 p-4 rounded shadow border border-orange-200">
                        <div className="flex gap-2"><select value={newEventDay} onChange={e=>setNewEventDay(parseInt(e.target.value))} className="p-2 rounded border w-32 text-xs">{daysInSelectedMonth.map(day => (<option key={day.num} value={day.num} className={day.isWeekend ? 'text-red-500' : ''}>{day.num} - {day.name} {day.isWeekend ? '(Ø¹Ø·Ù„Ø©)' : ''}</option>))}</select><input value={newEventText} onChange={e=>setNewEventText(e.target.value)} placeholder="Ø­Ø¯Ø« Ø¥Ù„Ø²Ø§Ù…ÙŠ..." className="flex-1 p-2 rounded border" /><button onClick={handleEventSubmit} className="bg-orange-600 text-white px-4 rounded hover:bg-orange-700">{editingEventKey?'ØªØ¹Ø¯ÙŠÙ„':'Ø¥Ø¶Ø§ÙØ©'}</button>{editingEventKey && <button onClick={()=>{setEditingEventKey(null);setNewEventText('');}} className="bg-gray-300 px-3 rounded">Ø¥Ù„ØºØ§Ø¡</button>}</div>
                        <div className="flex flex-wrap gap-2 mt-2">{currentMonthEvents.map(evt => (<div key={evt.key} className="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full flex gap-1 items-center border border-orange-200"><b>{evt.d} ({evt.dayName}):</b> {evt.t}<button onClick={()=>{setNewEventDay(evt.d);setNewEventText(evt.t);setEditingEventKey(evt.key)}}><Edit size={12}/></button><button onClick={()=>deleteMandatoryEvent(evt.key)}><Trash2 size={12}/></button></div>))}</div>
                    </div>
                    </div>
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 className="text-gray-500 text-sm font-bold mb-3">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©</h3><button onClick={exportToExcel} className="w-full py-2 rounded-lg font-bold flex items-center justify-center gap-2 bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100"><FileSpreadsheet size={18} /> ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø®Ø·Ø· Ø§Ù„Ø³ÙŠØ±  </button></div>
                    <div className="bg-white rounded shadow overflow-hidden">
                    <div className="p-4 border-b border-gray-200 bg-gray-50 flex flex-wrap gap-4 justify-between items-center"><div className="flex items-center gap-2"><CheckCircle className="text-emerald-500" size={20} /><h2 className="font-bold text-gray-700">Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ({filteredPlans.length})</h2></div><div className="relative w-full md:w-64"><Search className="absolute right-3 top-3 text-gray-400 w-4 h-4" /><input type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm" /></div></div>
                    <table className="w-full text-right"><thead className="bg-gray-100 text-sm"><tr><th className="p-4">Ø§Ù„Ø§Ø³Ù…</th><th className="p-4">Ø§Ù„Ø±Ù‚Ù…</th><th className="p-4">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody className="divide-y">{filteredPlans.map((plan, idx) => (<tr key={idx} className="hover:bg-gray-50"><td className="p-4 font-bold">{plan.supervisorName}</td><td className="p-4 text-gray-500">{plan.supervisorId}</td><td className="p-4 flex gap-2"><button onClick={()=>setEditingPlan(plan)} className="bg-blue-50 text-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-100"><Edit size={16}/> ØªØ¹Ø¯ÙŠÙ„</button><button onClick={() => downloadSinglePlan(plan)} className="bg-green-50 text-green-600 px-3 py-1 rounded text-sm hover:bg-green-100 flex items-center gap-1" title="ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©"><Download size={16}/> ØªÙ†Ø²ÙŠÙ„ (Excel Ù…Ù„ÙˆÙ†)</button></td></tr>))} {plans.length===0 && <tr><td colSpan="3" className="p-8 text-center text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø·</td></tr>}</tbody></table>
                    </div>
                </div>
                <AppFooter />
                </div>
            );
        }

        // --- Ø§Ù„Ù…ÙƒÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ¯ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ ---
        function App() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [supervisorData, setSupervisorData] = useState({ name: '', jobId: '' });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(firebaseError);

            useEffect(() => {
                if (error) { setLoading(false); return; }
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } catch (err) { setError("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„."); setLoading(false); }
                };
                initAuth();
                return onAuthStateChanged(auth, (u) => { if(u) { setUser(u); setLoading(false); } });
            }, [error]);

            const handleLogout = () => { setRole(null); setSupervisorData({name:'', jobId:''}); };

            if (error) return <div className="flex h-screen items-center justify-center text-red-600">{error}</div>;
            if (loading) return <div className="h-screen flex items-center justify-center text-emerald-600 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>;

            if (!role) return <LoginScreen onLogin={(r, d) => { setRole(r); if(d) setSupervisorData(d); }} user={user} />;
            if (role === 'admin') return <AdminDashboard user={user} onLogout={handleLogout} />;
            return <SupervisorDashboard user={user} supervisorData={supervisorData} onLogout={handleLogout} />;
        }

        // --- Ù…ÙƒÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø·Ø© (Admin) ---
        function AdminPlanEditor({ plan, mandatoryEvents, onClose, onSave }) {
            const [localVisits, setLocalVisits] = useState(plan.visits || {});
            const [isSaving, setIsSaving] = useState(false);
            const workingDays = useMemo(() => getWorkingDaysInMonth(plan.year, plan.month), [plan.year, plan.month]);
            const handleSave = async () => { setIsSaving(true); await onSave(localVisits); setIsSaving(false); };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"><div className="p-4 border-b flex justify-between bg-gray-50 rounded-t-2xl"><h3 className="font-bold">ØªØ¹Ø¯ÙŠÙ„: {plan.supervisorName}</h3><button onClick={onClose}><X size={20}/></button></div><div className="overflow-y-auto p-4 flex-1 bg-gray-50"><div className="space-y-2">{workingDays.map((date) => { const dayNum = date.getDate(); const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' }); const key = `d_${dayNum}`; const mandKey = getMandatoryKey(plan.year, plan.month, dayNum); return (<div key={key} className={`flex gap-2 p-2 rounded border items-center ${mandatoryEvents[mandKey] ? 'bg-orange-100' : 'bg-white'}`}><div className="w-24 text-center border-l pl-2 ml-2 border-gray-200"><div className="font-bold text-gray-800 text-sm">{dayName}</div><div className="text-xs text-gray-500">{dayNum} / {plan.month + 1}</div></div>{mandatoryEvents[mandKey] ? (<div className="flex-1 text-orange-800 flex items-center gap-2"><Lock size={14}/> {mandatoryEvents[mandKey]}</div>) : (<input className="flex-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" value={localVisits[key]||''} onChange={e=>setLocalVisits({...localVisits, [key]: e.target.value})} placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©..." />)}</div>); })}</div></div><div className="p-4 border-t flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded transition-colors">Ø¥Ù„ØºØ§Ø¡</button><button onClick={handleSave} disabled={isSaving} className="px-4 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 transition-colors flex items-center gap-2">{isSaving ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : <><Save size={18} /> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</>}</button></div></div></div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
